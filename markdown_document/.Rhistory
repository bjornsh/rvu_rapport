top_n(minsta_antal_resor) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Övriga områden")))
#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix[minsta_antal_resor, -1]- od_matrix[minsta_antal_resor+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix_tot <- od_matrix[minsta_antal_resor]
od_matrix_tot <- mutate(od_matrix_tot,start_tatort_namn="Totalt")
od_matrix <- rbind(od_matrix,od_matrix_övriga,od_matrix_tot)
od_matrix
od_matrix[1,]
od_matrix <- rvu %>%
select(start_tatort_namn, stop_tatort_namn) %>%
filter(!is.na(start_tatort_namn)) %>%
filter(!is.na(stop_tatort_namn)) %>%
group_by(start_tatort_namn, stop_tatort_namn) %>%
summarize(antal = n()) %>%
pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
ungroup() %>%
mutate("Totaltc" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>%
top_n(minsta_antal_resor) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Övriga områden")))
#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix[minsta_antal_resor, -1]- od_matrix[minsta_antal_resor+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix <- rbind(od_matrix[1:minsta_antal_resor-1,],od_matrix[minsta_antal_resor+1,],od_matrix[minsta_antal_resor,])
od_matrix <- rvu %>%
select(start_tatort_namn, stop_tatort_namn) %>%
filter(!is.na(start_tatort_namn)) %>%
filter(!is.na(stop_tatort_namn)) %>%
group_by(start_tatort_namn, stop_tatort_namn) %>%
summarize(antal = n()) %>%
pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
ungroup() %>%
mutate("Totaltc" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>%
top_n(minsta_antal_resor) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Övriga områden")))
#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix[minsta_antal_resor, -1]- od_matrix[minsta_antal_resor+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix <- rvu %>%
select(start_tatort_namn, stop_tatort_namn) %>%
filter(!is.na(start_tatort_namn)) %>%
filter(!is.na(stop_tatort_namn)) %>%
group_by(start_tatort_namn, stop_tatort_namn) %>%
summarize(antal = n()) %>%
pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
ungroup() %>%
mutate("Totaltc" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>%
top_n(minsta_antal_resor) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Övriga områden")))
#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix[minsta_antal_resor, -1]- od_matrix[minsta_antal_resor+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix <- rbind(od_matrix[1:minsta_antal_resor-1,],od_matrix_övriga,od_matrix[minsta_antal_resor,])
lista_med_tätorter <- pull(od_matrix,start_tatort_namn)
od_matrix <- od_matrix %>%
select(start_tatort_namn,lista_med_tätorter[1:9],Totaltc) %>%
rename("Från tärort" = start_tatort_namn) %>%
mutate("Övriga områden" = -rowSums(select_if(., is.numeric), na.rm = TRUE)+2*Totaltc)
lista_med_tätorter <- pull(od_matrix,start_tatort_namn)
minsta_antal_resor <- 10
od_matrix <- rvu %>%
select(start_tatort_namn, stop_tatort_namn) %>%
filter(!is.na(start_tatort_namn)) %>%
filter(!is.na(stop_tatort_namn)) %>%
group_by(start_tatort_namn, stop_tatort_namn) %>%
summarize(antal = n()) %>%
pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
ungroup() %>%
mutate("Totaltc" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>%
top_n(minsta_antal_resor) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Övriga områden")))
#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix[minsta_antal_resor, -1]- od_matrix[minsta_antal_resor+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix <- rbind(od_matrix[1:minsta_antal_resor-1,],od_matrix_övriga,od_matrix[minsta_antal_resor,])
#Filtrerar bort kolumner
lista_med_tätorter <- pull(od_matrix,start_tatort_namn)
od_matrix <- od_matrix %>%
select(start_tatort_namn,lista_med_tätorter[1:minsta_antal_resor-1],Totaltc) %>%
rename("Från tärort" = start_tatort_namn) %>%
mutate("Övriga områden" = -rowSums(select_if(., is.numeric), na.rm = TRUE)+2*Totaltc) %>%
relocate(Totaltc, .after = "Övriga områden")
library(knitr)
library(kableExtra)
library(ggplot2)
library(tidyverse)
library(readxl)
library(bookdown)
library(pxweb)
library(scales)
library(stringi)
#Filtrerar data
reslangd <- rvu %>%
filter(!is.na(avstand)) %>%
rename(Färdmedel = fardmedel.kat) %>%
select(respondentid,Färdmedel,avstand,Område,Område_kod)
#Räknar ut hur många individer som gör resor per område
antal_resande_individer <- rvu %>%
group_by(Område) %>%
summarise("Antal_resande_individer" = n_distinct(respondentid))
#Räknar ut hur många individer som inte gör någon resa
individer_utan_resa <- pers %>% #OBS i dagsläget saknar alla individer utan resa också område...
group_by(Område) %>%
summarise("Antal_individer" = n_distinct(respondentid)) %>%
left_join(antal_resande_individer, by = c("Område" = "Område")) %>%
mutate(Individer_utan_resa = Antal_individer-Antal_resande_individer) %>%
select(Område,Individer_utan_resa)
#Räknar ut hur många individer det finns per område
individer_per_område <- reslangd %>%
group_by(Område) %>%
summarise("Antal_individer" = n_distinct(respondentid)) %>%
left_join(individer_utan_resa, by = c("Område" = "Område")) %>%
mutate(Antal_individer = Antal_individer+Individer_utan_resa) %>%
select(Område,Antal_individer)
#Antal resor per individ (och område, färdmedel) räknas ut
resor_per_individ <- reslangd %>% #Resor per individ blir överskattat pga fel med att individer utan resa saknar bostadsort
group_by(Område,Område_kod,Färdmedel) %>%
summarise("Antal_observationer" = n()) %>%
left_join(individer_per_område, by = c("Område" = "Område")) %>%
mutate(Resor_per_individ = Antal_observationer/Antal_individer) %>%
left_join(select(deso_befolkning, c(Område_kod,Befolkning)), by = c("Område_kod" = "Område_kod")) %>%
mutate(Totalt_antal_resor = Befolkning*Resor_per_individ) %>%
ungroup() %>%
select(Område,Färdmedel,Totalt_antal_resor)
#Antal resor per individ (färdmedel) räknas ut
resor_per_individ_summa <- resor_per_individ %>%
group_by(Färdmedel) %>%
summarise("Totalt_antal_resor" = round(sum(Totalt_antal_resor,na.rm = TRUE),0))
#Räknar ut totalt
reslangd_summa_tot <- reslangd %>%
summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
cbind(Färdmedel = "Totalt") %>%
cbind(Område = "Alla") %>%
mutate(Totalt_antal_resor = sum(resor_per_individ$Totalt_antal_resor,na.rm = TRUE)) %>%
mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel)
#Räknar ut totalt per färdmedel
reslangd_summa <- reslangd %>%
group_by(Färdmedel) %>%
summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
mutate(Område = c("Alla")) %>%
left_join(resor_per_individ_summa, by = c("Färdmedel" = "Färdmedel")) %>%
mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel) %>%
rbind(reslangd_summa_tot)
#Räknar ut totalt per färdmedel och område
reslangd_per_område <- reslangd %>%
select(-one_of("Område_kod")) %>%
group_by(Område,Färdmedel) %>%
summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
left_join(resor_per_individ, by = c("Område" = "Område", "Färdmedel" = "Färdmedel")) %>%
mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel)
#Antalet observationer som krävs för att data ska visas (global parameter)
tillräckligt_underlag <- 5
#Döljer värden som inte ska visas
reslangd_per_område <- reslangd_per_område %>%
mutate(Median= ifelse(Antal_observationer < tillräckligt_underlag, NA, Median)) %>%
mutate(Medel= ifelse(Antal_observationer < tillräckligt_underlag, NA, Medel)) %>%
mutate(Totalt_antal_resor= ifelse(Antal_observationer < tillräckligt_underlag, NA, Totalt_antal_resor)) %>%
mutate(Trafikarbete_totalt= ifelse(Antal_observationer < tillräckligt_underlag, NA, Trafikarbete_totalt))
#Exempel som ska kunna slå ihop celler... Vi bör nog använda kableExtra för att göra snyggare grafer...
#dt <- mtcars[1:10, 1:6]
#kable(dt, format = "latex", caption = "Group Rows", booktabs = T) %>%
#    kable_styling() %>%
#    group_rows("Group 1", 4, 7) %>%
#    group_rows("Group 2", 8, 10)
#kbl(reslangd_per_område, align = "c") %>%
#  kable_paper(full_width = F) %>%
#  column_spec(1, bold = T) %>%
#  collapse_rows(columns = 1:1)
reslangd_per_omrade_rep <- crossing(unique(reslangd$Område), unique(reslangd$Färdmedel)) %>% #creating combination of all Område and Färdmedel to have all rows in the table
rename(Område = "unique(reslangd$Område)",
Färdmedel = "unique(reslangd$Färdmedel)") %>%
left_join(reslangd_per_område, by = c("Område", "Färdmedel")) %>%
rbind(reslangd_summa) %>%
mutate(
Område = ifelse(is.na(Område), "Ej angivet", Område),
Färdmedel = Färdmedel,
Median = ifelse(is.na(Median), "-", round(Median/1000)),
Medel = ifelse(is.na(Medel), "-", round(Medel/1000)),
"Totalt antal resor" = ifelse(is.na(Totalt_antal_resor), "-", round(Totalt_antal_resor/100)*100),
"Trafikarbete totalt" = ifelse(is.na(Trafikarbete_totalt), "-", round(Trafikarbete_totalt/1000)),
"Antal observationer" = ifelse(is.na(Antal_observationer), 0, Antal_observationer)
) %>%
select(-Antal_observationer,-Totalt_antal_resor,-Trafikarbete_totalt)
antal_omraden = unique(reslangd_per_omrade_rep$Område)
reslangd_per_omrade_rep <- reslangd_per_omrade_rep %>%
select(-Område)
x <- kbl(reslangd_per_omrade_rep, longtable = T, booktabs = T, linesep = "") %>%
#Captions appear to create problems with longtable package, gives error "mispaced align"
#See here for solution, but don't know how to implement:
#https://tex.stackexchange.com/a/205468
kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header"),
repeat_header_text = "\\textit{(fortsättning)}",
repeat_header_continued = "\\textit{(Fortsätter på nästa sida...)}") %>%
row_spec(nrow(reslangd_per_omrade_rep), bold = T) %>% #making the Total row bold
row_spec(0, bold = T) #making the Header row bold
for (i in c(1:(length(antal_omraden)-1))){
x <- x %>%
pack_rows(antal_omraden[i], (i-1)*5+1, (i-1)*5+5,
hline_after = TRUE)
}
x <- x %>%
pack_rows("Alla", (length(antal_omraden)-1)*5+1, (length(antal_omraden)-1)*5 + 6,
hline_after = TRUE,
hline_before = TRUE)
x
x <- kbl(reslangd_per_omrade_rep, longtable = T, booktabs = T, linesep = "") %>%
#Captions appear to create problems with longtable package, gives error "mispaced align"
#See here for solution, but don't know how to implement:
#https://tex.stackexchange.com/a/205468
kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header"),
repeat_header_text = "\\textit{(fortsättning)}",
repeat_header_continued = "\\textit{(Fortsätter på nästa sida...)}") %>%
row_spec(nrow(reslangd_per_omrade_rep), bold = T) %>% #making the Total row bold
row_spec(0, bold = T) #making the Header row bold
for (i in c(1:(length(antal_omraden)-1))){
x <- x %>%
pack_rows(antal_omraden[i], (i-1)*5+1, (i-1)*5+5,
hline_after = TRUE)
}
x <- x %>%
pack_rows("Alla", (length(antal_omraden)-1)*5+1, (length(antal_omraden)-1)*5 + 6,
hline_after = TRUE,
hline_before = TRUE)
x
View(reslangd)
kable(od_matrix, caption = "O-D-Matris", booktabs = T, linesep = "") %>%
kable_styling(latex_options = c("striped", "HOLD_position"),
full_width = TRUE) %>%
row_spec(0, bold = T, angle = 45) %>% #making the Header row bold)
column_spec(bold = TRUE)
kable(od_matrix, caption = "O-D-Matris", booktabs = T, linesep = "") %>%
kable_styling(latex_options = c("striped", "HOLD_position"),
full_width = TRUE) %>%
row_spec(0, bold = T, angle = 45) %>% #making the Header row bold)
column_spec(1,bold = TRUE)
kable(od_matrix, caption = "O-D-Matris", booktabs = T, linesep = "") %>%
kable_styling(latex_options = c("striped", "HOLD_position"),
full_width = TRUE) %>%
row_spec(0, bold = T, angle = 45) %>% #making the Header row bold)
column_spec(1, bold = T, angle = 45)
kable(od_matrix, caption = "O-D-Matris", booktabs = T, linesep = "") %>%
kable_styling(latex_options = c("striped", "HOLD_position"),
full_width = TRUE) %>%
row_spec(0, bold = T, angle = 45) %>% #making the Header row bold)
column_spec(1, bold = T, width = 2cm)
kable(od_matrix, caption = "O-D-Matris", booktabs = T, linesep = "") %>%
kable_styling(latex_options = c("striped", "HOLD_position"),
full_width = TRUE) %>%
row_spec(0, bold = T, angle = 45) %>% #making the Header row bold)
column_spec(1, bold = T, width = "2cm")
minsta_antal_resor <- 10
od_matrix <- rvu %>%
select(start_tatort_namn, stop_tatort_namn) %>%
filter(!is.na(start_tatort_namn)) %>%
filter(!is.na(stop_tatort_namn)) %>%
group_by(start_tatort_namn, stop_tatort_namn) %>%
summarize(antal = n()) %>%
pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
ungroup() %>%
mutate("Totalt" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>%
top_n(minsta_antal_resor) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Övriga områden")))
#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix[minsta_antal_resor, -1]- od_matrix[minsta_antal_resor+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix <- rbind(od_matrix[1:minsta_antal_resor-1,],od_matrix_övriga,od_matrix[minsta_antal_resor,])
#Filtrerar bort kolumner
lista_med_tätorter <- pull(od_matrix,start_tatort_namn)
od_matrix <- od_matrix %>%
select(start_tatort_namn,lista_med_tätorter[1:minsta_antal_resor-1],Totalt) %>%
rename("Från tärort" = start_tatort_namn) %>%
mutate("Övriga områden" = -rowSums(select_if(., is.numeric), na.rm = TRUE)+2*Totalt) %>%
relocate(Totalt, .after = "Övriga områden")
View(od_matrix)
od_matrix <- rvu %>%
select(start_tatort_namn, stop_tatort_namn) %>%
filter(!is.na(start_tatort_namn)) %>%
filter(!is.na(stop_tatort_namn)) %>%
group_by(start_tatort_namn, stop_tatort_namn) %>%
summarize(antal = n()) %>%
pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
ungroup()
sum(od_matrix)
sum(od_matrix,na.rm = TRUE)
sum(od_matrix,na.rm = FALSE)
od_matrix/100
od_matrix
rownames(od_matrix) <- df$start_tatort_namn
rownames(od_matrix) <- od_matrix$start_tatort_namn
as.data.frame(od_matrix)
df <- as.data.frame(od_matrix)
df
df(od_matrix) <- df$start_tatort_namn
df(od_matrix) = df$start_tatort_namn
rownames(df) <- df$start_tatort_namn
df
View(df)
df/100
df[!start_tatort_namn]
select(df,start_tatort_namn)
select(df,!start_tatort_namn)
df <- as.data.frame(od_matrix)
rownames(df) <- df$start_tatort_namn
df <- select(df,!start_tatort_namn)
View(df)
df/100
sum(df)
df/sum(df)
df/sum(df)*100
round(df/sum(df)*100)
df <- as.data.frame(od_matrix)
rownames(df) <- df$start_tatort_namn
df <- select(df,!start_tatort_namn)
df <- round(df/sum(df)*100)
minsta_antal <- 10
od_matrix <- rvu %>%
select(start_tatort_namn, stop_tatort_namn) %>%
filter(!is.na(start_tatort_namn)) %>%
filter(!is.na(stop_tatort_namn)) %>%
group_by(start_tatort_namn, stop_tatort_namn) %>%
summarize(antal = n()) %>%
pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
ungroup()
#Skapar total och övriga områden
od_matrix_abs <- od_matrix %>%
mutate("Totalt" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>%
top_n(minsta_antal) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Övriga områden")))
#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix_abs[minsta_antal, -1]- od_matrix_abs[minsta_antal+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix_abs <- rbind(od_matrix_abs[1:minsta_antal-1,],od_matrix_övriga,od_matrix_abs[minsta_antal,])
#Filtrerar bort kolumner
lista_med_tätorter <- pull(od_matrix_abs,start_tatort_namn)
od_matrix_abs <- od_matrix_abs %>%
select(start_tatort_namn,lista_med_tätorter[1:minsta_antal-1],Totalt) %>%
rename("Från tärort" = start_tatort_namn) %>%
mutate("Övriga områden" = -rowSums(select_if(., is.numeric), na.rm = TRUE)+2*Totalt) %>%
relocate(Totalt, .after = "Övriga områden")
#Skapar procent-matris
od_matrix_perc <- as.data.frame(od_matrix)
rownames(od_matrix_perc) <- od_matrix_perc$start_tatort_namn
od_matrix_perc <- select(od_matrix_perc,!start_tatort_namn)
od_matrix_perc <- round(od_matrix_perc/sum(od_matrix_perc)*100)
#Filtrerar bort kolumner i procent-matris
od_matrix_perc <- top_n(od_matrix_perc,minsta_antal)
lista_med_tätorter <- pull(od_matrix_perc,start_tatort_namn)
View(od_matrix_abs)
View(od_matrix_perc)
od_matrix_perc <- top_n(od_matrix_perc,minsta_antal)
minsta_antal <- 10
od_matrix <- rvu %>%
select(start_tatort_namn, stop_tatort_namn) %>%
filter(!is.na(start_tatort_namn)) %>%
filter(!is.na(stop_tatort_namn)) %>%
group_by(start_tatort_namn, stop_tatort_namn) %>%
summarize(antal = n()) %>%
pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
ungroup()
#Skapar total och övriga områden
od_matrix <- od_matrix %>%
mutate("Totalt" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>%
top_n(minsta_antal) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Övriga områden")))
#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix[minsta_antal, -1]- od_matrix[minsta_antal+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix <- rbind(od_matrix[1:minsta_antal-1,],od_matrix_övriga,od_matrix[minsta_antal,])
#Filtrerar bort kolumner
lista_med_tätorter <- pull(od_matrix,start_tatort_namn)
od_matrix <- od_matrix %>%
select(start_tatort_namn,lista_med_tätorter[1:minsta_antal-1],Totalt) %>%
rename("Från tärort" = start_tatort_namn) %>%
mutate("Övriga områden" = -rowSums(select_if(., is.numeric), na.rm = TRUE)+2*Totalt) %>%
relocate(Totalt, .after = "Övriga områden")
#Skapar procent-matris
od_matrix_perc <- as.data.frame(od_matrix)
rownames(od_matrix_perc) <- od_matrix_perc$start_tatort_namn
od_matrix_perc <- as.data.frame(od_matrix)
rownames(od_matrix_perc) <- od_matrix_perc$start_tatort_namn
od_matrix_perc <- select(od_matrix_perc,!c(start_tatort_namn,Totalt))
#Skapar procent-matris
od_matrix_perc <- as.data.frame(od_matrix)
rownames(od_matrix_perc) <- od_matrix_perc$"Från tärort"
od_matrix_perc <- select(od_matrix_perc,!c("Från tärort",Totalt))
od_matrix_perc <- as.data.frame(od_matrix)
rownames(od_matrix_perc) <- od_matrix_perc$"Från tärort"
od_matrix_perc <- as.data.frame(od_matrix)
rownames(od_matrix_perc) <- od_matrix_perc$"Från tärort"
od_matrix_perc <- select(od_matrix_perc,!c("Från tärort",Totalt))
od_matrix_perc <- as.data.frame(od_matrix)
rownames(od_matrix_perc) <- od_matrix_perc$"Från tärort"
od_matrix_perc <- select(od_matrix_perc,!c("Från tärort",Totalt))
od_matrix_perc <- rbind(od_matrix_perc[1:minsta_antal,])
od_matrix_perc <- round(od_matrix_perc/sum(od_matrix_perc)*100)
minsta_antal <- 10
od_matrix <- rvu %>%
select(start_tatort_namn, stop_tatort_namn) %>%
filter(!is.na(start_tatort_namn)) %>%
filter(!is.na(stop_tatort_namn)) %>%
group_by(start_tatort_namn, stop_tatort_namn) %>%
summarize(antal = n()) %>%
pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
ungroup()
#Skapar total och övriga områden
od_matrix <- od_matrix %>%
mutate("Totalt" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>%
top_n(minsta_antal) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Övriga områden")))
#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix[minsta_antal, -1]- od_matrix[minsta_antal+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix <- rbind(od_matrix[1:minsta_antal-1,],od_matrix_övriga,od_matrix[minsta_antal,])
#Filtrerar bort kolumner
lista_med_tätorter <- pull(od_matrix,start_tatort_namn)
od_matrix <- od_matrix %>%
select(start_tatort_namn,lista_med_tätorter[1:minsta_antal-1],Totalt) %>%
rename("Från tärort" = start_tatort_namn) %>%
mutate("Övriga områden" = -rowSums(select_if(., is.numeric), na.rm = TRUE)+2*Totalt) %>%
relocate(Totalt, .after = "Övriga områden")
#Skapar procent-matris
od_matrix_perc <- as.data.frame(od_matrix)
rownames(od_matrix_perc) <- od_matrix_perc$"Från tärort"
od_matrix_perc <- select(od_matrix_perc,!c("Från tärort",Totalt))
od_matrix_perc <- rbind(od_matrix_perc[1:minsta_antal,])
od_matrix_perc <- round(od_matrix_perc/sum(od_matrix_perc)*100)
minsta_antal <- 10
od_matrix <- rvu %>%
select(start_tatort_namn, stop_tatort_namn) %>%
filter(!is.na(start_tatort_namn)) %>%
filter(!is.na(stop_tatort_namn)) %>%
group_by(start_tatort_namn, stop_tatort_namn) %>%
summarize(antal = n()) %>%
pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
ungroup()
#Sparar OD-matris som csv
write.csv(od_matrix, "od_matrix.csv")
#Filtrerar ut populäraste områden samt skapar total och övriga områden
od_matrix <- od_matrix %>%
mutate("Totalt" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>%
top_n(minsta_antal) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Övriga områden")))
#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix[minsta_antal, -1]- od_matrix[minsta_antal+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix <- rbind(od_matrix[1:minsta_antal-1,],od_matrix_övriga,od_matrix[minsta_antal,])
#Filtrerar bort kolumner
lista_med_tätorter <- pull(od_matrix,start_tatort_namn)
od_matrix <- od_matrix %>%
select(start_tatort_namn,lista_med_tätorter[1:minsta_antal-1],Totalt) %>%
rename("Från tärort" = start_tatort_namn) %>%
mutate("Övriga områden" = -rowSums(select_if(., is.numeric), na.rm = TRUE)+2*Totalt) %>%
relocate(Totalt, .after = "Övriga områden")
#Skapar procent-matris
od_matrix_perc <- as.data.frame(od_matrix)
rownames(od_matrix_perc) <- od_matrix_perc$"Från tärort"
od_matrix_perc <- select(od_matrix_perc,!c("Från tärort",Totalt))
od_matrix_perc <- rbind(od_matrix_perc[1:minsta_antal,])
od_matrix_perc <- round(od_matrix_perc/sum(od_matrix_perc)*100)
kable(od_matrix_perc, caption = "O-D-Matris", booktabs = T, linesep = "") %>%
kable_styling(latex_options = c("striped", "HOLD_position"),
full_width = TRUE) %>%
row_spec(0, bold = T, angle = 45) %>% #making the Header row bold)
column_spec(1, bold = T, width = "2cm")
