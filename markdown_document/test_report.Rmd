---
title: "test_rvu_v1.1"
author: "WSP"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output:
  bookdown::pdf_document2: default
header-includes:
  - \renewcommand{\figurename}{Figur }
  - \makeatletter
  - \def\fnum@figure{\figurename\thefigure}
  - \makeatother
  - \renewcommand{\tablename}{Tabell }
  - \makeatletter
  - \def\tnum@table{\tablename\thetable}
  - \makeatother
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}

---

# Resvaneundersökning Bålsta

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
#library(ggplot2) #kanske ta bort
library(tidyverse)
library(readxl)
library(bookdown)
library(pxweb)
library(scales)
library(stringi)
```

```{r plot-theme-creation, include = FALSE}
rvu_theme <- function() {
    theme(
        plot.title = element_text(colour = "steelblue", face = "bold"),
        plot.background = element_rect(fill = "white"),
        # add border 1)
        panel.border = element_rect(colour = "blue", fill = NA, linetype = 1),
        # color background 2)
        panel.background = element_rect(fill = "aliceblue"),
        # modify grid 3)
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y =  element_line(colour = "steelblue", linetype = 3, size = 0.5),
        panel.grid.minor.y = element_blank(),
        # modify text, axis and colour 4) and 5)
        axis.title.y = element_text(colour = "steelblue"),
        axis.title.x = element_text(colour = "steelblue"),
        axis.line.x = element_blank(),
        axis.text.y = element_text(colour = "steelblue", face = "italic"),
        axis.text.x = element_blank(),
        axis.ticks.y = element_line(colour = "steelblue"),
        axis.ticks.x = element_blank(),
        # legend at the bottom 6)
        legend.position = "right",
        legend.title = element_blank(),
        legend.background = element_rect(colour = "steelblue", fill = "aliceblue")
    )
}

options(knitr.table.format = "latex")

```

```{r indata, echo=FALSE, include = FALSE}
#Nedan specificeras indata/globala parametrar
#Definierar om respondenter ska delas upp på kommun, tätort eller deso-nivå:
rapportområde <- 'Bålsta'
nivå <- "deso" #'kommun' #'tatort' #vilken områdesnivån som resultaten ska redovisas på. Om rapportområdet är en region, bör kommun väljas och om det är en tätort bör deso väljas osv...
```

```{r funktioner, echo=FALSE, include = FALSE}
#Nedan specificeras funktioner som används i skriptet

#Funktioner för att hitta extremer i data
extremer_höga <- function(table, col) {
  table <- table %>%
    filter(Område != "Totalt") %>%
    rename(col = col) %>%
    filter(!between(col, 0, median(col, na.rm=TRUE) + (2.5 * sd(col, na.rm=TRUE)))) %>%
    arrange(desc(col))
  return(table)
}

extremer_låga <- function(table, col) {
  table <- table %>%
    filter(Område != "Totalt") %>%
    rename(col = col) %>%
    filter(!between(col, median(col, na.rm=TRUE) - (2.5 * sd(col, na.rm=TRUE)), 100)) %>%
    arrange(col)
  return(table)
}

```

```{r read_data, echo=FALSE, include = FALSE}

rvu <- read_delim("rvu_sample_2021-08-09.csv", ";", escape_double = FALSE, 
                    locale = locale(encoding = "ISO-8859-1"), 
                    trim_ws = TRUE)

pers <- read_delim("person_sample_2021-08-09.csv", ";", escape_double = FALSE, 
                     locale = locale(encoding = "ISO-8859-1"), 
                     trim_ws = TRUE)

avst <- read_delim("rvu_restid_sample_2021-08-09.csv", ";", escape_double = FALSE, 
                     locale = locale(encoding = "ISO-8859-1"), 
                     trim_ws = TRUE) %>%
  select(respondentid, resa_nr, distance_straight_line, distance_google)

#Filter för att begränsa till Håbo kommun, detta ska inte behövas när de riktiga data kommer
pers <- pers %>%
  filter(bostad_kommun_kod == 305)
rvu <- rvu %>%
  filter(respondentid %in% pers$respondentid)
avst <- avst %>%
  filter(respondentid %in% pers$respondentid)

#joina avstånd till resor
rvu <- rvu %>%
  left_join(avst, by = c("respondentid", "resa_nr")) %>%
  mutate(avstand = distance_google) %>%
  mutate(fardmedel.kat = ifelse(fardmedel.kat == "Kollektiv_buss","Buss",fardmedel.kat)) %>%
  mutate(fardmedel.kat = ifelse(fardmedel.kat == "Kollektiv_tåg","Tåg",fardmedel.kat))

#ett viktad medelvärde för året då RVU genomfördes för att få rätt befolkningsdata från SCB API
rvu_yr <- pers %>% group_by(ar) %>% summarise(resp_in_year = n()) %>% 
  summarise(avg_year = weighted.mean(ar, resp_in_year)) %>% 
  round() %>% as.character()

# Hämtar befolkningsdata per DESO-område från SCBs API
table_api_address = "http://api.scb.se/OV0104/v1/doris/en/ssd/BE/BE0101/BE0101Y/FolkmDesoAldKonN"

pxweb_query_list <- 
    list("Region"=c('*'), # Use "*" to select all
         "Alder" = c('15-19','20-24','25-29','30-34','35-39','40-44','45-49','50-54','55-59','60-64','65-69','70-74','75-79','80-'),
         "Kon"=c('1','2'), #1:man, 2:kvinna
         "ContentsCode"=c('000005FF'), #table name in SCB webpage
         "Tid"=c(rvu_yr))
px_query <- pxweb_query(pxweb_query_list)

px_data <- pxweb_get(table_api_address,
                 px_query)

deso_befolkning <- as.data.frame(px_data, column.name.type = "text", variable.value.type = "text") %>%
#kolumnerna ska heta: region (chr), citizenship (chr), sex (chr), year (chr), Population per region (chr) %>%
  mutate(region = str_trim(region, side = "left")) %>% #removing blank character
  rename(Område_kod = region,
         Ålder = age,
         Kön = sex,
         Befolkning = "Population per region") %>%
  select(Område_kod, Ålder, Kön, Befolkning)

deso_befolkning <- deso_befolkning %>%
  mutate(Män = ifelse(Kön == "men", Befolkning, 0),
         Kvinnor = ifelse(Kön == "women", Befolkning, 0),
         Ålder_15_24 = ifelse(strtoi(str_sub(Ålder,1,2)) < 25, Befolkning, 0),
         Ålder_25_64 = ifelse(strtoi(str_sub(Ålder,1,2)) > 20 & Ålder < 65, Befolkning, 0),
         Ålder_65 = ifelse(strtoi(str_sub(Ålder,1,2)) > 60, Befolkning, 0)) %>%
  group_by(Område_kod) %>%
  summarise(Befolkning = sum(Befolkning), Män = sum(Män), Kvinnor = sum(Kvinnor), "Ålder_15_24" = sum(Ålder_15_24), "Ålder_25_64" = sum(Ålder_25_64), "Ålder_65" = sum(Ålder_65))

pers <- mutate(pers,bostad_deso_namn = bostad_deso)
pers <- mutate(pers,bostad_deso_kod = bostad_deso)

pers <- mutate(pers,Område = .data[[paste("bostad_",nivå,"_namn",sep="")]])
pers <- mutate(pers,Område_kod = .data[[paste("bostad_",nivå,"_kod",sep="")]])

respondent2omrade <- pers %>%
  select(respondentid, Område, Område_kod) %>%
  left_join(deso_befolkning, by = c("Område_kod" = "Område_kod"))

rvu <- rvu %>%
  left_join(select(respondent2omrade, c(respondentid,Område,Område_kod)), by = c("respondentid" = "respondentid"))

#Funkar inte...
#rvu <- rvu %>%
#  left_join(respondent2omrade, by = c("respondentid" = "respondentid")) %>%
#  select(respondentid)

#Lookup-table för att hämta klartext
variable_data <- read_excel("Variable information + Variable Values 2021-05-28.xlsx",
                            sheet = "Variable Labels", skip = 1, col_names = TRUE)
labels_data <- read_excel("Variable information + Variable Values 2021-05-28.xlsx",
                          sheet = "Value Labels", skip = 1, col_names = TRUE)


labels_data <- labels_data %>%
  rename(answer_id=...2,answer=Label,question_id=Value) %>%
  mutate(answer_id = as.numeric(str_remove(str_replace(answer_id, ",", "."),"a"))) %>% #Obs finns NA-observationer
  mutate(question_num=cumsum(!is.na(question_id)))

#Skapar nyckel mellan fråge-id och frågenummer
nyckel <- labels_data %>%
  select(question_id, question_num) %>%
  filter(!is.na(question_id))

#Skapar koppling mellan fråge-ID, svars-ID och svaret
labels_data <- labels_data %>%
  select(answer_id,answer, question_num) %>%
  left_join(nyckel, by = "question_num") %>%
  select(question_id,answer_id,answer)

```

## Sammanfattning

### Antal resor


### Färdmedelsfördelning

### Trafikarbete

### Fördelning mellan män och kvinnor

### Fördelning mellan ålderskategorier

### Vanligaste målpunkterna

## Inledning

Följande resvanerapport har tagits fram för att öka kunskapen om dagens resmönster för olika trafikantgrupper i `r (rapportområde)`. Rapportens resultat avser att ge en bild av hur resandet ser ut en genomsnittlig vardag. Resultatet utgör ett viktigt underlag för att planera för en hållbar tillväxt och ett hållbart resande. Rapporten är skapad genom ett automatiserat skript, framtaget av WSP på uppdrag av Region Uppsala. Skriptet läser och sammanställer data från kollektivtrafikbarometern, samt presenterar och kommenterar resultaten i löpande text. 

### Metod

Rapporten är baserad på data från Kollektivtrafikbarometern som är en branschgemensam kvalitets- och resvaneundersökning som drivs och utvecklas av Svensk Kollektivtrafik. Kollektivtrafikbarometern är en nationell undersökning som riktar sig till den svenska allmänheten mellan 15 och 85 år, både de som använder kollektivtrafiken och de som inte gör det. Ett slumpmässigt och representativt individurval ur ett befolkningsregister utifrån postnummerområden ligger till grunden.

I regel deltar majoriteten av landets 23 regioner i Kollektivtrafiksbarometern. Antalet insamlade enkätsvar per region varierar normalt mellan cirka 1 000 och 10 000.

Skriptet som har använts för att ta fram denna rapport är skrivet i programmeringsspråket R. Skriptet läser av automatiskt förbearbetad rådata från enkätundersökningen, kompletterad med beräknade reslängder från Google Maps API.

```{r respondant_details, echo=FALSE, include = FALSE}
respondenter <- pers %>%
  mutate(Område = ifelse(is.na(Område), "Ej angivet", Område)) %>%
  select(Område, Område_kod, kon, alder) %>%
  group_by(Område) %>%
  summarize(Respondenter = n(),
            Man = sum(kon == "Man"), 
            Kvinnor = sum(kon == "Kvinna"),
            "15-24 år" = sum(alder >= 15 & alder < 25),
            "25-64 år" = sum(alder >= 25 & alder < 65),
            "65-85 år" = sum(alder >= 65),
            Område_kod = first(Område_kod)) %>%
  left_join(select(deso_befolkning, c(Område_kod,Befolkning)), by = c("Område_kod" = "Område_kod")) %>% #Lägger till befolkning per zon
  mutate(Befolkning = replace_na(Befolkning,0)) %>%
  select(-one_of("Område_kod")) %>%
  bind_rows(summarize(., 
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt")))

respondenter_tabell <- respondenter %>%
  select(!Befolkning)

svarsgrad <- respondenter %>%
  filter(Område != "Ej angivet") %>%
  #filter(Område != "Totalt") %>% #Först bör genomsnittlig andel svarande sparas
  mutate(Svarsfrekvens = Respondenter/Befolkning*100) %>%
  select(Område,Respondenter,Befolkning,Svarsfrekvens)

svarsgrad_tabell <- svarsgrad %>%
  mutate("Andel av befolkningen (%)" = round(Svarsfrekvens*10)/10) %>%
  select(!Svarsfrekvens)

svarsgrad_totalt <- pull(svarsgrad[nrow(svarsgrad),"Svarsfrekvens"])

#Försök att filtrera ut extremvärden för att kunna skriva om dem i texten.
svarsgrad_extremer_höga <- extremer_höga(svarsgrad,"Svarsfrekvens")
svarsgrad_extremer_låga <- extremer_låga(svarsgrad,"Svarsfrekvens")

##### Stycke som presenterar svarsgraden #####
text <- paste("Andelen svarande av befolkningen (15 år och äldre) var i genomsnitt ",round(svarsgrad_totalt*10)/10," %. ")

max_antal_uppräknade <- 3 #hur många områden som maximalt ska lyftas fram

extremer <- svarsgrad_extremer_höga
if (nrow(extremer)>1){ #om det finns extremer
  #slice(which.max(Svarsfrekvens))
  text <- paste(text,"Särskilt hög var andelen svarande i ")
  #Uppräkning av områden
  antal_uppräknade <- min(nrow(extremer),max_antal_uppräknade) #som minst räknas alla områden upp
  text_uppräkning <- paste(extremer$Område[1:(antal_uppräknade)], collapse = ', ') #sträng med områden
  text_uppräkning <- stri_replace_last_fixed(text_uppräkning, ', ', ' och ') #sätter "och" i slutet av uppräkningen
  text <- paste(text,text_uppräkning,", där andelen svarande var upp emot ",round(extremer$Svarsfrekvens[1])," %. ",sep="")
  } else {
    svarsgrad_max <- slice(svarsgrad,which.max(Svarsfrekvens))
    text <- paste(text,"Högst andel svarande återfinns i ",svarsgrad_max$Område,", där andelen svarande var ",round(svarsgrad_max$Svarsfrekvens)," %. ",sep="")
}

extremer <- svarsgrad_extremer_låga
if (nrow(extremer)>1){ #om det finns extremer
  #slice(which.max(Svarsfrekvens))
  text <- paste(text,"Särskilt hög andel svarande återfinns i ")
  #Uppräkning av områden
  antal_uppräknade <- min(nrow(extremer),max_antal_uppräknade) #som minst räknas alla områden upp
  text_uppräkning <- paste(extremer$Område[1:(antal_uppräknade)], collapse = ', ') #sträng med områden
  text_uppräkning <- stri_replace_last_fixed(text_uppräkning, ', ', ' och ') #sätter "och" i slutet av uppräkningen
  text <- paste(text,text_uppräkning,", där andelen svarande var upp emot ",round(extremer$Svarsfrekvens[1])," %. ",sep="")
  } else {
    svarsgrad_min <- slice(svarsgrad,which.min(Svarsfrekvens))
    text <- paste(text,"Lägst andel svarande återfinns i ",svarsgrad_min$Område,", där andelen svarande var nära ",round(svarsgrad_min$Svarsfrekvens)," %. ",sep="")
  }

text <- paste(text,"Svarsfrekvensen bland de tillfrågade är inte känd. ")

#textvariabler till kommande textstycke
if (nivå == 'deso')
  nivånivå <- 'DeSO-nivå'
if (nivå == 'tätort')
  nivånivå <- 'tätorts'
if (nivå == 'kommun')
  nivånivå <- 'kommun'

antal_individer <- nrow(pers)

```
### Population och urval

Kollektivtrafiksbarometerns attityd- och resvaneundersökning är en årlig och nationell enkätundersökning som strävar efter att fånga ett representativt urval av befolkningen i respektive region. För varje respondent lagras egenskaper som kön, ålder och koordinater till hemmet. I denna rapport har resultaten sammanfattats uppdelade geografiskt på `r (nivånivå)`.

Ur undersökningen har de `r (antal_individer)` respondenter som bor i `r (rapportområde)` valts ut. I Tabell \@ref(tab:svarsfrekvens-table) återfinns befolkning, antal respondenter och andelen svarande av befolkningen. Respondenternas kön och ålder per område finns redovisade i Tabell \@ref(tab:repondant-table).

```{r svarsfrekvens-table, echo = FALSE, results = "asis"}
kbl(svarsgrad_tabell, caption = "Antal svar jämfört med befolkningen (15 år och äldre) i respektive område", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(svarsgrad_tabell), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

`r (text)` 

```{r repondant-table, echo = FALSE, results = "asis"}
#kable(respondenter, caption = "Antal svar per kön och åldersgrupp")
kbl(respondenter_tabell, caption = "Antal svar per kön och åldersgrupp", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(respondenter_tabell), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```
Eftersom svarsbenägenheten varierar mellan olika grupper av invånare kan viss skevhet i representationen uppstå, trots att urvalet från början gjorts på ett representativt sätt. Genom att använda en mixad insamlingsmetod, där fysisk post, telefon och sms har använts för att nå respondenterna, har svarsunderlaget kunnat hålla en bättre representativitet än traditionella underskningar. Viktning mot kön, ålder och urvalsområde har därför inte ansetts vara nödvändig.

## Resultat

Nedan presenteras sammanställningen av resultat från resvaneundersökningen.

### Körkort och biltillgång

Valet att färdas med bil, buss eller cykel eller att promenera är beroende av en mängd faktorer 
såsom transportsystemets utbud och standard, attityder och kunskap, restriktioner och vanor. 
Avgörande för färdmedelsvalet är körkortsinnehav och biltillgång.

```{r korkort, echo=FALSE, include=FALSE}
korkort_bil <- pers %>%
  filter(!(is.na(h4) & is.na(h5))) %>%
  mutate(Område = ifelse(is.na(Område), "Ej angivet", Område)) %>%
  select(Område, h4, h5) %>%
  group_by(Område) %>%
  summarize(korkort_bil = sum(na.omit(h4) == 1),
            Biltillgång = sum(h5 == 1) + sum(h5 == 2) + sum(h5 == 3) + sum(h5 == 4),
            Antal_individer = n()) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt"))) %>%
  mutate("Körkort (%)" = korkort_bil/Antal_individer*100,
         "Biltillgång (%)" = Biltillgång/Antal_individer*100) %>%
  select(Område, "Körkort (%)", "Biltillgång (%)")

korkort_bil <- korkort_bil

körkort_totalt <- pull(korkort_bil[nrow(korkort_bil),"Körkort (%)"])

biltillgång_totalt <- pull(korkort_bil[nrow(korkort_bil),"Biltillgång (%)"])

körkort_min <- min(korkort_bil$"Körkort (%)")
```

```{r korkort_text, echo=FALSE, include=FALSE}
#Försök att filtrera ut extremvärden för att kunna skriva om dem i texten.
korkort_bil_extremer_höga <- extremer_höga(korkort_bil,"Körkort (%)")
korkort_bil_extremer_låga <- extremer_låga(korkort_bil,"Körkort (%)")

##### Stycke som presenterar svarsgraden #####
text <- ""

max_antal_uppräknade <- 3 #hur många områden som maximalt ska lyftas fram

extremer <- korkort_bil_extremer_höga
if (nrow(extremer)>1){ #om det finns extremer
  #slice(which.max(Svarsfrekvens))
  text <- paste(text,"Särskilt högt var bilinnehavet bland människor i ")
  #Uppräkning av områden
  antal_uppräknade <- min(nrow(extremer),max_antal_uppräknade) #som minst räknas alla områden upp
  text_uppräkning <- paste(extremer$Område[1:(antal_uppräknade)], collapse = ', ') #sträng med områden
  text_uppräkning <- stri_replace_last_fixed(text_uppräkning, ', ', ' och ') #sätter "och" i slutet av uppräkningen
  text <- paste(text,text_uppräkning,", där andelen var upp emot ",round(extremer$Svarsfrekvens[1])," %. ",sep="")
  } else {
    svarsgrad_max <- slice(svarsgrad,which.max(Svarsfrekvens))
    text <- paste(text,"Högst bilinnehav återfanns i ",svarsgrad_max$Område,", med ",round(svarsgrad_max$Svarsfrekvens)," %. ",sep="")
}

extremer <- korkort_bil_extremer_låga
if (nrow(extremer)>1){ #om det finns extremer
  #slice(which.max(Svarsfrekvens))
  text <- paste(text,"Särskilt låg andel körkortsinnehavare återfanns i ")
  #Uppräkning av områden
  antal_uppräknade <- min(nrow(extremer),max_antal_uppräknade) #som minst räknas alla områden upp
  text_uppräkning <- paste(extremer$Område[1:(antal_uppräknade)], collapse = ', ') #sträng med områden
  text_uppräkning <- stri_replace_last_fixed(text_uppräkning, ', ', ' och ') #sätter "och" i slutet av uppräkningen
  text <- paste(text,text_uppräkning,", där andelen var ner emot ",round(extremer$Svarsfrekvens[1])," %. ",sep="")
  } else {
    svarsgrad_min <- slice(svarsgrad,which.min(Svarsfrekvens))
    text <- paste(text,"Lägst var bilinnehavet i ",svarsgrad_min$Område,", där andelen var nära ",round(svarsgrad_min$Svarsfrekvens)," %. ",sep="")
  }

```

I `r (rapportområde)` hade `r round(körkort_totalt)` procent av respondenterna körkort och `r round(biltillgång_totalt)` procent tillgång till bil. `r (text)`De som hade tillgång till bil varierade mellan  `r round(min(korkort_bil$"Biltillgång (%)"))` och `r round(max(korkort_bil$"Biltillgång (%)"))` procent. I Tabell \@ref(tab:korkort-bil-table) framgår körkortsinnehav och biltillgång för respektive område.


```{r korkort-bil-table, echo = FALSE, results = "asis"}
kbl(korkort_bil, caption = "Antal respondenter med körkort och biltillgång", booktabs = T, linesep = "",digits=0) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(korkort_bil), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

### Antal resor

```{r antal_resor, echo=FALSE, include=FALSE}

num_trips_per_pers <- rvu %>%
  select(respondentid) %>%
  group_by(respondentid) %>%
  summarize(num_trips = n())
  
befolkning_per_område <- pers %>%
  select(respondentid, kon) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(num_trips)) %>%
  left_join(respondent2omrade, by = c("respondentid" = "respondentid")) %>%
  group_by(Område,Område_kod) %>%
  summarize() %>%
  left_join(deso_befolkning, by = c("Område_kod" = "Område_kod")) 

vars <- c("Antal personer", "Resor per dag för alla personer")

num_trips_gender <- pers %>%
  select(respondentid, kon) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  group_by(kon) %>%
  summarize("Andel personer som rest (%)" = 100*sum(!is.na(num_trips)) / n(),
            "Resor per dag för alla personer" = sum(num_trips, na.rm = TRUE) / n(),
            "Resor per dag för personer som rest" = mean(num_trips, na.rm = TRUE)) %>%
  rename('Grupp' = kon) %>%
  mutate('Befolkning' = c(sum(befolkning_per_område$Kvinnor,na.rm = TRUE),sum(befolkning_per_område$Män,na.rm = TRUE),0),
         'Antal resor' = round(.data[["Befolkning"]] * .data[["Resor per dag för alla personer"]]))


num_trips_age <- pers %>%
  mutate(alder = ifelse(is.na(alder), "Ej angivet", alder)) %>%
  select(respondentid, alder) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  group_by(alder = cut(alder, breaks = c(12, 24, 64, 150))) %>%
  summarize("Andel personer som rest (%)" = 100*sum(!is.na(num_trips)) / n(),
            "Resor per dag för alla personer" = sum(num_trips, na.rm = TRUE) / n(),
            "Resor per dag för personer som rest" = mean(num_trips, na.rm = TRUE)) %>%
  mutate(alder = c("Mellan 15 och 24", "Mellan 25 och 64", "Mellan 65 och 85")) %>%
  rename('Grupp' = alder) %>%
  mutate('Befolkning' = c(sum(befolkning_per_område$Ålder_15_24,na.rm = TRUE),sum(befolkning_per_område$Ålder_25_64,na.rm = TRUE),sum(befolkning_per_område$Ålder_65,na.rm = TRUE)),
         'Antal resor' = round(.data[["Befolkning"]] * .data[["Resor per dag för alla personer"]]))

num_trips_all <- pers %>%
  select(respondentid) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  #group_by(kon) %>%
  summarize("Andel personer som rest (%)" = 100*sum(!is.na(num_trips)) / n(),
            "Resor per dag för alla personer" = sum(num_trips, na.rm = TRUE) / n(),
            "Resor per dag för personer som rest" = mean(num_trips, na.rm = TRUE)) %>%
  mutate('Grupp' = "Alla",
         'Befolkning' = sum(befolkning_per_område$Befolkning,na.rm = TRUE),
         'Antal resor' = round(.data[["Befolkning"]] * .data[["Resor per dag för alla personer"]]))

num_trips_rep <- num_trips_gender %>%
  rbind(num_trips_age) %>%
  rbind(num_trips_all)

num_trips_män <- num_trips_gender %>%
  filter(Grupp == "Man") %>%
  select("Resor per dag för alla personer")

num_trips_kvinnor <- num_trips_gender %>%
  filter(Grupp == "Kvinna") %>%
  select("Resor per dag för alla personer")

avvikelse <- abs((num_trips_män-num_trips_kvinnor)/(num_trips_kvinnor+num_trips_män))
if (num_trips_män > num_trips_kvinnor) {
  kön1 <- "män"
  kön2 <- "kvinnor"
} else {
  kön1 <- "kvinnor"
  kön2 <- "män"
}

konjunktion <- ""
if (avvikelse>0.032) {
  if (avvikelse>0.064) {
    text <- paste("I genomsnitt gjorde ",kön1," mycket fler resor än ",kön2,". ",sep="")
  } else {
    text <- paste("I genomsnitt gjorde ",kön1," något fler resor än ",kön2,". ",sep="")
  }} else {
    text <- paste("I genomsnitt reste både ",kön1," och ",kön2," i lika stor utsträckning. ",sep="")
    konjunktion <- "heller "
}

avvikelse <- sd(num_trips_age$"Resor per dag för alla personer", na.rm=TRUE)
if (avvikelse<0.1) {
  text <- paste(text,"De olika åldersgrupperna skilde sig inte ",konjunktion,"märkbart i antal resor per dag. ",sep="")
}

```

En genomsnittlig dag genomfördes `r round(num_trips_all$"Antal resor",0)` resor i `r (rapportområde)` av personer 15–85 år bosatta inom det undersökta utredningsområdet. I Tabell \@ref(tab:num-trips-table) framgår andel personer som rest och deras antal resor per dag redovisat per kön och ålderskategori.

```{r num-trips-table, echo = FALSE, results = "asis"}
# kbl(num_trips_gender, digits = 2, caption = "Antal resor per dag per kön", booktabs = T, linesep = "") %>%
#   kable_styling(latex_options = c("striped", "HOLD_position")) %>%
#   row_spec(0, bold = T, angle = 45) #gör rubrikraden fetstilt and titles angled for space
 
x <- kbl(num_trips_rep, digits = 1, longtable = T, booktabs = T, linesep = "",caption = "Antal resor per dag per kön") %>%
  #Captions appear to create problems with longtable package, gives error "mispaced align"
  #See here for solution, but don't know how to implement:
  #https://tex.stackexchange.com/a/205468
  kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header"),
                repeat_header_text = "\\textit{(fortsättning)}",
                repeat_header_continued = "\\textit{(Fortsätter på nästa sida...)}") %>%
  #row_spec(nrow(reslangd_per_omrade_rep), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) %>% #gör rubrikraden fetstilt
  column_spec(2:4, width = "2.5cm") %>%
  column_spec(1:1, width = "3cm") %>%
  column_spec(5:6, width = "1.6cm")

for (i in c(1:2)){
  x <- x %>%
    pack_rows(c('Kön','Ålder')[i], (i-1)*3+1, (i-1)*3+3,
              hline_after = TRUE)
}


 x <- x %>%
   pack_rows("Totalt", 7, 7,
             hline_after = TRUE,
             hline_before = TRUE)

x

```

 `r (text)`

### Resornas fördelning på färdsätt

```{r trips_person_mode, echo=FALSE, include=FALSE}

mode_per_pers <- rvu %>%
  select(respondentid, fardmedel.kat) %>%
  group_by(respondentid) %>%
  summarize(Bil = any(fardmedel.kat == "Bil", na.rm = TRUE),
            Tåg = any(fardmedel.kat == "Tåg", na.rm = TRUE),
            Buss = any(fardmedel.kat == "Buss", na.rm = TRUE),
            Cykel = any(fardmedel.kat == "Cykel", na.rm = TRUE),
            Gång = any(fardmedel.kat == "Gång", na.rm = TRUE),
            Övrigt = any(fardmedel.kat == "Annat" | fardmedel.kat == 7, na.rm = TRUE))

trip_mode <- pers %>%
  select(respondentid, Område)%>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(Område)) %>%
  group_by(Område) %>%
  summarize("Bil" = sum(Bil),
             "Tåg" = sum(Tåg),
             "Buss" = sum(Buss),
             "Cykel" = sum(Cykel),
             "Gång" = sum(Gång),
             "Övrigt" = sum(Övrigt),
             "Alla" = Bil + Tåg + Buss + Cykel + Gång + Övrigt) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt")))

trip_person_mode <- trip_mode %>%
  mutate("Bil" = 100*Bil / Alla,
          "Tåg" = 100*Tåg / Alla,
          "Buss" =  100*Buss / Alla,
          "Cykel" = 100*Cykel / Alla,
          "Gång" = 100*Gång / Alla,
         "Övrigt" = 100*Övrigt / Alla) %>%
  select(-Alla)

#Räknar ut vanligaste färdmedlet i respektive område
trip_person_mode_max <- trip_person_mode %>%
  mutate('max' = names(trip_person_mode)[2:7][max.col(trip_person_mode[2:7], "first")])

#Plockar ut det vanligaste färdmedlet totalt sett
mest_frekvent_färdmedel <- pull(trip_person_mode_max[nrow(trip_person_mode_max),"max"])

#Plockar ut det vanligaste färdmedlets andelar
mest_frekvent_andel <- pull(trip_person_mode[nrow(trip_person_mode),mest_frekvent_färdmedel])

#Skapar en lista med områden som har ett avvikande vanligaste färdmedel
avvikande_vanligaste_färdmedel <- trip_person_mode_max %>%
  filter(max != mest_frekvent_färdmedel)

#Filtrerar ut extremvärden för att kunna skriva om dem i texten.
trip_person_mode_extremer_höga <- extremer_höga(trip_person_mode,mest_frekvent_färdmedel)
trip_person_mode_extremer_låga <- extremer_låga(trip_person_mode,mest_frekvent_färdmedel)


#Producerar brödtext.
text <- paste(tolower(mest_frekvent_färdmedel)," är det vanligaste färdmedlet i ",rapportområde," och står för ",round(mest_frekvent_andel)," procent av alla resorna. ",sep="")

if (nrow(avvikande_vanligaste_färdmedel) > 0) {
  text <- paste(text,"I zon ",sep="")
  #Uppräkning av områden
  antal_uppräknade <- nrow(avvikande_vanligaste_färdmedel) #som minst räknas alla områden upp
  text_uppräkning <- paste(avvikande_vanligaste_färdmedel$Område[1:(antal_uppräknade)], collapse = ', ') #sträng med områden
  text_uppräkning <- stri_replace_last_fixed(text_uppräkning, ', ', ' och ') #sätter "och" i slutet av uppräkningen
  text <- paste(text,text_uppräkning," var dock ",avvikande_vanligaste_färdmedel$max[1]," det vanligaste färdmedlet. ",sep="")
} else{
  text <- paste(text," Detta är också det vanligaste färdmedlet i varje enskilt område. ")
}

#OBS hårdkodat med Bil, ska vara mest_frekvent_färdmedel
extremer <- trip_person_mode_extremer_höga
tabell <- trip_person_mode
if (nrow(extremer)>1){ #om det finns extremer
  text <- paste(text,"Särskilt högt var antalet ",mest_frekvent_färdmedel,"resor bland människor i ")
  #Uppräkning av områden
  antal_uppräknade <- min(nrow(extremer),max_antal_uppräknade) #som minst räknas alla områden upp
  text_uppräkning <- paste(extremer$Område[1:(antal_uppräknade)], collapse = ', ') #sträng med områden
  text_uppräkning <- stri_replace_last_fixed(text_uppräkning, ', ', ' och ') #sätter "och" i slutet av uppräkningen
  text <- paste(text,text_uppräkning,", där andelen var upp emot ",round(extremer$Bil[1])," %. ",sep="")
  } else {
    tabell_max <- slice(tabell,which.max(Bil))
    text <- paste(text,"Högst andel återfanns i ",tabell_max$Område,", med ",round(tabell_max$Bil)," %. ",sep="")
}

extremer <- trip_person_mode_extremer_låga
if (nrow(extremer)>1){ #om det finns extremer
  text <- paste(text,"Särskilt låg andel ",mest_frekvent_färdmedel,"resor återfanns i ")
  #Uppräkning av områden
  antal_uppräknade <- min(nrow(extremer),max_antal_uppräknade) #som minst räknas alla områden upp
  text_uppräkning <- paste(extremer$Område[1:(antal_uppräknade)], collapse = ', ') #sträng med områden
  text_uppräkning <- stri_replace_last_fixed(text_uppräkning, ', ', ' och ') #sätter "och" i slutet av uppräkningen
  text <- paste(text,text_uppräkning,", där andelen var ner emot ",round(extremer$Bil[1])," %. ",sep="")
  } else {
    tabell_min <- slice(tabell,which.min(Bil))
    text <- paste(text,"Lägst var andelen i ",tabell_min$Område,", där endast ",round(tabell_min$Bil)," % av resorna gjordes med ",tolower(mest_frekvent_färdmedel),". ",sep="")
  }

#För att kommentera antalet cykelresor
if (mest_frekvent_färdmedel != "Cykel") {
  andel_resor_cykel <- pull(trip_person_mode[nrow(trip_person_mode),"Cykel"])
  andel_resor_cykel_max <- slice(trip_person_mode,which.max(Cykel))
  text <- paste(text," Andelen cyklister var i genomsnitt ",round(andel_resor_cykel)," %. Högst andel cyklister återfanns i ",pull(andel_resor_cykel_max["Område"])," med en andel på ",round(pull(andel_resor_cykel_max["Cykel"]))," %. ")
}


```

I Figur \@ref(fig:omrade-diagram) framgår att `r (text)` I Tabell \@ref(tab:trips-mode-table) framgår antalet resenärer för respektive färdmedel och `r (nivå)`.

```{r trips-person-mode-table, echo = FALSE, results = "asis"}
kbl(trip_person_mode, digits = 0, caption = "Färdmedelsandelar per tätort", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_mode), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```


```{r trips-mode-table, echo = FALSE, results = "asis"}
kbl(trip_mode, caption = "Antal resor per färdmedel och område", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_mode), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt)
```

```{r omrade-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per område."}
#Percent stacked barchart
palett <- c("#5144d3","#53a17f","#3599d5","#e6ad00","#d57667","#9e1863")
trip_person_mode_plot<-trip_person_mode %>%
  gather(fard,andel,Bil:Övrigt,factor_key=TRUE) %>%
  mutate(andel=round(andel))
omrade_plot <- ggplot(data = trip_person_mode_plot, aes(fill =forcats::fct_rev(factor(fard)), x = andel, y = forcats::fct_rev(factor(Område)),label =andel)) + 
  geom_bar(position = "fill", stat = "identity")+
  geom_text(aes(label=ifelse(andel>3,andel," ")),size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett) + #färger
  labs(x="Andel",y="Område",fill="Färdmedel") +
  scale_x_continuous(labels = scales::percent)
omrade_plot
```

### Bakgrundfrågor

Nedan följer sammanställningar kopplade till respondenternas egenskaper.

```{r trips_gender, echo=FALSE, include=FALSE}

trip_mode_gender <- pers %>%
  select(respondentid, kon)%>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
   group_by(kon) %>%
   summarize("Bil" = sum(Bil, na.rm = TRUE),
             "Tåg" = sum(Tåg, na.rm = TRUE),
             "Buss" = sum(Buss, na.rm = TRUE),
             "Cykel" = sum(Cykel, na.rm = TRUE),
             "Gång" = sum(Gång, na.rm = TRUE),
             "Övrigt" = sum(Övrigt, na.rm = TRUE),
             "Alla" = Bil + Tåg + Buss + Cykel + Gång + Övrigt) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Totalt"))) %>%
  rename('Kön' = kon)

```

#### Färdsätt efter kön

Andelen kvinnor och män  i undersökningen är ungefär lika stora, X respektive Y procent. Hur 
de reser brukar skilja sig åt, så även i denna mätning. X åker mer bil men har färre förflytt-
ningar med färdmedel Y.

```{r kön-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per kön."}
#beräkna andel
trip_mode_gender_andel <- trip_mode_gender %>%
  mutate("Bil" = 100*Bil / Alla,
          "Tåg" = 100*Tåg / Alla,
          "Buss" =  100*Buss / Alla,
          "Cykel" = 100*Cykel / Alla,
          "Gång" = 100*Gång / Alla,
         "Övrigt" = 100*Övrigt / Alla) %>%
  select(-Alla)
#skapa Percent stacked barchart
temp_plot<-trip_mode_gender_andel %>%
  gather(Färdmedel,Andel,-Kön,factor_key=TRUE) %>%
  mutate(Andel=round(Andel))
gender_plot <- ggplot(data = temp_plot, aes(fill =forcats::fct_rev(factor(Färdmedel)), x = Andel, y = forcats::fct_rev(factor(Kön)),label =Andel)) +
  geom_bar(position = "fill", stat = "identity") +
  geom_text(aes(label=ifelse(Andel>3,Andel," ")),size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett) + #färger
  labs(x="Andel",y="Kön",fill="Färdmedel") +
  scale_x_continuous(labels = scales::percent)
gender_plot

```

```{r mode-gender-table, echo = FALSE, results = "asis"}
# kbl(trip_mode_gender, caption = "Färdmedel per kön", booktabs = T, linesep = "") %>%
#   kable_styling(latex_options = c("striped", "HOLD_position")) %>%
#   row_spec(nrow(trip_mode_gender), bold = T) %>% #gör Total-raden fetstilt
#   row_spec(0, bold = T) #gör rubrikraden fetstilt
```

#### Färdsätt efter ålder

```{r trips_age, echo=FALSE, include=FALSE}

trip_age <- pers %>%
  mutate(alder = ifelse(is.na(alder), "Ej angivet", alder)) %>%
  select(respondentid, alder) %>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(alder)) %>%
  group_by(alder = cut(alder, breaks = c(12, 17, 24, 39, 64, 74, 85))) %>%
  summarize("Bil" = sum(Bil, na.rm = TRUE),
             "Tåg" = sum(Tåg, na.rm = TRUE),
             "Buss" = sum(Buss, na.rm = TRUE),
             "Cykel" = sum(Cykel, na.rm = TRUE),
             "Gång" = sum(Gång, na.rm = TRUE),
             "Övrigt" = sum(Övrigt, na.rm = TRUE),
            "Alla" =Bil + Tåg + Buss + Cykel + Gång + Övrigt) %>%
  mutate(alder = c(
    "Mellan 15 och 18",
    "Mellan 18 och 24",
    "Mellan 25 och 39",
    "Mellan 40 och 64",
    "Mellan 65 och 74",
    "Mellan 75 och 85"
  )) %>%
  rename('Ålder' = alder) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Totalt")))

```

Åldersgruppen X år utgör X procent, gruppen Y år Y procent och åldersgruppen Z 
år Z procent av den undersökta befolkningen. I diagrammet nedan jämförs färdsättsanvänd-
ning i olika åldersgrupper. Färdsättet övrigt redovisas inte.

```{r ålder-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per åldersgrupp."}
#beräkna andel
trip_age_andel <- trip_age %>%
  mutate("Bil" = 100*Bil / Alla,
          "Tåg" = 100*Tåg / Alla,
          "Buss" =  100*Buss / Alla,
          "Cykel" = 100*Cykel / Alla,
          "Gång" = 100*Gång / Alla,
         "Övrigt" = 100*Övrigt / Alla) %>%
  select(-Alla)
#skapa Percent stacked barchart
temp_plot<-trip_age_andel %>%
  gather(Färdmedel,Andel,-Ålder,factor_key=TRUE) %>%
  mutate(Andel=round(Andel))
age_plot <- ggplot(data = temp_plot, aes(fill =forcats::fct_rev(factor(Färdmedel)), x = Andel, y = forcats::fct_rev(factor(Ålder)),label =Andel))  + 
  # scale_y_discrete(limits = rev(unique(temp_plot$Ålder))) +
  geom_bar(position = "fill", stat = "identity") +
  geom_text(aes(label=ifelse(Andel>3,Andel," ")),size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett) + #färger
  labs(x="Andel",y="Ålder",fill="Färdmedel") +
  scale_x_continuous(labels = scales::percent)
age_plot
```

```{r mode-age-table, echo = FALSE, results = "asis"}
# kbl(trip_age, caption = "Färdmedel per åldersgrupp", booktabs = T, linesep = "") %>%
#   kable_styling(latex_options = c("striped", "HOLD_position")) %>%
#   row_spec(nrow(trip_mode), bold = T) %>% #gör Total-raden fetstilt
#   row_spec(0, bold = T) #gör rubrikraden fetstilt
```


#### Färdsätt efter sysselsättning

```{r sysselsättning_analys, echo=FALSE, include = FALSE}
svarsnyckel <- labels_data %>%
  filter(question_id=="H2") %>%
  select(answer_id,answer)

# #Läser in fråga H2 om färdsätt och aggregerar
# rvu_sys <- rvu %>%
#     left_join(select(pers, c("respondentid","h2")), by = c("respondentid" = "respondentid")) %>% #Hämtar kolumn h2 från pers-data
#     select(resa_nr, respondentid, h2) %>%
#     left_join(svarsnyckel, by = c("h2" = "answer_id")) %>%
#     group_by(answer) %>%
#     summarise(antal = n())
#     
# top_sys <- rvu_sys %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==1)
# top_sys_2 <- rvu_sys %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==2)
# 
# top_sys <- top_sys$answer
# top_sys_2 <- top_sys_2$answer
# 
# rvu_sys_rep <- rvu_sys %>%
#     rename(
#         'Sysselsättning' = answer,
#         'Antal svar' = antal
#     )

```

```{r trip_sys_mode, echo=FALSE, include = FALSE}

trip_sys_mode <- rvu %>%
    left_join(select(pers, c("respondentid","h2")), by = c("respondentid" = "respondentid")) %>% #Hämtar kolumn h2 från pers-data %>%
    select(h2, fardmedel.kat) %>%
    filter(!is.na(fardmedel.kat)) %>%
    left_join(svarsnyckel, by = c("h2" = "answer_id")) %>%
    group_by(answer) %>%
    summarise("Bil" = sum(fardmedel.kat == "Bil", na.rm = TRUE),
              "Tåg" = sum(fardmedel.kat == "Tåg", na.rm = TRUE),
              "Buss" = sum(fardmedel.kat == "Buss", na.rm = TRUE),
              "Cykel" = sum(fardmedel.kat == "Cykel", na.rm = TRUE),
              "Gång" = sum(fardmedel.kat == "Gång", na.rm = TRUE),
              "Annat" = sum(fardmedel.kat == "Annat", na.rm = TRUE),
              "Total" = n()) %>%
    bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total"))) %>%
    rename("Sysselsättning" = answer)
```

I åldern 12–84 år är X procent förvärvsarbetande, X procent studerande, X procent är pensio-
närer och gruppen övriga utgör X procent av samtliga. Gruppen övrig sysselsättning består 
huvudsakligen av föräldralediga, arbetslösa, värnpliktiga och långtidssjukskrivna. Av de resor 
som genomförs av förvärvsarbetande är X procent bilresor, X procent bussresor, X procent cy-
kelresor och X procent förflyttningar till fots och X procent övrigt. Diagrammet visar att även 
att X av de som studerar cyklar och att ungefär var X pensionär cyklar. Gruppen övrigt 
har störst andel som förflyttat sig till fots, X procent.

```{r sys-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per sysselsättning"}
#beräkna andel
temp_plot<-trip_sys_mode
colnames(temp_plot)[which(names(temp_plot) == "Annat")] <- "Övrigt"
temp_plot <- temp_plot %>%
  mutate("Bil" = 100*Bil / Total,
          "Tåg" = 100*Tåg / Total,
          "Buss" =  100*Buss / Total,
          "Cykel" = 100*Cykel / Total,
          "Gång" = 100*Gång / Total,
         "Övrigt" = 100*Övrigt / Total) %>%
  select(-Total)

#skapa Percent stacked barchart 

temp_plot<-temp_plot %>%
  gather(Färdmedel,Andel,-Sysselsättning,factor_key=TRUE) %>%
  mutate(Andel=round(Andel))
sys_plot <- ggplot(data = temp_plot, aes(fill =forcats::fct_rev(factor(Färdmedel)), x = Andel, y = forcats::fct_rev(factor(Sysselsättning)),label =Andel)) +
  scale_y_discrete(limits = rev(unique(temp_plot$Sysselsättning))) + #Placerar ärendekategorierna i en bättre ordning
  geom_bar(position = "fill", stat = "identity") +
  geom_text(aes(label=ifelse(Andel>3,Andel," ")),size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett) + #färger
  labs(x="Andel",y="Sysselsättning",fill="Färdmedel") +
  scale_x_continuous(labels = scales::percent)
sys_plot

```

```{r trip-sys-mode-table, echo = FALSE, result="asis"}
# kable(trip_sys_mode, caption = "Resärende per färdmedel", booktabs = T, linesep = "") %>%
#   kable_styling(latex_options = c("striped", "HOLD_position")) %>%
#   row_spec(nrow(trip_sys_mode), bold = T) %>% #gör Total-raden fetstilt
#   row_spec(0, bold = T) #gör rubrikraden fetstilt)
```

#### Färdsätt efter ärende

```{r purpose_analysis, echo=FALSE, include = FALSE}
svarsnyckel_arende <- labels_data %>%
  filter(question_id=="B2_R1") %>%
  select(answer_id,answer)

rvu_purp <- rvu %>%
    select(resa_nr, respondentid, b2) %>%
    left_join(svarsnyckel_arende, by = c("b2" = "answer_id")) %>%
    group_by(answer) %>%
    summarise(antal = n())

top_purpose <- rvu_purp %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==1)
top_purpose_2 <- rvu_purp %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==2)

top_purpose <- top_purpose$answer
top_purpose_2 <- top_purpose_2$answer

rvu_purp_rep <- rvu_purp %>%
    rename(
        'Ärende' = answer,
        'Antal svar' = antal
    )

```

```{r trip_purpose_mode, echo=FALSE, include = FALSE}

trip_purpose_mode <- rvu %>%
    select(b2, fardmedel.kat) %>%
    filter(!is.na(fardmedel.kat)) %>%
    left_join(svarsnyckel_arende, by = c("b2" = "answer_id")) %>%
    group_by(answer) %>%
    summarise("Bil" = sum(fardmedel.kat == "Bil", na.rm = TRUE),
              "Tåg" = sum(fardmedel.kat == "Tåg", na.rm = TRUE),
              "Buss" = sum(fardmedel.kat == "Buss", na.rm = TRUE),
              "Cykel" = sum(fardmedel.kat == "Cykel", na.rm = TRUE),
              "Gång" = sum(fardmedel.kat == "Gång", na.rm = TRUE),
              "Annat" = sum(fardmedel.kat == "Annat", na.rm = TRUE),
              "Total" = n()) %>%
    bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total"))) %>%
    rename("Ärende" = answer)
```

Resor till bostaden utgör en stor del av alla resor. I denna mätning är andelen 38 procent och 
andelen som gjordes till arbete var 20 procent. Av de resor som gjordes av de som har haft arbete 
som ärende för resan är 40 procent bilresor, 14 procent bussresor, 36 procent cykelresor och sju 
procent är gångförflyttningar och tre procent övrigt.

```{r ärende-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per ärende"}
#beräkna andel
temp_plot<-trip_purpose_mode
colnames(temp_plot)[which(names(temp_plot) == "Annat")] <- "Övrigt"
temp_plot <- temp_plot %>%
  mutate("Bil" = 100*Bil / Total,
          "Tåg" = 100*Tåg / Total,
          "Buss" =  100*Buss / Total,
          "Cykel" = 100*Cykel / Total,
          "Gång" = 100*Gång / Total,
         "Övrigt" = 100*Övrigt / Total) %>%
  select(-Total)

#skapa Percent stacked barchart 

temp_plot<-temp_plot %>%
  gather(Färdmedel,Andel,-Ärende,factor_key=TRUE) %>%
  mutate(Andel=round(Andel))
purpose_plot <- ggplot(data = temp_plot, aes(fill =forcats::fct_rev(factor(Färdmedel)), x = Andel, y = forcats::fct_rev(factor(Ärende)),label =Andel)) +
  scale_y_discrete(limits = rev(unique(temp_plot$Ärende))) + #Placerar ärendekategorierna i en bättre ordning
  geom_bar(position = "fill", stat = "identity") +
  geom_text(aes(label=ifelse(Andel>3,Andel," ")),size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett) + #färger
  labs(x="Andel",y="Ärende",fill="Färdmedel") +
  scale_x_continuous(labels = scales::percent)
purpose_plot

```

```{r trip-purpose-mode-table, echo = FALSE, result="asis"}
# kable(trip_purpose_mode, caption = "Resärende per färdmedel", booktabs = T, linesep = "") %>%
#   kable_styling(latex_options = c("striped", "HOLD_position")) %>%
#   row_spec(nrow(trip_purpose_mode), bold = T) %>% #gör Total-raden fetstilt
#   row_spec(0, bold = T) #gör rubrikraden fetstilt)
```


### Reslängd och trafikarbete
```{r travel_dist, echo=FALSE, include = FALSE}

#Filtrerar data
reslangd <- rvu %>%
  filter(!is.na(avstand)) %>%
  rename(Färdmedel = fardmedel.kat) %>%
  select(respondentid,Färdmedel,avstand,Område,Område_kod)
  

#Räknar ut hur många individer som gör resor per område
antal_resande_individer <- rvu %>%
  group_by(Område) %>%
  summarise("Antal_resande_individer" = n_distinct(respondentid))

#Räknar ut hur många individer som inte gör någon resa
individer_utan_resa <- pers %>% #OBS i dagsläget saknar alla individer utan resa också område...
  group_by(Område) %>%
  summarise("Antal_individer" = n_distinct(respondentid)) %>%
  left_join(antal_resande_individer, by = c("Område" = "Område")) %>%
  mutate(Individer_utan_resa = Antal_individer-Antal_resande_individer) %>%
  select(Område,Individer_utan_resa) 

#Räknar ut hur många individer det finns per område
individer_per_område <- reslangd %>%
  group_by(Område) %>%
  summarise("Antal_individer" = n_distinct(respondentid)) %>%
  left_join(individer_utan_resa, by = c("Område" = "Område")) %>%
  mutate(Antal_individer = Antal_individer+Individer_utan_resa) %>%
  select(Område,Antal_individer) 

#Antal resor per individ (och område, färdmedel) räknas ut
resor_per_individ <- reslangd %>% #Resor per individ blir överskattat pga fel med att individer utan resa saknar bostadsort
  group_by(Område,Område_kod,Färdmedel) %>%
  summarise("Antal_observationer" = n()) %>%
  left_join(individer_per_område, by = c("Område" = "Område")) %>%
  mutate(Resor_per_individ = Antal_observationer/Antal_individer) %>%
  left_join(select(deso_befolkning, c(Område_kod,Befolkning)), by = c("Område_kod" = "Område_kod")) %>%
  mutate(Totalt_antal_resor = Befolkning*Resor_per_individ) %>%
  ungroup() %>%
  select(Område,Färdmedel,Totalt_antal_resor)

#Antal resor per individ (färdmedel) räknas ut
resor_per_individ_summa <- resor_per_individ %>%
  group_by(Färdmedel) %>%
  summarise("Totalt_antal_resor" = round(sum(Totalt_antal_resor,na.rm = TRUE),0))

#Räknar ut totalt
reslangd_summa_tot <- reslangd %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
  cbind(Färdmedel = "Totalt") %>%
  cbind(Område = "Alla") %>%
  mutate(Totalt_antal_resor = sum(resor_per_individ$Totalt_antal_resor,na.rm = TRUE)) %>%
  mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel)

#Räknar ut totalt per färdmedel
reslangd_summa <- reslangd %>%
  group_by(Färdmedel) %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
  mutate(Område = c("Alla")) %>%
  left_join(resor_per_individ_summa, by = c("Färdmedel" = "Färdmedel")) %>%
  mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel) %>%
  rbind(reslangd_summa_tot)

#Räknar ut totalt per färdmedel och område
reslangd_per_område <- reslangd %>%
  select(-one_of("Område_kod")) %>%
  group_by(Område,Färdmedel) %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
  left_join(resor_per_individ, by = c("Område" = "Område", "Färdmedel" = "Färdmedel")) %>%
  mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel)

#Antalet observationer som krävs för att data ska visas (global parameter)
tillräckligt_underlag <- 5

#Döljer värden som inte ska visas
reslangd_per_område <- reslangd_per_område %>%
  mutate(Median= ifelse(Antal_observationer < tillräckligt_underlag, NA, Median)) %>%
  mutate(Medel= ifelse(Antal_observationer < tillräckligt_underlag, NA, Medel)) %>%
  mutate(Totalt_antal_resor= ifelse(Antal_observationer < tillräckligt_underlag, NA, Totalt_antal_resor)) %>%
  mutate(Trafikarbete_totalt= ifelse(Antal_observationer < tillräckligt_underlag, NA, Trafikarbete_totalt))

#Exempel som ska kunna slå ihop celler... Vi bör nog använda kableExtra för att göra snyggare grafer...
#dt <- mtcars[1:10, 1:6]
#kable(dt, format = "latex", caption = "Group Rows", booktabs = T) %>%
#    kable_styling() %>%
#    group_rows("Group 1", 4, 7) %>%
#    group_rows("Group 2", 8, 10)

#kbl(reslangd_per_område, align = "c") %>%
#  kable_paper(full_width = F) %>%
#  column_spec(1, bold = T) %>%
#  collapse_rows(columns = 1:1)

reslangd_per_omrade_rep <- crossing(unique(reslangd$Område), unique(reslangd$Färdmedel)) %>% #creating combination of all Område and Färdmedel to have all rows in the table
  rename(Område = "unique(reslangd$Område)",
         Färdmedel = "unique(reslangd$Färdmedel)") %>%
  left_join(reslangd_per_område, by = c("Område", "Färdmedel")) %>%
  rbind(reslangd_summa) %>%
  mutate(
    Område = ifelse(is.na(Område), "Ej angivet", Område),
    Färdmedel = Färdmedel,
    Median = ifelse(is.na(Median), "-", round(Median/1000)),
    Medel = ifelse(is.na(Medel), "-", round(Medel/1000)),
    "Totalt antal resor" = ifelse(is.na(Totalt_antal_resor), "-", round(Totalt_antal_resor/100)*100),
    "Trafikarbete totalt" = ifelse(is.na(Trafikarbete_totalt), "-", round(Trafikarbete_totalt/1000)),
    "Antal observationer" = ifelse(is.na(Antal_observationer), 0, Antal_observationer)
  ) %>%
  select(-Antal_observationer,-Totalt_antal_resor,-Trafikarbete_totalt)

antal_omraden = unique(reslangd_per_omrade_rep$Område)

reslangd_per_omrade_rep <- reslangd_per_omrade_rep %>%
  select(-Område)
```

I resdagboken har intervjupersonerna fått fylla i plats för resmål, som sparats i staitisiken i form av koordinater. Dessa koordinater har använts för att uppskatta avstånd för varje resa med respektive färdmedel. Det partiella bortfallet på grund av avsaknade koordinater är X procent. I flera grupper är underlaget färre `r tolower(tillräckligt_underlag)` respondenter. För dessa har resultat utelämnats. Se Tabell...

```{r travel_dist-table1, echo = FALSE, results = "asis"}

x <- kbl(reslangd_per_omrade_rep, longtable = T, booktabs = T, linesep = "") %>%
  #Captions appear to create problems with longtable package, gives error "mispaced align"
  #See here for solution, but don't know how to implement:
  #https://tex.stackexchange.com/a/205468
  kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header"),
                repeat_header_text = "\\textit{(fortsättning)}",
                repeat_header_continued = "\\textit{(Fortsätter på nästa sida...)}") %>%
  row_spec(nrow(reslangd_per_omrade_rep), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt

for (i in c(1:(length(antal_omraden)-1))){
  x <- x %>%
    pack_rows(antal_omraden[i], (i-1)*5+1, (i-1)*5+5,
              hline_after = TRUE)
}

x <- x %>%
  pack_rows("Alla", (length(antal_omraden)-1)*5+1, (length(antal_omraden)-1)*5 + 6,
            hline_after = TRUE,
            hline_before = TRUE)

x

```

Andelen resor som genomförs med bil ökar ju längre resan är. Kollektivtrafiksresandet... Cykelandelen är som högst för resor på ca X km och sjunker sedan successivt med ökat avstånd. Gång-
andelen är som högst vid riktigt korta avstånd.

Nedan följer ett diagram som visar färdmedelsfördelnjing per reslängd.

```{r avstånds-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per avståndsklass."}
#Lägger till avståndsklass per resa
rvu_avs <- rvu %>%
  filter(!is.na(avstand)&avstand>0) %>%
  rename(Färdmedel = fardmedel.kat) %>%
  select(respondentid,Färdmedel,avstand,Område,Område_kod)
rvu_avs$km <- round(rvu_avs$avstand/1000)
rvu_avs <- rvu_avs %>%
  group_by(kmklass = cut(km, breaks = c(0, 2, 5, 10, 25, 50, 1000)))

#rvu_avs$kmklass<-ifelse(rvu_avs$km>32/4,32,rvu_avs$km*4)
rvu_avs$antal<-1

#Aggregerar avståndsklasser
agg_rvu_avs <-
  aggregate(rvu_avs[,c('antal'), drop=FALSE], by=list(
    avstand = rvu_avs$kmklass,
    fard = rvu_avs$Färdmedel
  ),
  FUN = sum) 
agg_rvu_avs<-spread(agg_rvu_avs,key=fard,value=antal)
agg_rvu_avs[is.na(agg_rvu_avs)]<-0
agg_rvu_avs$Total<-agg_rvu_avs$Bil+agg_rvu_avs$Buss+agg_rvu_avs$Tåg+agg_rvu_avs$Cykel+agg_rvu_avs$Gång
agg_rvu_avs <- agg_rvu_avs[c("avstand","Bil","Tåg","Buss","Cykel","Gång","Total")]
agg_rvu_avs <- mutate(agg_rvu_avs,avstand = c(
    "0-2",
    "2-5",
    "5-10",
    "10-25",
    "25-50",
    "50+"
  )) 


#Skapar ett procentuellt stapeldiagram
temp_plot <- agg_rvu_avs %>%
  mutate("Bil" = 100*Bil / Total,
         "Tåg" = 100*Tåg / Total,
         "Buss" =  100*Buss / Total,
         "Cykel" = 100*Cykel / Total,
         "Gång" = 100*Gång / Total) %>%
  select(-Total) %>%
  gather(Färdmedel,Andel,Bil:Gång,factor_key=TRUE) %>%
  mutate(Andel=round(Andel))
avstand_plot <- ggplot(data = temp_plot, aes(fill =forcats::fct_rev(factor(Färdmedel)), y = Andel, x = factor(avstand),label =Andel)) +
  geom_bar(position = "fill", stat = "identity") +
  geom_text(data=temp_plot[temp_plot$Andel>3,],size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett[-(1:1)]) + #färger
  labs(y="Andel",x="Avstånd (km)",fill="Färdmedel") +
  scale_y_continuous(labels = scales::percent)
avstand_plot
```
```{r avstånds-histogram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per avståndsklass."}

# agg_rvu_avs_hist <- agg_rvu_avs %>%
#   select(avstand,Total) %>%
#   mutate(avstand=as.factor(avstand))
# 
# agg_rvu_avs_histplot <- ggplot(agg_rvu_avs_hist, aes(avstand, Total, fill = avstand)) +
#     geom_bar(stat = "identity") +
#     rvu_theme() +
#     scale_fill_brewer(palette = "Set3") +
#     labs(
#         x = "Avstånd",
#         y = "Antal resor",
#         title = "Avståndsfördelning."
#     )
# 
# 
# agg_rvu_avs_histplot
```

#### Reserelationer inom `r (rapportområde)`

```{r od_matrix, echo=FALSE, include = FALSE}

minsta_antal <- 10

#Skapar od-matris för alla resor
od_matrix <- rvu %>%
    filter(start_tatort_namn == rapportområde & stop_tatort_namn == rapportområde) %>%
    select(start_deso, stop_deso) %>%
    filter(!is.na(start_deso)) %>%
    filter(!is.na(stop_deso)) %>%
    group_by(start_deso, stop_deso) %>%
    summarize(antal = n()) %>%
    pivot_wider(names_from = stop_deso, values_from = antal, values_fill = 0) %>%
    ungroup()

# #Sparar OD-matris som csv
# write.csv(od_matrix, "od_matrix.csv")

#Filtrerar ut populäraste områden på rader samt skapar total och övriga områden
od_matrix <- od_matrix%>%
    mutate("Totalt" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
    arrange(desc(Totalt))  %>%
    bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt"))) %>%
    top_n(minsta_antal)

#Filtrerar bort kolumner
lista_med_tätorter <- pull(od_matrix,start_deso)
od_matrix <- od_matrix %>%
  select(start_deso,lista_med_tätorter[1:minsta_antal-1],Totalt) %>%
  rename("Från tärort" = start_deso)


#Skapar procent-matris
od_matrix_perc <- as.data.frame(od_matrix) #konverterar till dataframe
rownames(od_matrix_perc) <- od_matrix_perc$"Från tärort" #Skapar indexkolumn
od_matrix_perc <- select(od_matrix_perc,!c("Från tärort")) #Tar bort gammal kolumn
od_matrix_perc <- rbind(od_matrix_perc[1:minsta_antal-1,])
od_matrix_perc <- round(od_matrix_perc/od_matrix_perc["Totalt","Totalt"]*100)

```

X procent av resorna sker inom `r (rapportområde)`. 
Den vanligaste förekommande resan inom ett område sker i X. Den vanligaste resan mellan två områden är från X till Y.
(Behöver generaliseras för att visa tätortsnivå om kommun-rapport och kommunnivå om regionrapport)

```{r od-matrix-table, echo = FALSE, result="asis"}
kable(od_matrix_perc, caption = "Fördelning av resorna inom tätorten.", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(0, bold = T, angle = 45) %>% #gör rubrikraden fetstilt)
  column_spec(1, bold = T, width = "2cm")
```
#### Reserelationer utanför `r (rapportområde)`

För resor utanför området sker dessa...
(Behöver generaliseras för att visa kommunnivå om kommun-rapport och regionnivå om regionrapport)

```{r od_matrix_extern, echo=FALSE, include = FALSE}

minsta_antal <- 10

#Skapar od-matris för alla resor
od_matrix <- rvu %>%
    select(start_tatort_namn, stop_tatort_namn) %>%
    filter(!is.na(start_tatort_namn)) %>%
    filter(!is.na(stop_tatort_namn)) %>%
    filter(!(start_tatort_namn == rapportområde & stop_tatort_namn == rapportområde)) %>%
    group_by(start_tatort_namn, stop_tatort_namn) %>%
    summarize(antal = n()) %>%
    pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0) %>%
    ungroup()

# #Sparar OD-matris som csv
# write.csv(od_matrix, "od_matrix.csv")

#Filtrerar ut populäraste områden på rader samt skapar total och övriga områden
od_matrix <- od_matrix %>%
    mutate("Totalt" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
    arrange(desc(Totalt)) %>%
    bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt"))) %>%
    top_n(minsta_antal) %>%
    bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Övriga områden")))

#Skapar övrigt-rad
od_matrix_övriga  <- 2*od_matrix[minsta_antal, -1]- od_matrix[minsta_antal+1,-1]
od_matrix_övriga <- mutate(od_matrix_övriga,start_tatort_namn="Övriga områden")
od_matrix <- rbind(od_matrix[1:minsta_antal-1,],od_matrix_övriga,od_matrix[minsta_antal,])

#Filtrerar bort kolumner
lista_med_tätorter <- pull(od_matrix,start_tatort_namn)
od_matrix <- od_matrix %>%
  select(start_tatort_namn,lista_med_tätorter[1:minsta_antal-1],Totalt) %>%
  rename("Från tärort" = start_tatort_namn) %>%
  mutate("Övriga områden" = -rowSums(select_if(., is.numeric), na.rm = TRUE)+2*Totalt) %>%
  relocate(Totalt, .after = "Övriga områden")


#Skapar procent-matris
od_matrix_perc <- as.data.frame(od_matrix)
rownames(od_matrix_perc) <- od_matrix_perc$"Från tärort"
od_matrix_perc <- select(od_matrix_perc,!c("Från tärort"))
od_matrix_perc <- rbind(od_matrix_perc[0:minsta_antal+1,])
od_matrix_perc <- round(od_matrix_perc/od_matrix_perc["Totalt","Totalt"]*100)

```

```{r od-matrix-extern-table, echo = FALSE, result="asis"}
kable(od_matrix_perc, caption = "Resor av invånare i Bålsta till och/eller från andra tätorter.", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(0, bold = T, angle = 45) %>% #gör rubrikraden fetstilt)
  column_spec(1, bold = T, width = "2cm")
```

# Kartor och bilagor

Här följer en karta och mer detaljerade tabeller.

## Ärendeanalys

I Tabell \@ref(tab:purpose-table) och Figur \@ref(fig:purpose-diagram) beskrivs vilka ärenden som respondenterna har svarat att de uppfylde med sina resor. Huvudärendet är `r tolower(top_purpose)` och andra mest populärt ärende är `r tolower(top_purpose_2)`.

```{r purpose-table, echo = FALSE, results = "asis"}
kable(rvu_purp_rep, caption = "Resärenden")

```

```{r distance_mode, echo=FALSE, include=FALSE}
rvu_distance_below_1 <- rvu %>% 
  select(avstand, fardmedel) %>%
  filter(!is.na(fardmedel)) %>%
  group_by(avstand = cut(avstand, breaks = c(0, 1000))) %>%
  summarize("Alla färdsätt" = n(),
            "Bil" = sum(fardmedel == 2),
            "Buss" = sum(fardmedel == 1),
            "Cykel" = sum(fardmedel == 4),
            "Gång" = sum(fardmedel == 5))
  
rvu_distance_below_3 <- rvu %>% 
  select(avstand, fardmedel) %>%
  filter(!is.na(fardmedel)) %>%
  group_by(avstand = cut(avstand, breaks = c(0, 3000))) %>%
  summarize("Alla färdsätt" = n(),
            "Bil" = sum(fardmedel == 2),
            "Buss" = sum(fardmedel == 1),
            "Cykel" = sum(fardmedel == 4),
            "Gång" = sum(fardmedel == 5))

rvu_distance_below_5 <- rvu %>% 
  select(avstand, fardmedel) %>%
  filter(!is.na(fardmedel)) %>%
  group_by(avstand = cut(avstand, breaks = c(0, 5000))) %>%
  summarize("Alla färdsätt" = n(),
            "Bil" = sum(fardmedel == 2),
            "Buss" = sum(fardmedel == 1),
            "Cykel" = sum(fardmedel == 4),
            "Gång" = sum(fardmedel == 5))
  
rvu_distance_below_10 <- rvu %>% 
  select(avstand, fardmedel) %>%
  filter(!is.na(fardmedel)) %>%
  group_by(avstand = cut(avstand, breaks = c(0, 10000))) %>%
  summarize("Alla färdsätt" = n(),
            "Bil" = sum(fardmedel == 2),
            "Buss" = sum(fardmedel == 1),
            "Cykel" = sum(fardmedel == 4),
            "Gång" = sum(fardmedel == 5))
  

rvu_distance <- bind_rows(slice(rvu_distance_below_1, 1), 
                          slice(rvu_distance_below_3, 1),
                          slice(rvu_distance_below_5, 1),
                          slice(rvu_distance_below_10, 1))
rvu_distance$avstand <- c("<=1km", "<=3km", "<=5km", "<=10km") 
rvu_distance <- rvu_distance %>% rename("Reslängd" = avstand)

              
```

```{r distance-mode-table, echo = FALSE, results = "asis"}
kable(rvu_distance, caption = "Reslängd per färdsätt", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

```{r purpose-diagram, echo = FALSE, results = "asis", fig.cap = "Antal resor per ärende."}
purp_barplot <- ggplot(rvu_purp, aes(answer, antal, fill = answer)) + 
    geom_bar(stat = "identity") +
    rvu_theme() +
    coord_cartesian(xlim = c(0,15)) +
    scale_fill_brewer(palette = "Set3") + 
    labs(
        x = "Ärende",
        y = "Antal svar",
        title = "Antal resor per ärende"
    )
    

purp_barplot

```

```{r trip_purpose_area, echo=FALSE, include = FALSE}
trip_purpose_all <- rvu %>%
  select(respondentid, b2) %>%
  filter(!is.na(b2)) %>%
  left_join(svarsnyckel_arende, by = c("b2" = "answer_id")) %>%
  left_join(pers %>%
              select(respondentid, Område),
            by = c("respondentid" = "respondentid")) %>%
  mutate(value = 1) %>%
  mutate(index = 1:nrow(rvu%>%filter(!is.na(b2)))) %>%
  spread(answer, value, fill=0) 

trip_purpose_area <- trip_purpose_all %>%
  filter(!is.na(b2)) %>%
  group_by(Område) %>%
  summarize(.,
            across(c(3:ncol(trip_purpose_all)-1), sum),
            total = n()) %>%
  select(-index, -b2) #%>%
#  rename("Område" = bostad_deso)
  
```

```{r trip-purpose-area-table, echo = FALSE, results = "asis"}
kable(trip_purpose_area, caption = "Resärende per område", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(0, bold = T, angle = 60) %>% #gör rubrikraden fetstilt
  column_spec(1, width = "2cm")

write.csv(trip_purpose_area, "trip_purpose_area.csv")

```

```{r trip_purpose_area_percent, echo=FALSE, include = FALSE}
trip_purpose_area_percent <- trip_purpose_all %>%
  filter(!is.na(b2)) %>%
  group_by(Område) %>%
  summarize(.,
            across(c(4:ncol(trip_purpose_all)-1), ~sum(.x) / n()),
            total = n()) %>%
  mutate(across(c(4:ncol(trip_purpose_all)-2), ~percent(.x, accuracy = 1))) %>%
  select(-index) #%>%
#  rename("Område" = bostad_deso)
```

```{r trip-purpose-area-percent-table, echo = FALSE, results = "asis"}
kable(trip_purpose_area_percent, caption = "Resärende per område (procent)", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(0, bold = T, angle = 60) %>% #gör rubrikraden fetstilt
  column_spec(1,width = "2cm")

write.csv(trip_purpose_area, "trip_purpose_area_percent.csv")
```

```{r drivers_license_area, echo=FALSE, include = FALSE}
drivers_license_area <- pers %>%
  select(Område, h4) %>%
  filter(!is.na(h4)) %>%
  group_by(Område) %>%
  summarize("Ja" = sum(h4 == 1, na.rm = TRUE) / n(),
            "Nej" = sum(h4 == 2, na.rm = TRUE) / n(),
            "Ospecificerat" = sum(h4 == 3, na.rm = TRUE),
            "Totalt antal tillfrågade" = n()) %>%
  mutate(across(c(2,3), ~percent(.x, accuracy = 1)))  #%>%
#  rename("Område" = bostad_deso)
```

```{r drivers-license-area-table, echo = FALSE, results = "asis"}
kable(drivers_license_area, caption = "Körkortsinnehav per område", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  #row_spec(nrow(drivers_license_area), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

```{r car_ownership_area, echo=FALSE, include = FALSE}
car_ownership_area <- pers %>%
  select(Område, h5) %>%
  filter(!is.na(h5)) %>%
  group_by(Område) %>%
  summarize("Ja" = (sum(h5 == 1, na.rm = TRUE) + sum(h5 == 2, na.rm = TRUE) + sum(h5 == 3, na.rm = TRUE) + sum(h5 == 4, na.rm = TRUE)) / n(),
            "Nej" = sum(h5 == 5, na.rm = TRUE) / n(),
            "Ospecificerat" = sum(h5 == 6, na.rm = TRUE),
            "Totalt antal tillfrågade" = n()) %>%
  mutate(across(c(2,3), ~percent(.x, accuracy = 1)))# %>%
#  rename("Område" = bostad_deso)
```

```{r car-ownership-area-table, echo = FALSE, results = "asis"}
kable(car_ownership_area, caption = "Bilinnehav per område", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  #row_spec(nrow(drivers_license_area), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt)
```




