---
title: "test_rvu_v1.1"
author: "WSP"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output:
  bookdown::pdf_document2: default
header-includes:
  - \renewcommand{\figurename}{Figur }
  - \makeatletter
  - \def\fnum@figure{\figurename\thefigure}
  - \makeatother
  - \renewcommand{\tablename}{Tabell }
  - \makeatletter
  - \def\tnum@table{\tablename\thetable}
  - \makeatother
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}

---

# Resvaneundersökning Bålsta

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(ggplot2)
library(tidyverse)
library(readxl)
library(bookdown)
library(pxweb)
library(scales)
```

```{r plot-theme-creation, include = FALSE}
rvu_theme <- function() {
    theme(
        plot.title = element_text(colour = "steelblue", face = "bold"),
        plot.background = element_rect(fill = "white"),
        # add border 1)
        panel.border = element_rect(colour = "blue", fill = NA, linetype = 1),
        # color background 2)
        panel.background = element_rect(fill = "aliceblue"),
        # modify grid 3)
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y =  element_line(colour = "steelblue", linetype = 3, size = 0.5),
        panel.grid.minor.y = element_blank(),
        # modify text, axis and colour 4) and 5)
        axis.title.y = element_text(colour = "steelblue"),
        axis.title.x = element_text(colour = "steelblue"),
        axis.line.x = element_blank(),
        axis.text.y = element_text(colour = "steelblue", face = "italic"),
        axis.text.x = element_blank(),
        axis.ticks.y = element_line(colour = "steelblue"),
        axis.ticks.x = element_blank(),
        # legend at the bottom 6)
        legend.position = "right",
        legend.title = element_blank(),
        legend.background = element_rect(colour = "steelblue", fill = "aliceblue")
    )
}

options(knitr.table.format = "latex")

```

```{r read_data, echo=FALSE, include = FALSE}

rvu <- read_delim("rvu_sample_2021-08-09.csv", ";", escape_double = FALSE, 
                    locale = locale(encoding = "ISO-8859-1"), 
                    trim_ws = TRUE)

pers <- read_delim("person_sample_2021-08-09.csv", ";", escape_double = FALSE, 
                     locale = locale(encoding = "ISO-8859-1"), 
                     trim_ws = TRUE)

avst <- read_delim("rvu_restid_sample_2021-08-09.csv", ";", escape_double = FALSE, 
                     locale = locale(encoding = "ISO-8859-1"), 
                     trim_ws = TRUE) %>%
  select(respondentid, resa_nr, distance_straight_line, distance_google)

#joina avstånd till resor
rvu <- rvu %>%
  left_join(avst, by = c("respondentid", "resa_nr")) %>%
  mutate(avstand = distance_google) %>%
  mutate(fardmedel.kat = ifelse(fardmedel.kat == "Kollektiv_buss","Buss",fardmedel.kat)) %>%
  mutate(fardmedel.kat = ifelse(fardmedel.kat == "Kollektiv_tåg","Tåg",fardmedel.kat))

#ett viktad medelvärde för året då RVU genomfördes för att få rätt befolkningsdata från SCB API
rvu_yr <- pers %>% group_by(ar) %>% summarise(resp_in_year = n()) %>% 
  summarise(avg_year = weighted.mean(ar, resp_in_year)) %>% 
  round() %>% as.character()

# Hämtar befolkningsdata per DESO-område från SCBs API
table_api_address = "http://api.scb.se/OV0104/v1/doris/en/ssd/BE/BE0101/BE0101Y/FolkmDesoAldKonN"

pxweb_query_list <- 
    list("Region"=c('*'), # Use "*" to select all
         "Alder" = c('15-19','20-24','25-29','30-34','35-39','40-44','45-49','50-54','55-59','60-64','65-69','70-74','75-79','80-'),
         "Kon"=c('1','2'), #1:man, 2:kvinna
         "ContentsCode"=c('000005FF'), #table name in SCB webpage
         "Tid"=c(rvu_yr))
px_query <- pxweb_query(pxweb_query_list)

px_data <- pxweb_get(table_api_address,
                 px_query)

deso_befolkning <- as.data.frame(px_data, column.name.type = "text", variable.value.type = "text") %>%
#kolumnerna ska heta: region (chr), citizenship (chr), sex (chr), year (chr), Population per region (chr) %>%
  mutate(region = str_trim(region, side = "left")) %>% #removing blank character
  rename(Område = region,
         Ålder = age,
         Kön = sex,
         Befolkning = "Population per region") %>%
  select(Område, Ålder, Kön, Befolkning)

deso_befolkning <- deso_befolkning %>%
  mutate(Män = ifelse(Kön == "men", Befolkning, 0),
         Kvinnor = ifelse(Kön == "women", Befolkning, 0),
         Ålder_15_24 = ifelse(strtoi(str_sub(Ålder,1,2)) < 25, Befolkning, 0),
         Ålder_25_64 = ifelse(strtoi(str_sub(Ålder,1,2)) > 20 & Ålder < 65, Befolkning, 0),
         Ålder_65 = ifelse(strtoi(str_sub(Ålder,1,2)) > 60, Befolkning, 0)) %>%
  group_by(Område) %>%
  summarise(Befolkning = sum(Befolkning), Män = sum(Män), Kvinnor = sum(Kvinnor), "Ålder_15_24" = sum(Ålder_15_24), "Ålder_25_64" = sum(Ålder_25_64), "Ålder_65" = sum(Ålder_65))

#Definierar om respondenter ska delas upp på kommun, tätort eller deso-nivå:
#pers <- mutate(pers,Område = bostad_kommun_namn)
#pers <- mutate(pers,Område = bostad_tatort_namn)
pers <- mutate(pers,Område = bostad_deso)


respondent2område <- pers %>%
  select(respondentid, Område) %>%
  left_join(deso_befolkning, by = c("Område" = "Område"))

rvu <- rvu %>%
  left_join(respondent2område, by = c("respondentid" = "respondentid"))

#Funkar inte...
#rvu <- rvu %>%
#  left_join(respondent2område, by = c("respondentid" = "respondentid")) %>%
#  select(respondentid)

#Lookup-table för att hämta klartext
variable_data <- read_excel("Variable information + Variable Values 2021-05-28.xlsx",
                            sheet = "Variable Labels", skip = 1, col_names = TRUE)
labels_data <- read_excel("Variable information + Variable Values 2021-05-28.xlsx",
                          sheet = "Value Labels", skip = 1, col_names = TRUE)


labels_data <- labels_data %>%
  rename(answer_id=...2,answer=Label,question_id=Value) %>%
  mutate(answer_id = as.numeric(str_remove(str_replace(answer_id, ",", "."),"a"))) %>% #Obs finns NA-observationer
  mutate(question_num=cumsum(!is.na(question_id)))

#Skapar nyckel mellan fråge-id och frågenummer
nyckel <- labels_data %>%
  select(question_id, question_num) %>%
  filter(!is.na(question_id))

#Skapar koppling mellan fråge-ID, svars-ID och svaret
labels_data <- labels_data %>%
  select(answer_id,answer, question_num) %>%
  left_join(nyckel, by = "question_num") %>%
  select(question_id,answer_id,answer)


```

## Sammanfattning

### Antal resor

```{r respondant_details, echo=FALSE, include = FALSE}
pers_group <- pers %>%
  mutate(Område = ifelse(is.na(Område), "Ej angivet", Område)) %>%
  select(Område, kon, alder) %>%
  group_by(Område) %>%
  summarize(Respondenter = n(),
            Man = sum(kon == "Man"), 
            Kvinnor = sum(kon == "Kvinna"),
            "15-24 år" = sum(alder >= 15 & alder < 25),
            "25-64 år" = sum(alder >= 25 & alder < 65),
            "65+ år" = sum(alder >= 65)) %>%
  left_join(select(deso_befolkning, c(Område,Befolkning)), by = c("Område" = "Område")) %>% #Lägger till befolkning per zon
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt")))


```


```{r repondant-table, echo = FALSE, results = "asis"}
#kable(pers_group, caption = "Antal svar per kön och åldersgrupp")
kbl(pers_group, caption = "Antal svar per kön och åldersgrupp", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(pers_group), bold = T) %>% #making the Total row bold
  row_spec(0, bold = T) #making the header row bold
```



### Färdmedelsfördelning

### Trafikarbete

### Fördelning mellan män och kvinnor

### Fördelning mellan ålderskategorier

### Vanligaste målpunkterna

## Inledning

### Metod

Hur dokumentet är skapat och generellt om kollbar

### Population och urval

Sammanfattning av SCB:s populationsdata, antal respondenter osv Tabell med antal boende och antal respondenter

## Resultat

### Körkort och biltillgång


```{r korkort, echo=FALSE, include=FALSE}
drivers_license <- pers %>%
  mutate(Område = ifelse(is.na(Område), "Ej angivet", Område)) %>%
  select(Område, h4, h5) %>%
  group_by(Område) %>%
  summarize(Körkort = sum(na.omit(h4) == 1),
            Biltillgång = sum(h5 == 1) + sum(h5 == 2) + sum(h5 == 3) + sum(h5 == 4)) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt")))

```

Tabell med körkort och bilinnehav

```{r korkort-table, echo = FALSE, results = "asis"}
kbl(drivers_license, caption = "Antal respondenter med körkort och biltillgång", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(drivers_license), bold = T) %>% #making the Total row bold
  row_spec(0, bold = T) #making the Header row bold

```

### Antal resor

```{r antal_resor, echo=FALSE, include=FALSE}

num_trips_per_pers <- rvu %>%
  select(respondentid) %>%
  group_by(respondentid) %>%
  summarize(num_trips = n())
  
befolkning_per_område <- pers %>%
  select(respondentid, kon) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(num_trips)) %>%
  left_join(respondent2område, by = c("respondentid" = "respondentid")) %>%
  group_by(Område) %>%
  summarize() %>%
  left_join(deso_befolkning, by = c("Område" = "Område")) 

vars <- c("Antal personer", "Resor per dag för alla personer")

num_trips_gender <- pers %>%
  select(respondentid, kon) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  group_by(kon) %>%
  summarize("Andel personer som rest" = sum(!is.na(num_trips)) / n(),
            "Resor per dag för alla personer" = sum(num_trips, na.rm = TRUE) / n(),
            "Resor per dag för personer som rest" = mean(num_trips, na.rm = TRUE)) %>%
  rename('Kön' = kon) %>%
  mutate('Befolkning' = c(sum(befolkning_per_område$Kvinnor,na.rm = TRUE),sum(befolkning_per_område$Män,na.rm = TRUE),0),
         'Antal resor' = round(.data[["Befolkning"]] * .data[["Resor per dag för alla personer"]]))


num_trips_age <- pers %>%
  mutate(alder = ifelse(is.na(alder), "Ej angivet", alder)) %>%
  select(respondentid, alder) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  group_by(alder = cut(alder, breaks = c(12, 24, 64, 150))) %>%
  summarize("Andel personer som rest" = sum(!is.na(num_trips)) / n(),
            "Resor per dag för alla personer" = sum(num_trips, na.rm = TRUE) / n(),
            "Resor per dag för personer som rest" = mean(num_trips, na.rm = TRUE)) %>%
  mutate(alder = c("Mellan 15 och 24", "Mellan 25 och 64", "Mellan 65 och 84")) %>%
  rename('Ålder' = alder) %>%
  mutate('Befolkning' = c(sum(befolkning_per_område$Ålder_15_24,na.rm = TRUE),sum(befolkning_per_område$Ålder_25_64,na.rm = TRUE),sum(befolkning_per_område$Ålder_65,na.rm = TRUE)),
         'Antal resor' = round(.data[["Befolkning"]] * .data[["Resor per dag för alla personer"]]))

```

Tabell med andel personer som rest och deras antal resor per dag redovisat per kön och ålderskategori

```{r num-trips-gender-table, echo = FALSE, results = "asis"}
kbl(num_trips_gender, digits = 2, caption = "Antal resor per dag per kön", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(0, bold = T, angle = 45) #making the Header row bold and titles angled for space
  

```

```{r num-trips-age-table, echo = FALSE, results = "asis"}
kbl(num_trips_age, digits = 2, caption = "Antal resor per dag per åldersgrupp", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(0, bold = T, angle = 45) #making the Header row bold and titles angled for space

```


### Resornas fördelning på färdsätt

```{r trips_person_mode, echo=FALSE, include=FALSE}

mode_per_pers <- rvu %>%
  select(respondentid, fardmedel.kat) %>%
  group_by(respondentid) %>%
  summarize(Bil = any(fardmedel.kat == "Bil", na.rm = TRUE),
            Tåg = any(fardmedel.kat == "Kollektiv_tåg", na.rm = TRUE),
            Buss = any(fardmedel.kat == "Kollektiv_buss", na.rm = TRUE),
            Cykel = any(fardmedel.kat == "Cykel", na.rm = TRUE),
            Gång = any(fardmedel.kat == "Gång", na.rm = TRUE),
            Övrigt = any(fardmedel.kat == "Annat" | fardmedel.kat == 7, na.rm = TRUE),
            made_trip = !is.na(fardmedel.kat))


trip_person_mode <- pers %>%
  select(respondentid, Område)%>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(Område), made_trip) %>%
  group_by(Område) %>%
   summarize("Bil" = sum(Bil),
             "Tåg" = sum(Tåg),
             "Buss" = sum(Buss),
             "Cykel" = sum(Cykel),
             "Gång" = sum(Gång),
             "Övrigt" = sum(Övrigt),
             "Alla" = Bil + Tåg + Buss + Cykel + Gång + Övrigt) %>%
  mutate("Bil" = Bil / Alla,
          "Tåg" = Tåg / Alla,
          "Buss" =  Buss / Alla,
          "Cykel" = Cykel / Alla,
          "Gång" = Gång / Alla,
         "Övrigt" = Övrigt / Alla) %>%
  select(-Alla)
```

Tabell/diagram med färdmedelsandelar per område


```{r trips-person-mode-table, echo = FALSE, results = "asis"}
kbl(trip_person_mode, digits = 2, caption = "Färdmedelsandelar per tätort", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(0, bold = T) #making the Header row bold
```

```{r trips_mode, echo=FALSE, include=FALSE}

trip_mode <- pers %>%
  select(respondentid, Område)%>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(Område)) %>%
  group_by(Område) %>%
  summarize("Bil" = sum(Bil),
             "Tåg" = sum(Tåg),
             "Buss" = sum(Buss),
             "Cykel" = sum(Cykel),
             "Gång" = sum(Gång),
             "Övrigt" = sum(Övrigt)) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt")))


```

```{r trips-mode-table, echo = FALSE, results = "asis"}
kbl(trip_mode, caption = "Färdmedel per tätort", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_mode), bold = T) %>% #making the Total row bold
  row_spec(0, bold = T) #making the Header row bold)
```

### Bakgrundfrågor

#### Färdsätt efter kön

```{r trips_gender, echo=FALSE, include=FALSE}

trip_mode_gender <- pers %>%
  select(respondentid, kon)%>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
   group_by(kon) %>%
   summarize("Bil" = sum(Bil, na.rm = TRUE),
             "Tåg" = sum(Tåg, na.rm = TRUE),
             "Buss" = sum(Buss, na.rm = TRUE),
             "Cykel" = sum(Cykel, na.rm = TRUE),
             "Gång" = sum(Gång, na.rm = TRUE),
             "Övrigt" = sum(Övrigt, na.rm = TRUE)) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Totalt"))) %>%
  rename('Kön' = kon)

```

Tabell/diagram med färdsätt efter kön.

```{r mode-gender-table, echo = FALSE, results = "asis"}
kbl(trip_mode_gender, caption = "Färdmedel per kön", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_mode_gender), bold = T) %>% #making the Total row bold
  row_spec(0, bold = T) #making the Header row bold
```

#### Färdsätt efter ålder

```{r trips_age, echo=FALSE, include=FALSE}

trip_age <- pers %>%
  mutate(alder = ifelse(is.na(alder), "Ej angivet", alder)) %>%
  select(respondentid, alder) %>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(alder)) %>%
  group_by(alder = cut(alder, breaks = c(12, 17, 24, 39, 64, 74, 84, 150))) %>%
  summarize("Bil" = sum(Bil, na.rm = TRUE),
             "Tåg" = sum(Tåg, na.rm = TRUE),
             "Buss" = sum(Buss, na.rm = TRUE),
             "Cykel" = sum(Cykel, na.rm = TRUE),
             "Gång" = sum(Gång, na.rm = TRUE),
             "Övrigt" = sum(Övrigt, na.rm = TRUE)) %>%
  mutate(alder = c(
    "Yngre än 18",
    "Mellan 18 och 24",
    "Mellan 25 och 39",
    "Mellan 40 och 64",
    "Mellan 65 och 74",
    "Mellan 75 och 84",
    "Äldre än 85"
  )) %>%
  rename('Ålder' = alder)

```

Tabell/diagram med färdsätt efter ålder, 12-17 år, 18-24 år, 25-39 år, 40-64 år, 65-74 år, 75-84 år

```{r mode-age-table, echo = FALSE, results = "asis"}
kbl(trip_age, caption = "Färdmedel per åldersgrupp", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(0, bold = T) #making the Header row bold
```


#### Färdsätt efter sysselsättning

Tabell/diagram med färdsätt efter sysselsättning

#### Färdsätt efter ärende

Tabell/diagram med färdsätt efter ärende

### Reslängd och trafikarbete
```{r travel_dist, echo=FALSE, include = FALSE}

#Filtrerar data och lägger till områdeskolumn
reslangd <- rvu %>%
  filter(!is.na(avstand)) %>%
  rename(Färdmedel = fardmedel.kat) %>%
  select(respondentid,Färdmedel,avstand,Område)
  

#Räknar ut hur många individer som gör resor per område
antal_resande_individer <- rvu %>%
  group_by(Område) %>%
  summarise("Antal_resande_individer" = n_distinct(respondentid))

#Räknar ut hur många individer som inte gör någon resa
individer_utan_resa <- pers %>% #OBS i dagsläget saknar alla individer utan resa också område...
  group_by(Område) %>%
  summarise("Antal_individer" = n_distinct(respondentid)) %>%
  left_join(antal_resande_individer, by = c("Område" = "Område")) %>%
  mutate(Individer_utan_resa = Antal_individer-Antal_resande_individer) %>%
  select(Område,Individer_utan_resa) 

#Räknar ut hur många individer det finns per område
individer_per_område <- reslangd %>%
  group_by(Område) %>%
  summarise("Antal_individer" = n_distinct(respondentid)) %>%
  left_join(individer_utan_resa, by = c("Område" = "Område")) %>%
  mutate(Antal_individer = Antal_individer+Individer_utan_resa) %>%
  select(Område,Antal_individer) 

#Antal resor per individ (och område, färdmedel) räknas ut
resor_per_individ <- reslangd %>% #Resor per individ blir överskattat pga fel med att individer utan resa saknar bostadsort
  group_by(Område,Färdmedel) %>%
  summarise("Antal_observationer" = n()) %>%
  left_join(individer_per_område, by = c("Område" = "Område")) %>%
  mutate(Resor_per_individ = Antal_observationer/Antal_individer) %>%
  left_join(select(deso_befolkning, c(Område,Befolkning)), by = c("Område" = "Område")) %>%
  mutate(Totalt_antal_resor = Befolkning*Resor_per_individ) %>%
  select(Område,Färdmedel,Totalt_antal_resor) 

#Antal resor per individ (färdmedel) räknas ut
resor_per_individ_summa <- resor_per_individ %>%
  group_by(Färdmedel) %>%
  summarise("Totalt_antal_resor" = round(sum(Totalt_antal_resor,na.rm = TRUE),0))

#Räknar ut totalt
reslangd_summa_tot <- reslangd %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
  cbind(Färdmedel = "Totalt") %>%
  cbind(Område = "Alla") %>%
  mutate(Totalt_antal_resor = sum(resor_per_individ$Totalt_antal_resor,na.rm = TRUE)) %>%
  mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel)

#Räknar ut totalt per färdmedel
reslangd_summa <- reslangd %>%
  group_by(Färdmedel) %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
  mutate(Område = c("Alla")) %>%
  left_join(resor_per_individ_summa, by = c("Färdmedel" = "Färdmedel")) %>%
  mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel) %>%
  rbind(reslangd_summa_tot)

#Räknar ut totalt per färdmedel och område
reslangd_per_område <- reslangd %>%
  group_by(Område,Färdmedel) %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
  left_join(resor_per_individ, by = c("Område" = "Område", "Färdmedel" = "Färdmedel")) %>%
  mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel)

#Antalet observationer som krävs för att data ska visas (global parameter)
tillräckligt_underlag <- 5

#Döljer värden som inte ska visas
reslangd_per_område <- reslangd_per_område %>%
  mutate(Median= ifelse(Antal_observationer < tillräckligt_underlag, NA, Median)) %>%
  mutate(Medel= ifelse(Antal_observationer < tillräckligt_underlag, NA, Medel)) %>%
  mutate(Totalt_antal_resor= ifelse(Antal_observationer < tillräckligt_underlag, NA, Totalt_antal_resor)) %>%
  mutate(Trafikarbete_totalt= ifelse(Antal_observationer < tillräckligt_underlag, NA, Trafikarbete_totalt))

#Exempel som ska kunna slå ihop celler... Vi bör nog använda kableExtra för att göra snyggare grafer...
#dt <- mtcars[1:10, 1:6]
#kable(dt, format = "latex", caption = "Group Rows", booktabs = T) %>%
#    kable_styling() %>%
#    group_rows("Group 1", 4, 7) %>%
#    group_rows("Group 2", 8, 10)

#kbl(reslangd_per_område, align = "c") %>%
#  kable_paper(full_width = F) %>%
#  column_spec(1, bold = T) %>%
#  collapse_rows(columns = 1:1)

reslangd_per_omrade_rep <- crossing(unique(reslangd$Område), unique(reslangd$Färdmedel)) %>% #creating combination of all Område and Färdmedel to have all rows in the table
  rename(Område = "unique(reslangd$Område)",
         Färdmedel = "unique(reslangd$Färdmedel)") %>%
  left_join(reslangd_per_område, by = c("Område", "Färdmedel")) %>%
  rbind(reslangd_summa) %>%
  mutate(
    Område = ifelse(is.na(Område), "Ej angivet", Område),
    Färdmedel = Färdmedel,
    Median = ifelse(is.na(Median), "-", round(Median/1000)),
    Medel = ifelse(is.na(Medel), "-", round(Medel/1000)),
    "Totalt antal resor" = ifelse(is.na(Totalt_antal_resor), "-", round(Totalt_antal_resor/100)*100),
    "Trafikarbete totalt" = ifelse(is.na(Trafikarbete_totalt), "-", round(Trafikarbete_totalt/1000)),
    "Antal observationer" = ifelse(is.na(Antal_observationer), 0, Antal_observationer)
  ) %>%
  select(-Antal_observationer,-Totalt_antal_resor,-Trafikarbete_totalt)

antal_omraden = unique(reslangd_per_omrade_rep$Område)

reslangd_per_omrade_rep <- reslangd_per_omrade_rep %>%
  select(-Område)
```

Tabell med reslängd per område (för färdmedel med färre än `r tolower(tillräckligt_underlag)` observationer utelämnas resultatet).

```{r travel_dist-table1, echo = FALSE, results = "asis"}

x <- kbl(reslangd_per_omrade_rep, longtable = T, booktabs = T, linesep = "") %>%
  #Captions appear to create problems with longtable package, gives error "mispaced align"
  #See here for solution, but don't know how to implement:
  #https://tex.stackexchange.com/a/205468
  kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header"),
                repeat_header_text = "\\textit{(fortsättning)}",
                repeat_header_continued = "\\textit{(Fortsätter på nästa sida...)}") %>%
  row_spec(nrow(reslangd_per_omrade_rep), bold = T) %>% #making the Total row bold
  row_spec(0, bold = T) #making the Header row bold

for (i in c(1:(length(antal_omraden)-1))){
  x <- x %>%
    pack_rows(antal_omraden[i], (i-1)*5+1, (i-1)*5+5,
              hline_after = TRUE)
}

x <- x %>%
  pack_rows("Alla", (length(antal_omraden)-1)*5+1, (length(antal_omraden)-1)*5 + 6,
            hline_after = TRUE,
            hline_before = TRUE)

x

```

#### Resor med start och mål innanför kommungränsen

Tabell med genomsnittlig reslängd och uppräknat antalresor och trafikarbete för varje delområde totalt per område och färdmedel

Tabell/diagram med antal resor per färdmedel efter färmedelslängd Graf med färdmedelsandelar över x = antal kilometer.

#### Resor med start eller mål utanför kommungränsen

Liten OD-matris med vilka andra områden (tätorter, kommuner eller län, beroende på vilken nivå RVU:n tas fram för.) som respondenterna reser till. I antal procent av totala antalet resor.

# Kartor och bilagor

Här följer en karta och mer detaljerade tabeller.

## Ärendeanalys

```{r purpose_analysis, echo=FALSE, include = FALSE}
purposes <- labels_data %>%
  filter(question_id=="B2_R1") %>%
  select(answer_id,answer)

rvu_purp <- rvu %>%
    select(resa_nr, respondentid, b2) %>%
    left_join(purposes, by = c("b2" = "answer_id")) %>%
    group_by(answer) %>%
    summarise(antal = n())

top_purpose <- rvu_purp %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==1)
top_purpose_2 <- rvu_purp %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==2)

top_purpose <- top_purpose$answer
top_purpose_2 <- top_purpose_2$answer

rvu_purp_rep <- rvu_purp %>%
    rename(
        'Ärende' = answer,
        'Antal svar' = antal
    )

```

I Tabell \@ref(tab:purpose-table) och Figur \@ref(fig:purpose-diagram) beskrivs vilka ärenden som respondenterna har svarat att de uppfylde med sina resor. Huvudärendet är `r tolower(top_purpose)` och andra mest populärt ärende är `r tolower(top_purpose_2)`.

```{r purpose-table, echo = FALSE, results = "asis"}
kable(rvu_purp_rep, caption = "Resärenden")

```

```{r distance_mode, echo=FALSE, include=FALSE}
rvu_distance_below_1 <- rvu %>% 
  select(avstand, fardmedel) %>%
  filter(!is.na(fardmedel)) %>%
  group_by(avstand = cut(avstand, breaks = c(0, 1000))) %>%
  summarize("Alla färdsätt" = n(),
            "Bil" = sum(fardmedel == 2),
            "Buss" = sum(fardmedel == 1),
            "Cykel" = sum(fardmedel == 4),
            "Gång" = sum(fardmedel == 5))
  
rvu_distance_below_3 <- rvu %>% 
  select(avstand, fardmedel) %>%
  filter(!is.na(fardmedel)) %>%
  group_by(avstand = cut(avstand, breaks = c(0, 3000))) %>%
  summarize("Alla färdsätt" = n(),
            "Bil" = sum(fardmedel == 2),
            "Buss" = sum(fardmedel == 1),
            "Cykel" = sum(fardmedel == 4),
            "Gång" = sum(fardmedel == 5))

rvu_distance_below_5 <- rvu %>% 
  select(avstand, fardmedel) %>%
  filter(!is.na(fardmedel)) %>%
  group_by(avstand = cut(avstand, breaks = c(0, 5000))) %>%
  summarize("Alla färdsätt" = n(),
            "Bil" = sum(fardmedel == 2),
            "Buss" = sum(fardmedel == 1),
            "Cykel" = sum(fardmedel == 4),
            "Gång" = sum(fardmedel == 5))
  
rvu_distance_below_10 <- rvu %>% 
  select(avstand, fardmedel) %>%
  filter(!is.na(fardmedel)) %>%
  group_by(avstand = cut(avstand, breaks = c(0, 10000))) %>%
  summarize("Alla färdsätt" = n(),
            "Bil" = sum(fardmedel == 2),
            "Buss" = sum(fardmedel == 1),
            "Cykel" = sum(fardmedel == 4),
            "Gång" = sum(fardmedel == 5))
  

rvu_distance <- bind_rows(slice(rvu_distance_below_1, 1), 
                          slice(rvu_distance_below_3, 1),
                          slice(rvu_distance_below_5, 1),
                          slice(rvu_distance_below_10, 1))
rvu_distance$avstand <- c("<=1km", "<=3km", "<=5km", "<=10km") 
rvu_distance <- rvu_distance %>% rename("Reslängd" = avstand)

              
```

```{r distance-mode-table, echo = FALSE, results = "asis"}
kable(rvu_distance, caption = "Reslängd per färdsätt", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(0, bold = T) #making the Header row bold
```

```{r od_matrix, echo=FALSE, include = FALSE}
od_matrix <- rvu %>%
    select(start_tatort_namn, stop_tatort_namn) %>%
    filter(!is.na(start_tatort_namn)) %>%
    filter(!is.na(stop_tatort_namn)) %>%
    group_by(start_tatort_namn, stop_tatort_namn) %>%
    summarize(antal = n()) %>%
    pivot_wider(names_from = stop_tatort_namn, values_from = antal, values_fill = 0)

```

```{r od-matrix-table, echo = FALSE, result="asis"}
kable(od_matrix, caption = "O-D Matris", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(0, bold = T, angle = 90) #making the Header row bold)

write.csv(od_matrix, "od_matrix.csv")
```


```{r purpose-diagram, echo = FALSE, results = "asis", fig.cap = "Antal resor per ärende."}
purp_barplot <- ggplot(rvu_purp, aes(answer, antal, fill = answer)) + 
    geom_bar(stat = "identity") +
    rvu_theme() +
    coord_cartesian(xlim = c(0,15)) +
    scale_fill_brewer(palette = "Set3") + 
    labs(
        x = "Ärende",
        y = "Antal svar",
        title = "Antal resor per ärende"
    )
    

purp_barplot

```

```{r trip_purpose_area, echo=FALSE, include = FALSE}
trip_purpose_all <- rvu %>%
  select(respondentid, b2) %>%
  filter(!is.na(b2)) %>%
  left_join(purposes, by = c("b2" = "answer_id")) %>%
  left_join(pers %>%
              select(respondentid, bostad_deso),
            by = c("respondentid" = "respondentid")) %>%
  mutate(value = 1) %>%
  mutate(index = 1:nrow(rvu%>%filter(!is.na(b2)))) %>%
  spread(answer, value, fill=0) 

trip_purpose_area <- trip_purpose_all %>%
  filter(!is.na(b2)) %>%
  group_by(bostad_deso) %>%
  summarize(.,
            across(c(3:ncol(trip_purpose_all)-1), sum),
            total = n()) %>%
  select(-index, -b2) %>%
  rename("Område" = bostad_deso)
  
```

```{r trip-purpose-area-table, echo = FALSE, results = "asis"}
kable(trip_purpose_area, caption = "Resärende per område", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(0, bold = T, angle = 60) #making the Header row bold

write.csv(trip_purpose_area, "trip_purpose_area.csv")

```

```{r trip_purpose_area_percent, echo=FALSE, include = FALSE}
trip_purpose_area_percent <- trip_purpose_all %>%
  filter(!is.na(b2)) %>%
  group_by(bostad_deso) %>%
  summarize(.,
            across(c(4:ncol(trip_purpose_all)-1), ~sum(.x) / n()),
            total = n()) %>%
  mutate(across(c(4:ncol(trip_purpose_all)-2), ~percent(.x, accuracy = 1))) %>%
  select(-index) %>%
  rename("Område" = bostad_deso)
```

```{r trip-purpose-area-percent-table, echo = FALSE, results = "asis"}
kable(trip_purpose_area_percent, caption = "Resärende per område (procent)", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(0, bold = T, angle = 60) #making the Header row bold

write.csv(trip_purpose_area, "trip_purpose_area_percent.csv")
```

```{r drivers_license_area, echo=FALSE, include = FALSE}
drivers_license_area <- pers %>%
  select(bostad_deso, h4) %>%
  filter(!is.na(h4)) %>%
  group_by(bostad_deso) %>%
  summarize("Ja" = sum(h4 == 1, na.rm = TRUE) / n(),
            "Nej" = sum(h4 == 2, na.rm = TRUE) / n(),
            "Ospecificerat" = sum(h4 == 3, na.rm = TRUE),
            "Totalt antal tillfrågade" = n()) %>%
  mutate(across(c(2,3), ~percent(.x, accuracy = 1)))  %>%
  rename("Område" = bostad_deso)
```

```{r drivers-license-area-table, echo = FALSE, results = "asis"}
kable(drivers_license_area, caption = "Körkortsinnehav per område", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  #row_spec(nrow(drivers_license_area), bold = T) %>% #making the Total row bold
  row_spec(0, bold = T) #making the Header row bold
```

```{r car_ownership_area, echo=FALSE, include = FALSE}
car_ownership_area <- pers %>%
  select(bostad_deso, h5) %>%
  filter(!is.na(h5)) %>%
  group_by(bostad_deso) %>%
  summarize("Ja" = (sum(h5 == 1, na.rm = TRUE) + sum(h5 == 2, na.rm = TRUE) + sum(h5 == 3, na.rm = TRUE) + sum(h5 == 4, na.rm = TRUE)) / n(),
            "Nej" = sum(h5 == 5, na.rm = TRUE) / n(),
            "Ospecificerat" = sum(h5 == 6, na.rm = TRUE),
            "Totalt antal tillfrågade" = n()) %>%
  mutate(across(c(2,3), ~percent(.x, accuracy = 1))) %>%
  rename("Område" = bostad_deso)
```

```{r car-ownership-area-table, echo = FALSE, results = "asis"}
kable(car_ownership_area, caption = "Bilinnehav per område", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  #row_spec(nrow(drivers_license_area), bold = T) %>% #making the Total row bold
  row_spec(0, bold = T) #making the Header row bold)
```

```{r trip_purpose_mode, echo=FALSE, include = FALSE}

trip_purpose_mode <- rvu %>%
    select(b2, fardmedel.kat) %>%
    filter(!is.na(fardmedel.kat)) %>%
    left_join(purposes, by = c("b2" = "answer_id")) %>%
    group_by(answer) %>%
    summarise("Kollektiv buss" = sum(fardmedel.kat == "Kollektiv_buss", na.rm = TRUE),
              "Kollektiv tåg" = sum(fardmedel.kat == "Kollektiv_tåg", na.rm = TRUE),
              "Bil" = sum(fardmedel.kat == "Bil", na.rm = TRUE),
              "Cykel" = sum(fardmedel.kat == "Cykel", na.rm = TRUE),
              "Gång" = sum(fardmedel.kat == "Gång", na.rm = TRUE),
              "Annat" = sum(fardmedel.kat == "Annat", na.rm = TRUE),
              "Total" = n()) %>%
    bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total"))) %>%
    rename("Ärende" = answer)
```


```{r trip-purpose-mode-table, echo = FALSE, result="asis"}
kable(trip_purpose_mode, caption = "Resärende per färdmedel", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_purpose_mode), bold = T) %>% #making the Total row bold
  row_spec(0, bold = T) #making the Header row bold)
```



