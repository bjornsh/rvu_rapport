---
title: "test_rvu_v1.1"
author: "WSP"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output:
  bookdown::pdf_document2: default
header-includes:
  - \renewcommand{\figurename}{Figur }
  - \makeatletter
  - \def\fnum@figure{\figurename\thefigure}
  - \makeatother
  - \renewcommand{\tablename}{Tabell }
  - \makeatletter
  - \def\tnum@table{\tablename\thetable}
  - \makeatother
---

# Resvaneundersökning Bålsta

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(readxl)
library(bookdown)
```

```{r plot-theme-creation, include = FALSE}
rvu_theme <- function() {
    theme(
        plot.title = element_text(colour = "steelblue", face = "bold"),
        plot.background = element_rect(fill = "white"),
        # add border 1)
        panel.border = element_rect(colour = "blue", fill = NA, linetype = 1),
        # color background 2)
        panel.background = element_rect(fill = "aliceblue"),
        # modify grid 3)
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y =  element_line(colour = "steelblue", linetype = 3, size = 0.5),
        panel.grid.minor.y = element_blank(),
        # modify text, axis and colour 4) and 5)
        axis.title.y = element_text(colour = "steelblue"),
        axis.title.x = element_text(colour = "steelblue"),
        axis.line.x = element_blank(),
        axis.text.y = element_text(colour = "steelblue", face = "italic"),
        axis.text.x = element_blank(),
        axis.ticks.y = element_line(colour = "steelblue"),
        axis.ticks.x = element_blank(),
        # legend at the bottom 6)
        legend.position = "right",
        legend.title = element_blank(),
        legend.background = element_rect(colour = "steelblue", fill = "aliceblue")
    )
}

```

```{r read_data, echo=FALSE, include = FALSE}

rvu <- read_delim("rvu.csv", ";", escape_double = FALSE, 
                    locale = locale(encoding = "ISO-8859-1"), 
                    trim_ws = TRUE) %>%
    mutate(
        avstand = as.numeric(str_replace(avstand, ",", "."))
    )

pers <- read_delim("pers.csv", ";", escape_double = FALSE, 
                     locale = locale(encoding = "ISO-8859-1"), 
                     trim_ws = TRUE)


#Lookup-table för att hämta klartext
variable_data <- read_excel("Variable information + Variable Values 2021-05-28.xlsx",
                            sheet = "Variable Labels", skip = 1, col_names = TRUE)
labels_data <- read_excel("Variable information + Variable Values 2021-05-28.xlsx",
                          sheet = "Value Labels", skip = 1, col_names = TRUE)


labels_data <- labels_data %>%
  rename(answer_id=...2,answer=Label,question_id=Value) %>%
  mutate(answer_id = as.numeric(str_remove(str_replace(answer_id, ",", "."),"a"))) %>% #Obs finns NA-observationer
  mutate(question_num=cumsum(!is.na(question_id)))

#Skapar nyckel mellan fråge-id och frågenummer
nyckel <- labels_data %>%
  select(question_id, question_num) %>%
  filter(!is.na(question_id))

#Skapar koppling mellan fråge-ID, svars-ID och svaret
labels_data <- labels_data %>%
  select(answer_id,answer, question_num) %>%
  left_join(nyckel, by = "question_num") %>%
  select(question_id,answer_id,answer)



```

## Sammanfattning

### Antal resor

### Färdmedelsföredlning

### Trafikarbete

### Fördelning mellan män och kvinnor

### Fördelning mellan ålderskategorier

### Vanligaste målpunkterna

## Inledning

### Metod

Hur dokumentet är skapat och generellt om kollbar

### Population och urval

Sammanfattning av SCB:s populationsdata, antal respondenter osv Tabell med antal boende och antal respondenter

## Resultat

### Körkort och biltillgång

Tabell med körkort och bilinnehav

```{r korkort, echo=FALSE}

```

### Antal resor

Tabell med andel personer som rest och deras antal resor per dag redovisat per kön och ålderskategori

### Resornas fördelning på färdsätt

Tabell/diagram med färdmedelsandelar per område

### Bakgrundfrågor

#### Färdsätt efter kön

Tabell/diagram med färdsätt efter kön.

#### Färdsätt efter ålder

Tabell/diagram med färdsätt efter ålder, 12-17 år, 18-24 år, 25-39 år, 40-64 år, 65-74 år, 75-84 år

#### Färdsätt efter sysselsättning

Tabell/diagram med färdsätt efter sysselsättning

#### Färdsätt efter ärende

Tabell/diagram med färdsätt efter ärende

### Reslängd och trafikarbete

#### Resor med start och mål innanför kommungränsen

Tabell med genomsnittlig reslängd och uppräknat antalresor och trafikarbete för varje delområde totalt per område och färdmedel

Tabell/diagram med antal resor per färdmedel efter färmedelslängd Graf med färdmedelsandelar över x = antal kilometer.

#### Resor med start eller mål utanför kommungränsen

Liten OD-matris med vilka andra områden (tätorter, kommuner eller län, beroende på vilken nivå RVU:n tas fram för.) som respondenterna reser till. I antal procent av totala antalet resor.

# Kartor och bilagor

Här följer en karta och mer detaljerade tabeller.

## Ärendeanalys

```{r purpose_analysis, echo=FALSE, include = FALSE}
purposes <- labels_data %>%
  filter(question_id=="B2_R1") %>%
  select(answer_id,answer)

rvu_purp <- rvu %>%
    select(resa.no, respondentid, b2) %>%
    left_join(purposes, by = c("b2" = "answer_id")) %>%
    group_by(answer) %>%
    summarise(antal = n())

top_purpose <- rvu_purp %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==1)
top_purpose_2 <- rvu_purp %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==2)

top_purpose <- top_purpose$answer
top_purpose_2 <- top_purpose_2$answer

rvu_purp_rep <- rvu_purp %>%
    rename(
        'Ärende' = answer,
        'Antal svar' = antal
    )

```

I Tabell \@ref(tab:purpose-table) och Figur \@ref(fig:purpose-diagram) beskrivs vilka ärenden som respondenterna har svarat att de uppfylde med sina resor. Huvudärendet är `r tolower(top_purpose)` och andra mest populärt ärende är `r tolower(top_purpose_2)`.

```{r purpose-table, echo = FALSE, results = "asis"}
kable(rvu_purp_rep, caption = "Antal resor per ärende")

```

```{r purpose-diagram, echo = FALSE, results = "asis", fig.cap = "Antal resor per ärende."}
purp_barplot <- ggplot(rvu_purp, aes(answer, antal, fill = answer)) + 
    geom_bar(stat = "identity") +
    rvu_theme() +
    coord_cartesian(xlim = c(0,15)) +
    scale_fill_brewer(palette = "Set3") + 
    labs(
        x = "Ärende",
        y = "Antal svar",
        title = "Antal resor per ärende"
    )
    

purp_barplot

```

```{r delete_purpose_workspace, echo = FALSE, include = FALSE}
rm(purposes, rvu_purp,rvu_purp_rep)
```
