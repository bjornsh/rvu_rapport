---
author: "WSP"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output:
  bookdown::pdf_document2: default
  bookdown::html_document2:
header-includes:
  - \renewcommand{\figurename}{Figur }
  - \makeatletter
  - \def\fnum@figure{\figurename\thefigure}
  - \makeatother
  - \renewcommand{\tablename}{Tabell }
  - \makeatletter
  - \def\tnum@table{\tablename\thetable}
  - \makeatother
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage[document]{ragged2e}
  - \floatplacement{figure}{H}
---

```{r indata, echo=FALSE, include = FALSE}
#Nedan specificeras indata/globala parametrar
#Definierar om respondenter ska delas upp på kommun, tätort eller deso-nivå:
rapportomrade <- c("Bålsta", "Bålsta Skärplinge") #Sträng eller array över områden som inkluderas
rapportomrade_text <- "Bålsta" #namn på området som skrivs i löptexten
rapportomrade_rubrik <- "Bålsta tätort" #namn på området som skrivs i rubriker
rapportniva <- "tatort" #'kommun' #'lan' #vilken geografisk avgränsning rapporten har
omradesniva <- "deso" #'kommun' #'tatort' #vilken områdesnivån som resultaten ska redovisas på. Om rapportområdet är en region, bör kommun väljas och om det är en tätort bör deso väljas osv...
#Denna bör skapas automatiskt baserat på populäraste färdmedlet i rvu
palett <- c("#5144d3","#53a17f","#3599d5","#e6ad00","#d57667","#9e1863")
# Hämtar befolkningsdata per DeSO/kommun/region från SCBs API #OBS ändras denna kommer även koden för inläsning behöva ändras
table_api_address = "http://api.scb.se/OV0104/v1/doris/en/ssd/BE/BE0101/BE0101Y/FolkmDesoAldKonN"
```
---
title: Resvaneundersökning i `r rapportomrade_rubrik`
---
\raggedright
---

```{r setup, include=FALSE}

  required_packages_list <-  c(
  "knitr", "kableExtra", "tidyverse", "readxl", "bookdown", "pxweb", "scales", "stringi")
  
  for (pack in required_packages_list){
    if(pack %in% installed.packages() == FALSE){install.packages(pack)}
}

lapply(required_packages_list, require, character.only = TRUE)

inline_hook<-function(x){
  if(is.numeric(x)){
    formatted<-format(x,big.mark = " ")
  }
  else{
    formatted<-x
  }
}
knit_hooks$set(inline = inline_hook)
```

```{r plot-theme-creation, include = FALSE}
rvu_theme <- function() {
    theme(
        plot.title = element_text(colour = "black", face = "bold"),
        plot.background = element_rect(fill = "white"),
        # add border 1)
        panel.border = element_rect(fill = NA, linetype = 1),
        # color background 2)
        panel.background = element_rect(fill = "white"),
        # modify grid 3)
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y =  element_line(linetype = 3, size = 0.5),
        panel.grid.minor.y = element_blank(),
        # modify text, axis and colour 4) and 5)
        axis.title.y = element_text(colour = "black"),
        axis.title.x = element_text(colour = "black"),
        axis.line.x = element_blank(),
        axis.text.y = element_text(colour = "black", face = "italic"),
        axis.text.x = element_blank(),
        axis.ticks.y = element_line(colour = "black"),
        axis.ticks.x = element_blank(),
        # legend at the bottom 6)
        legend.position = "right",
        legend.title = element_blank(),
        legend.background = element_rect(colour = NA, fill = "white")
    )
}

options(knitr.table.format = "latex")

```

```{r funktioner, echo=FALSE, include = FALSE}
#Nedan specificeras funktioner som används i skriptet

#Funktioner för att hitta extremer i data
extremer_höga <- function(table, index_col, col) {
  table <- table %>%
    rename(index_col = index_col) %>%
    filter(index_col != "Totalt") %>%
    rename(col = col) %>%
    filter(!between(col, 0, median(col, na.rm=TRUE) + (2.5 * sd(col, na.rm=TRUE)))) %>%
    arrange(desc(col))
  return(table)
}

extremer_låga <- function(table, index_col, col) {
  table <- table %>%
    rename(index_col = index_col) %>%
    filter(index_col != "Totalt") %>%
    rename(col = col) %>%
    filter(!between(col, median(col, na.rm=TRUE) - (2.5 * sd(col, na.rm=TRUE)), 100)) %>%
    arrange(col)
  return(table)
}

#Fuktion för uppräkning av områden
upprakning<-function(lista,max_antal_uppräknade){
  antal_uppräknade <- min(nrow(lista),max_antal_uppräknade) #som mest räknas alla områden upp
  text_uppräkning <- paste(lista[1:(antal_uppräknade)], collapse = ', ') #sträng med områden
  text_uppräkning <- stri_replace_last_fixed(text_uppräkning, ', ', ' och ') #sätter "och" i slutet av uppräkningen
  return(text_uppräkning)
}
```

```{r read_data, echo=FALSE, include = FALSE}

rvu <- read_delim("rvu_håbo2021.csv", ";", escape_double = FALSE, 
                    locale = locale(encoding = "ISO-8859-1"), 
                    trim_ws = TRUE)

pers <- read_delim("person_håbo2021.csv", ";", escape_double = FALSE, 
                     locale = locale(encoding = "ISO-8859-1"), 
                     trim_ws = TRUE)

avst <- read_delim("restid_håbo2021.csv", ";", escape_double = FALSE, 
                     locale = locale(encoding = "ISO-8859-1"), 
                     trim_ws = TRUE) %>%
  select(respondentid, resa_nr, distance_straight_line, distance_google)

#Bestämmer vilken bostadsinfo som ska användas beroende på rapportnivå...

pers <- mutate(pers,Omrade = .data[[paste("bostad_",omradesniva,"_namn",sep="")]])
pers <- mutate(pers,Omrade_kod = .data[[paste("bostad_",omradesniva,"_kod",sep="")]])
rvu <- mutate(rvu,start_omrade_namn = .data[[paste("start_",omradesniva,"_namn",sep="")]])
rvu <- mutate(rvu,stop_omrade_namn = .data[[paste("stop_",omradesniva,"_namn",sep="")]])

pers <- mutate(pers,Rapportomrade = .data[[paste("bostad_",rapportniva,"_namn",sep="")]])
#pers <- mutate(pers,Rapportomrade_kod = .data[[paste("bostad_",rapportniva,"_kod",sep="")]])
rvu <- mutate(rvu,start_rapportomrade_namn = .data[[paste("start_",rapportniva,"_namn",sep="")]])
rvu <- mutate(rvu,stop_rapportomrade_namn = .data[[paste("stop_",rapportniva,"_namn",sep="")]])


#Filter för att begränsa till rapportområdet
pers <- pers %>%
  filter(Rapportomrade %in% rapportomrade)
rvu <- rvu %>%
  filter(respondentid %in% pers$respondentid)
avst <- avst %>%
  filter(respondentid %in% pers$respondentid)

#joina avstånd till resor
rvu <- rvu %>%
  left_join(avst, by = c("respondentid", "resa_nr")) %>%
  mutate(avstand = distance_google) %>%
  mutate(fardmedel.kat = ifelse(fardmedel.kat == "Kollektiv_buss","Buss",fardmedel.kat)) %>%
  mutate(fardmedel.kat = ifelse(fardmedel.kat == "Kollektiv_tåg","Tåg",fardmedel.kat))
```

```{r api, echo=FALSE, include = FALSE}

#ett viktad medelvärde för året då RVU genomfördes för att få rätt befolkningsdata från SCB API
rvu_yr <- pers %>% group_by(ar) %>% summarise(resp_in_year = n()) %>% 
  summarise(avg_year = weighted.mean(ar, resp_in_year)) %>% 
  round() %>% as.character()

#Om fel, väljs ett tidigare år:
#rvu_yr <- as.character(as.numeric(rvu_yr)-1) # flag: ta bort


scb_data_last_year <- pxweb_get(table_api_address)$variables[5][[1]]$values %>% rev()
#Getting the latest year if the RVU year not in the SCB table
if(!(as.numeric(rvu_yr) %in% scb_data_last_year)){
  rvu_yr <- scb_data_last_year[1]
}


pxweb_query_list <- 
    list("Region"=c('*'), # Use "*" to select all
         "Alder" = c('15-19','20-24','25-29','30-34','35-39','40-44','45-49','50-54','55-59','60-64','65-69','70-74','75-79','80-'),
         "Kon"=c('1','2'), #1:man, 2:kvinna
         "ContentsCode"=c('000005FF'), #table name in SCB webpage
         "Tid"=c(rvu_yr))
px_query <- pxweb_query(pxweb_query_list)

px_data <- pxweb_get(table_api_address,
                 px_query)

scb_befolkning <- as.data.frame(px_data, column.name.type = "text", variable.value.type = "text") %>%
#kolumnerna ska heta: region (chr), citizenship (chr), sex (chr), year (chr), Population per region (chr) %>%
  mutate(region = str_trim(region, side = "left")) %>% #removing blank character
  rename(Omrade_kod = region,
         Ålder = age,
         Kön = sex,
         Befolkning = "Population per region") %>%
  select(Omrade_kod, Ålder, Kön, Befolkning)

scb_befolkning <- scb_befolkning %>%
  mutate(Män = ifelse(Kön == "men", Befolkning, 0),
         Kvinnor = ifelse(Kön == "women", Befolkning, 0),
         Ålder_15_19 = ifelse(strtoi(str_sub(Ålder,1,2)) < 20, Befolkning, 0),
         Ålder_20_24 = ifelse(strtoi(str_sub(Ålder,1,2)) < 25, Befolkning, 0),
         Ålder_25_39 = ifelse(strtoi(str_sub(Ålder,1,2)) > 20 & strtoi(str_sub(Ålder,1,2)) < 40, Befolkning, 0),
         Ålder_40_64 = ifelse(strtoi(str_sub(Ålder,1,2)) < 35 & strtoi(str_sub(Ålder,1,2)) < 65, Befolkning, 0),
         Ålder_65_74 = ifelse(strtoi(str_sub(Ålder,1,2)) > 60 & strtoi(str_sub(Ålder,1,2)) < 75, Befolkning, 0),
         Ålder_75 = ifelse(strtoi(str_sub(Ålder,1,2)) > 75, Befolkning, 0)) %>%
  group_by(Omrade_kod) %>%
  summarise(Befolkning = sum(Befolkning), Män = sum(Män), Kvinnor = sum(Kvinnor), "Ålder_15_19" = sum(Ålder_15_19), "Ålder_20_24" = sum(Ålder_20_24), "Ålder_25_39" = sum(Ålder_25_39), "Ålder_40_64" = sum(Ålder_40_64), "Ålder_65_74" = sum(Ålder_65_74), "Ålder_75" = sum(Ålder_75))

respondent2omrade <- pers %>%
  select(respondentid, Omrade, Omrade_kod) %>%
  left_join(scb_befolkning, by = c("Omrade_kod" = "Omrade_kod"))

rvu <- rvu %>%
  left_join(select(respondent2omrade, c(respondentid,Omrade,Omrade_kod)), by = c("respondentid" = "respondentid"))

```

```{r fraga-svar-nyckel, echo=FALSE, include = FALSE}

#Lookup-table för att hämta klartext
variable_data <- read_excel("Variable information + Variable Values 2021-05-28.xlsx",
                            sheet = "Variable Labels", skip = 1, col_names = TRUE)
labels_data <- read_excel("Variable information + Variable Values 2021-05-28.xlsx",
                          sheet = "Value Labels", skip = 1, col_names = TRUE)


labels_data <- labels_data %>%
  rename(answer_id=...2,answer=Label,question_id=Value) %>%
  mutate(answer_id = as.numeric(str_remove(str_replace(answer_id, ",", "."),"a"))) %>% #Obs finns NA-observationer
  mutate(question_num=cumsum(!is.na(question_id)))

#Skapar nyckel mellan fråge-id och frågenummer
nyckel <- labels_data %>%
  select(question_id, question_num) %>%
  filter(!is.na(question_id))

#Skapar koppling mellan fråge-ID, svars-ID och svaret
labels_data <- labels_data %>%
  select(answer_id,answer, question_num) %>%
  left_join(nyckel, by = "question_num") %>%
  select(question_id,answer_id,answer)

```

# Sammanfattning

Under `r paste(min(pers$ar),ifelse(min(pers$ar)!=max(pers$ar),paste("-",max(pers$ar),sep = ""),""),sep = "")` besvarades kollektivtrafiksbarometern av `r (length(unique(rvu$respondentid)))` stycken 15-85-åringar boende i `r (rapportomrade_text)`. Syftet med undersökningen är att kartlägga hur resandet ser ut en genomsnittlig vardag `r max(pers$ar)`. Undersökningen omfattar enbart persontransporter och har genomförts som en enkätundersökning. Resultaten är viktade med avseende på urvalsområde, kön och ålder för att motsvara hela befolkningen i den undersökta åldersgruppen.

```{r antal_resor, echo=FALSE, include=FALSE}

num_trips_per_pers <- rvu %>%
  select(respondentid) %>%
  group_by(respondentid) %>%
  summarize(num_trips = n())
  
befolkning_per_område <- pers %>%
  select(respondentid, kon) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(num_trips)) %>%
  left_join(respondent2omrade, by = c("respondentid" = "respondentid")) %>%
  group_by(Omrade,Omrade_kod) %>%
  summarize() %>%
  left_join(scb_befolkning, by = c("Omrade_kod" = "Omrade_kod")) 

vars <- c("Antal personer", "Resor per dag för alla personer")

num_trips_gender <- pers %>%
  select(respondentid, kon) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  group_by(kon) %>%
  summarize("Andel personer som rest (%)" = 100*sum(!is.na(num_trips)) / n(),
            "Resor per dag för alla personer" = sum(num_trips, na.rm = TRUE) / n(),
            "Resor per dag för personer som rest" = mean(num_trips, na.rm = TRUE)) %>%
  rename('Grupp' = kon) %>%
  mutate('Befolkning' = c(sum(befolkning_per_område$Kvinnor,na.rm = TRUE),sum(befolkning_per_område$Män,na.rm = TRUE),0),
         'Antal resor' = round(.data[["Befolkning"]] * .data[["Resor per dag för alla personer"]]))


num_trips_age <- pers %>%
  mutate(alder = ifelse(is.na(alder), "Ej angivet", alder)) %>%
  select(respondentid, alder) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  group_by(alder = cut(alder, breaks = c(12, 24, 64, 150))) %>%
  summarize("Andel personer som rest (%)" = 100*sum(!is.na(num_trips)) / n(),
            "Resor per dag för alla personer" = sum(num_trips, na.rm = TRUE) / n(),
            "Resor per dag för personer som rest" = mean(num_trips, na.rm = TRUE)) %>%
  mutate(alder = c("15-24 år", "25-64 år", "65-85 år")) %>%
  rename('Grupp' = alder) %>%
  mutate('Befolkning' = c(sum(befolkning_per_område$Ålder_15_19,na.rm = TRUE)+sum(befolkning_per_område$Ålder_20_24,na.rm = TRUE),
                          sum(befolkning_per_område$Ålder_25_39,na.rm = TRUE)+sum(befolkning_per_område$Ålder_40_64,na.rm = TRUE),
                          sum(befolkning_per_område$Ålder_65_74,na.rm = TRUE)+sum(befolkning_per_område$Ålder_75,na.rm = TRUE)),
         'Antal resor' = round(.data[["Befolkning"]] * .data[["Resor per dag för alla personer"]]))

num_trips_all <- pers %>%
  select(respondentid) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  #group_by(kon) %>%
  summarize("Andel personer som rest (%)" = 100*sum(!is.na(num_trips)) / n(),
            "Resor per dag för alla personer" = sum(num_trips, na.rm = TRUE) / n(),
            "Resor per dag för personer som rest" = mean(num_trips, na.rm = TRUE)) %>%
  mutate('Grupp' = "Alla",
         'Befolkning' = sum(befolkning_per_område$Befolkning,na.rm = TRUE),
         'Antal resor' = round(.data[["Befolkning"]] * .data[["Resor per dag för alla personer"]]))

num_trips_rep <- num_trips_gender %>%
  rbind(num_trips_age) %>%
  rbind(num_trips_all)

```

## Antal resor
Antalet resor per dygn i `r (rapportomrade_text)` uppgick till `r round(num_trips_all$"Antal resor")`. I genomsnitt gjorde `r round(num_trips_all$"Andel personer som rest (%)")` procent åtminstone en resa per dag.


```{r fordonskilometer_bearbetning, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per område."}
#Följande används i diagrammen nedan, samt till fardmedelsfordelning-km-diagram i resultat-delen

#Filtrerar data
reslangd <- rvu %>%
  filter(!is.na(avstand)) %>%
  rename(Färdmedel = fardmedel.kat) %>%
  select(respondentid,Färdmedel,avstand,Omrade,Omrade_kod)

#Räknar ut hur många individer som gör resor per område
antal_resande_individer <- rvu %>%
  group_by(Omrade) %>%
  summarise("Antal_resande_individer" = n_distinct(respondentid))

#Räknar ut hur många individer som inte gör någon resa
individer_utan_resa <- pers %>% #OBS i dagsläget saknar alla individer utan resa också område...
  group_by(Omrade) %>%
  summarise("Antal_individer" = n_distinct(respondentid)) %>%
  left_join(antal_resande_individer, by = c("Omrade" = "Omrade")) %>%
  mutate(Individer_utan_resa = Antal_individer-Antal_resande_individer) %>%
  select(Omrade,Individer_utan_resa) 

#Räknar ut hur många individer det finns per område
individer_per_område <- reslangd %>%
  group_by(Omrade) %>%
  summarise("Antal_individer" = n_distinct(respondentid)) %>%
  left_join(individer_utan_resa, by = c("Omrade" = "Omrade")) %>%
  mutate(Antal_individer = Antal_individer+Individer_utan_resa) %>%
  select(Omrade,Antal_individer) 

#Antal resor per individ (och område, färdmedel) räknas ut
resor_per_individ <- reslangd %>% #Resor per individ blir överskattat pga fel med att individer utan resa saknar bostadsort
  group_by(Omrade,Omrade_kod,Färdmedel) %>%
  summarise("Antal_observationer" = n(), .groups = 'drop') %>%
  left_join(individer_per_område, by = c("Omrade" = "Omrade")) %>%
  mutate(Resor_per_individ = Antal_observationer/Antal_individer) %>%
  left_join(select(scb_befolkning, c(Omrade_kod,Befolkning)), by = c("Omrade_kod" = "Omrade_kod")) %>%
  mutate(Totalt_antal_resor = Befolkning*Resor_per_individ) %>%
  ungroup() %>%
  select(Omrade,Färdmedel,Totalt_antal_resor)

#Antal resor per individ (färdmedel) räknas ut
resor_per_individ_summa <- resor_per_individ %>%
  group_by(Färdmedel) %>%
  summarise("Totalt_antal_resor" = round(sum(Totalt_antal_resor,na.rm = TRUE),0)) %>%
  arrange(desc(Totalt_antal_resor)) %>%
  mutate(Perc_resor = Totalt_antal_resor / sum(Totalt_antal_resor))

#Här definieras den globala parametern som bestämmer ordning på färdmedel i alla diagram
ordning_fardmedel <- resor_per_individ_summa$Färdmedel
ordning_fardmedel <- append(ordning_fardmedel,"Annat") #Lägg till Annat på slutet
if (match("Tåg",ordning_fardmedel)<match("Buss",ordning_fardmedel)) { #Om tåg före buss
  ordning_fardmedel <- ordning_fardmedel[ordning_fardmedel != "Buss"] #Ta bort Buss
  ordning_fardmedel <- append(ordning_fardmedel,"Buss",match("Tåg",ordning_fardmedel)) #Lägg till buss efter tåg
} else {
  ordning_fardmedel <- ordning_fardmedel[ordning_fardmedel != "Tåg"] #Ta bort Tåg
  ordning_fardmedel <- append(ordning_fardmedel,"Tåg",match("Buss",ordning_fardmedel)) #Lägg till tåg efter buss
}

#Räknar ut totalt per färdmedel
reslangd_summa <- reslangd %>%
  # as.data.frame() %>%
  # `rownames<-`(.[,1])  %>% #skapar indexkolumn
  # select(!(Omrade))  %>%
  group_by(Färdmedel) %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
  mutate(Omrade = c("Alla")) %>%
  left_join(resor_per_individ_summa, by = c("Färdmedel" = "Färdmedel")) %>%
  select(-Perc_resor) %>%
  mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel) %>%
  arrange(desc(Totalt_antal_resor))

#Räknar ut totalt
reslangd_summa_tot <- reslangd %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
  cbind(Färdmedel = "Alla") %>%
  cbind(Omrade = "Totalt") %>%
  mutate(Totalt_antal_resor = sum(resor_per_individ$Totalt_antal_resor,na.rm = TRUE)) %>%
  mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel)

#Räknar ut totalt per färdmedel och område
# reslangd_per_område <- reslangd %>%
#   select(-one_of("Omrade_kod")) %>%
#   group_by(Omrade,Färdmedel) %>% #`summarise()` has grouped output by 'Omrade'. You can override using the `.groups` argument.???
#   summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
#   left_join(resor_per_individ, by = c("Omrade" = "Omrade", "Färdmedel" = "Färdmedel")) %>%
#   mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel)

##Alternativ till att redovisa per färdmedel##
#Antal resor per individ (och område, färdmedel) räknas ut
resor_per_omrade_fardmedel <- reslangd %>% #Resor per individ blir överskattat pga fel med att individer utan resa saknar bostadsort
  group_by(Omrade,Omrade_kod) %>%
  summarise("Antal_observationer" = n(), .groups = 'drop') %>%
  left_join(individer_per_område, by = c("Omrade" = "Omrade")) %>%
  mutate(Resor_per_individ = Antal_observationer/Antal_individer) %>%
  left_join(select(scb_befolkning, c(Omrade_kod,Befolkning)), by = c("Omrade_kod" = "Omrade_kod")) %>%
  mutate(Totalt_antal_resor = Befolkning*Resor_per_individ) %>%
  ungroup() %>%
  select(Omrade,Totalt_antal_resor)

#Skapar kolumner med median, medel osv.
reslangd_per_omrade_ny <- reslangd %>%
  select(-one_of("Omrade_kod")) %>%
  group_by(Omrade) %>% #`summarise()` has grouped output by 'Omrade'. You can override using the `.groups` argument.???
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal_observationer" = n()) %>%
  left_join(resor_per_omrade_fardmedel, by = c("Omrade" = "Omrade")) %>%
  mutate(Trafikarbete_totalt = Totalt_antal_resor*Medel)


#Antalet observationer som krävs för att data ska visas (global parameter)
tillräckligt_underlag <- 5

# #Döljer värden som inte ska visas
# reslangd_per_område <- reslangd_per_område %>%
#   mutate(Median= ifelse(Antal_observationer < tillräckligt_underlag, NA, Median)) %>%
#   mutate(Medel= ifelse(Antal_observationer < tillräckligt_underlag, NA, Medel)) %>%
#   mutate(Totalt_antal_resor= ifelse(Antal_observationer < tillräckligt_underlag, NA, Totalt_antal_resor)) %>%
#   mutate(Trafikarbete_totalt= ifelse(Antal_observationer < tillräckligt_underlag, NA, Trafikarbete_totalt))

# reslangd_per_omrade_rep <- crossing(unique(reslangd$Omrade), unique(reslangd$Färdmedel)) %>% #creating combination of all Omrade and Färdmedel to have all rows in the table
#   rename(Omrade = "unique(reslangd$Omrade)",
#          Färdmedel = "unique(reslangd$Färdmedel)") %>%
#   left_join(reslangd_per_område, by = c("Omrade", "Färdmedel")) %>%
#   rbind(reslangd_summa) %>%
#   rbind(reslangd_summa_tot) %>%
#   mutate(
#     Omrade = ifelse(is.na(Omrade), "Ej angivet", Omrade),
#     Färdmedel = Färdmedel,
#     Median = ifelse(is.na(Median), "-", round(Median/1000)),
#     Medel = ifelse(is.na(Medel), "-", round(Medel/1000)),
#     "Totalt antal resor" = ifelse(is.na(Totalt_antal_resor), "-", round(Totalt_antal_resor/100)*100),
#     "Totalt antal fordonskilometer" = ifelse(is.na(Trafikarbete_totalt), "-", round(Trafikarbete_totalt/1000)),
#     "Antal observationer" = ifelse(is.na(Antal_observationer), 0, Antal_observationer)
#   ) %>%
#   select(-Antal_observationer,-Totalt_antal_resor,-Trafikarbete_totalt)

##Alternativ till den ovan##
reslangd_per_omrade_ny <- reslangd_per_omrade_ny %>%
  mutate(
    Omrade = ifelse(is.na(Omrade), "Ej angivet", Omrade),
    Median = ifelse(is.na(Median), "-", round(Median/1000)),
    Medel = ifelse(is.na(Medel), "-", round(Medel/1000)),
    "Totalt antal resor" = ifelse(is.na(Totalt_antal_resor), "-", round(Totalt_antal_resor/100)*100),
    "Totalt antal fordonskilometer" = ifelse(is.na(Trafikarbete_totalt), "-", round(Trafikarbete_totalt/1000)),
    "Antal observationer" = ifelse(is.na(Antal_observationer), 0, Antal_observationer)
  ) %>%
  select(-Antal_observationer,-Totalt_antal_resor,-Trafikarbete_totalt)

 reslangd_summa_ny <- reslangd_summa %>%
  mutate(
    Färdmedel = ifelse(is.na(Färdmedel), "Ej angivet", Färdmedel),
    Median = ifelse(is.na(Median), "-", round(Median/1000)),
    Medel = ifelse(is.na(Medel), "-", round(Medel/1000)),
    "Totalt antal resor" = ifelse(is.na(Totalt_antal_resor), "-", round(Totalt_antal_resor/100)*100),
    "Totalt antal fordonskilometer" = ifelse(is.na(Trafikarbete_totalt), "-", round(Trafikarbete_totalt/1000)),
    "Antal observationer" = ifelse(is.na(Antal_observationer), 0, Antal_observationer)
  ) %>%
  select(-Antal_observationer,-Totalt_antal_resor,-Trafikarbete_totalt,-Omrade)





```

```{r fordonskilometer_text, echo=FALSE, include = FALSE}
#Text produceras för färdmedelsfördelningen nedan i sammanfattningen, samt till resultatdelens avsnitt Reslängd och fordonskilometer

#Mest frekventa färdmedel map fordonskilometer
mest_frekvent_färdmedel_km <- reslangd_summa$Färdmedel[which.max(reslangd_summa$Trafikarbete_totalt)]
mest_frekvent_färdmedel_km_varde <- max(reslangd_summa$Trafikarbete_totalt)
mest_frekvent_färdmedel_km_andel <- mest_frekvent_färdmedel_km_varde/sum(reslangd_summa$Trafikarbete_totalt)

#Längst eller kortast median
langst_resor_fardmedel <- reslangd_summa$Färdmedel[which.max(reslangd_summa$Median)]
langst_resor_fardmedel_varde <- max(reslangd_summa$Median)
kortast_resor_fardmedel <- reslangd_summa$Färdmedel[which.min(reslangd_summa$Median)]
kortast_resor_fardmedel_varde <- min(reslangd_summa$Median)

```

```{r fardmedelsfordelning_bearbetning, echo=FALSE, include=FALSE}
#Följande kod används i sammanfattning och i resultatdelens kapitel Resornas fördelning på färdsätt
trip_mode <- rvu %>%
  # left_join(select(pers, c("respondentid")), by = c("respondentid" = "respondentid")) %>% #Hämtar kolumn från pers-data
  select(Omrade, Omrade_kod, fardmedel.kat) %>%
  filter(!is.na(fardmedel.kat)) %>%
  group_by(Omrade,Omrade_kod,fardmedel.kat) %>%
  summarize(antal = n()) %>%
  spread(fardmedel.kat, antal, fill=0) %>%
  mutate(Totalt = rowSums(across(where(is.numeric)))) %>%
  #Räknar ut radsummor
  ungroup() %>%
  left_join(select(scb_befolkning, c(Omrade_kod,Befolkning)), by = c("Omrade_kod" = "Omrade_kod")) %>%
  bind_rows(summarize(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~ "Totalt"))) %>% #Skapar totalrad
  mutate(across(where(is.numeric) & !Befolkning, ~ . / Totalt)) %>% #dividerar till procent av respondenter
  select(Omrade,ordning_fardmedel,Befolkning)

trip_mode_percent <- trip_mode %>%
  select(!Befolkning) %>%
  mutate(across(where(is.numeric), ~percent(.x, accuracy = 1)))

trip_mode_abs <- trip_mode %>%
  mutate(across(where(is.numeric) & !Befolkning, ~ round(. * Befolkning)),
Totalt = Befolkning) %>%
  select(!Befolkning)

```

```{r fardmedelsfordelning_text, echo=FALSE, include=FALSE}
#Transformerar till dataframe
trip_person_mode_max <- trip_mode %>%
  as.data.frame() %>%
  `rownames<-`(.[,1])  %>% #skapar indexkolumn
  select(!(Omrade))  %>%
  select(!(Befolkning))

#Räknar ut vanligaste färdmedlet i respektive område
trip_person_mode_max <- trip_person_mode_max %>%
  mutate('max' = names(trip_person_mode_max)[max.col(trip_person_mode_max, "first")])

#Plockar ut det vanligaste färdmedlet totalt sett
mest_frekvent_färdmedel <- trip_person_mode_max["Totalt","max"]

#Plockar ut det vanligaste färdmedlets andelar
mest_frekvent_andel <- trip_person_mode_max["Totalt",mest_frekvent_färdmedel]

#Skapar en lista med områden som har ett avvikande vanligaste färdmedel
avvikande_vanligaste_färdmedel <- trip_person_mode_max %>%
  filter(max != mest_frekvent_färdmedel)

#Filtrerar ut extremvärden för att kunna skriva om dem i texten.
trip_person_mode_extremer_höga <- extremer_höga(trip_mode,"Omrade",mest_frekvent_färdmedel)
trip_person_mode_extremer_låga <- extremer_låga(trip_mode,"Omrade",mest_frekvent_färdmedel)

#Producerar brödtext.
text_fardmedelsfordelning <- paste(tolower(mest_frekvent_färdmedel)," är det vanligaste färdmedlet i ",rapportomrade_text," och står för ",round(mest_frekvent_andel*100)," procent av alla resorna. ",sep="")

if (nrow(avvikande_vanligaste_färdmedel) > 0) {
  text_fardmedelsfordelning <- paste(text_fardmedelsfordelning,"I zon ",sep="")
  #Uppräkning av områden
  text_uppräkning <- upprakning(rownames(avvikande_vanligaste_färdmedel),max_antal_uppräknade)
  text_fardmedelsfordelning <- paste(text_fardmedelsfordelning,text_uppräkning," var dock ",avvikande_vanligaste_färdmedel$max[1]," det vanligaste färdmedlet. ",sep="")
} else{
  text_fardmedelsfordelning <- paste(text_fardmedelsfordelning," Detta är också det vanligaste färdmedlet i varje enskilt område. ")
}

extremer <- trip_person_mode_extremer_höga
tabell <- select(trip_mode,!Befolkning)
if (nrow(extremer)>1){ #om det finns extremer
  text_fardmedelsfordelning <- paste(text_fardmedelsfordelning,"Särskilt högt var antalet ",mest_frekvent_färdmedel,"resor bland människor i ")
  #Uppräkning av områden
  text_uppräkning <- upprakning(rownames(extremer),max_antal_uppräknade)
  text_fardmedelsfordelning <- paste(text_fardmedelsfordelning,text_uppräkning,", där andelen var upp emot ",round(extremer$Bil[1]*100)," %. ",sep="")
  } else {
    tabell_max <- slice(tabell,which.max(Bil))
    text_fardmedelsfordelning <- paste(text_fardmedelsfordelning,"Högst andel återfanns i ",tabell_max$Omrade,", med ",round(tabell_max$Bil*100)," %. ",sep="")
}

extremer <- trip_person_mode_extremer_låga
if (nrow(extremer)>1){ #om det finns extremer
  text_fardmedelsfordelning <- paste(text_fardmedelsfordelning,"Särskilt låg andel ",mest_frekvent_färdmedel,"resor återfanns i ")
  #Uppräkning av områden
  text_uppräkning <- upprakning(rownames(extremer),max_antal_uppräknade)
  text_fardmedelsfordelning <- paste(text_fardmedelsfordelning,text_uppräkning,", där andelen var ner emot ",round(extremer$Bil[1]*100)," %. ",sep="")
  } else {
    tabell_min <- slice(tabell,which.min(Bil))
    text_fardmedelsfordelning <- paste(text_fardmedelsfordelning,"Lägst var andelen i ",tabell_min$Omrade,", där endast ",round(tabell_min$Bil*100)," % av resorna gjordes med ",tolower(mest_frekvent_färdmedel),". ",sep="")
  }

#För att kommentera antalet cykelresor
if (mest_frekvent_färdmedel != "Cykel") {
  andel_resor_cykel <- pull(trip_mode[nrow(trip_mode),"Cykel"])
  andel_resor_cykel_max <- slice(trip_mode,which.max(Cykel))
  text_fardmedelsfordelnng <- paste(text_fardmedelsfordelning," Andelen cyklister var i genomsnitt ",round(andel_resor_cykel*100)," %. Högst andel cyklister återfanns i ",pull(andel_resor_cykel_max["Omrade"])," med en andel på ",round(pull(andel_resor_cykel_max["Cykel"]*100))," %. ",sep="")
}

```

## Färdmedelsfördelning

Färdmedelsfördelningen visar att `r tolower(mest_frekvent_färdmedel)` är det vanligaste färdmedlet och används för `r round(mest_frekvent_andel*100)` % av alla resor. `r ifelse(mest_frekvent_färdmedel==mest_frekvent_färdmedel_km,paste(mest_frekvent_färdmedel,"är också det"),paste("Däremot är",tolower(mest_frekvent_färdmedel_km),"det"))` vanligaste färdmedlet sett till antal fordonskilometer. En `r ifelse(mest_frekvent_färdmedel_km_andel>.75,"övervägande ","")`majoritet (`r round(mest_frekvent_färdmedel_km_andel*100)` %) av fordonskilometrarna, som boende i `r (rapportomrade_text)` förflyttade sig, gjordes med `r tolower(mest_frekvent_färdmedel_km)`.

```{r fardmedelsfordelning-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per område."}
#Histogram med resandefrekvens
resor_barplot <- ggplot(resor_per_individ_summa, aes(factor(Färdmedel, level = ordning_fardmedel), Perc_resor, fill = factor(Färdmedel, level = ordning_fardmedel))) +
    geom_bar(stat = "identity") +
    rvu_theme() +
    coord_cartesian(xlim = c(1,nrow(resor_per_individ_summa))) +
    scale_fill_manual(values=rev(palett)) +
    scale_y_continuous(labels = scales::percent) +
    geom_text(aes(label=percent(Perc_resor, 1)),size = 3, position=position_dodge(width=0.9), vjust=-0.25) + #etiketter
    # scale_fill_discrete(breaks=ordning_fardmedel) +
    labs(
        x = "Färdmedel",
        y = "Antal resor",
        title = "Antal resor per färdmedel"
    )


resor_barplot
```


```{r fardmedelsfordelning-km-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per område."}
#Tabell till diagram
reslangd_per_fardmedel <- reslangd_summa %>%
  ungroup() %>%
  select(Färdmedel,Trafikarbete_totalt)

#Stapeldiagram med reslängd
reslangd_barplot <- ggplot(reslangd_per_fardmedel, aes(factor(Färdmedel, level = ordning_fardmedel), Trafikarbete_totalt, fill = factor(Färdmedel, level = ordning_fardmedel))) +
    geom_bar(stat = "identity") +
    rvu_theme() +
    coord_cartesian(xlim = c(1,nrow(reslangd_per_fardmedel))) +
    scale_fill_manual(values=rev(palett)) +
    geom_text(aes(label=round(Trafikarbete_totalt/1000/1000)*1000),size = 3, position=position_dodge(width=0.9), vjust=-0.25) + #etiketter
    labs(
        x = "Färdmedel",
        y = "Total reslängd (km)",
        title = "Reslängd per färdmedel"
    )


reslangd_barplot
```

## Fördelning mellan män och kvinnor

<Exempeltext>

Män och kvinnor gör ungefär lika många resor per person och dag, Y respektive X. Män använder bil i högre utsträckning än kvinnor, Y procent jämfört med X procent. Kvinnor och män cyklar ungefär i lika stor utsträckning, Y procent respektive X procent. 

## Fördelning mellan ålderskategorier

<Exempeltext>
Andelen cykelresor är högst i åldersgruppen 18–24 år, där X procent av resorna utförs med cykel. Andelen bilresor ökar med stigande med ålder och är högst i ålderskategorin 65–74 år, där Y procent av resorna utförs med bil. Den högsta andelen bussresor är i den lägsta ålderskategorin 
12–17 år där Z procent av resorna utförs med buss. 

## Vanligaste målpunkterna
<Information från 3.5.1 och 3.5.2>
Den vanligaste förekommande resan oavsett färdsätt inom ett område sker inom X följt av Y. Mellan två områden är den vanligaste förekommande reserelationen mellan X och Y följt av relationen X och Y.

# Inledning

Följande resvanerapport har tagits fram för att öka kunskapen om dagens resmönster för olika trafikantgrupper i `r (rapportomrade_text)`. Rapportens resultat avser att ge en bild av hur resandet ser ut en genomsnittlig vardag `r max(pers$ar)`. Resultatet utgör ett viktigt underlag för att planera för en hållbar tillväxt och ett hållbart resande. Rapporten är skapad genom ett automatiserat skript, framtaget av WSP på uppdrag av Region Uppsala. Skriptet läser och sammanställer data från kollektivtrafikbarometern, samt presenterar och kommenterar resultaten i löpande text. 

## Metod

Rapporten är baserad på data från Svensk Kollektivtrafiks Kollektivtrafikbarometern (https://www.svenskkollektivtrafik.se/verktyg-och-system/kollektivtrafikbarometern/). Kollektivtrafikbarometern är en branschgemensam nationell kvalitets- och resvaneundersökning som riktar sig till den svenska allmänheten mellan 15 och 85 år, både de som använder kollektivtrafiken och de som inte gör det. Till grunden av datainsamlingen ligger ett slumpmässigt och representativt individurval ur ett befolkningsregister utifrån postnummerområden.

Till skillnad från de flesta resvaneundersökningar utförs Kollektivtrafikbarometer kontinuerligt med dataleveranser varje månad. Fördelen med en kontinuerlig insamling är att säsongsvariationer utjämnas och enskilda händelser (tex mycket regn under insamlingsperioden) påverkar resultatet inte särskilt. Det är också möjligt i princip, dock inte med rapportverktyget, att följa trender över tid och analysera skillnader i resandet under olika årstider.

Datainsamlingen sker via en inbjudan som skickas via post till personer som ingår i urvalet. Bortfall, dvs personer med inbjudan som inte svarar, är ett viktigt kvalitetskriterium och ligger i nationellt snitt vid XX% och är därmed jämförbart med andra resvaneundersökningar. Kollektivtrafikbarometer använder sig dock av en speciell metod där en person som väljer att inte svara på enkäten ersätts genom utskick av inbjudan till en annan slumpmässigt vald person. Metoden säkerställer att beställaren får den beställda mängden besvarade enkäter. Jämförelse av fördelningen av kön och ålder bland personer som bevarar enkäten och befolkningen används för att bedöma om urvalet är representativt för befolkningen. 

Inbjudan som skickas till valda personer innehåller en länk till en webbportal där personen får svara på frågor. Varje svarsperson får registrera upp till fem resor som gjordes dagen innan. För varje resa besvaras ett antal frågor som tillexempel resans ärende, färdmedel och var resan började och avslutades. Resans start och slut registreras av svarspersonen i en onlinekarta. Respektive koordinater extraheras och bifogas till datatabellen.

Hanteringen av Kollektivtrafikbarometerns rådata är automatiserad med hjälp av ett skript som är skrivet i programmeringsspråket R (https://github.com/bjornsh/kollektivtrafikbarometer). I datahanteringen ingår kategorisering av resekoordinater, tex inom eller utanför en tätort, anonymisering som rensar bort personuppgifter ifall data ska delas utanför organisationen, och beräkning av reslängder med hjälp av Google directions API (https://developers.google.com/maps/documentation/directions/overview).

Produktionen av RVU-rapporten sker också genom ett skript. Skriptet möjliggör rapporter på region, kommun och tätort nivå genom filtrering av data. Rapportens geografiska omfattning och tidsperiod definieras i indata till skriptet.
För Kollektivtrafiksbarometerns enkät och andra bakgrundsdokument se länkar på https://github.com/bjornsh/kollektivtrafikbarometer 

```{r respondant_details, echo=FALSE, include = FALSE}
respondenter <- pers %>%
  mutate(Omrade = ifelse(is.na(Omrade), "Ej angivet", Omrade)) %>%
  select(Omrade, Omrade_kod, kon, alder) %>%
  group_by(Omrade) %>%
  summarize(Respondenter = n(),
            Man = sum(kon == "Man"), 
            Kvinnor = sum(kon == "Kvinna"),
            "15-24 år" = sum(alder >= 15 & alder < 25),
            "25-64 år" = sum(alder >= 25 & alder < 65),
            "65-85 år" = sum(alder >= 65),
            Omrade_kod = first(Omrade_kod)) %>%
  left_join(select(scb_befolkning, c(Omrade_kod,Befolkning)), by = c("Omrade_kod" = "Omrade_kod")) %>% #Lägger till befolkning per zon
  mutate(Befolkning = replace_na(Befolkning,0)) %>%
  select(-one_of("Omrade_kod")) %>%
  bind_rows(summarize(., 
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt")))

respondenter_tabell <- respondenter %>%
  select(!Befolkning)

svarsgrad <- respondenter %>%
  filter(Omrade != "Ej angivet") %>%
  #filter(Omrade != "Totalt") %>% #Först bör genomsnittlig andel svarande sparas
  mutate(Svarsfrekvens = Respondenter/Befolkning*100) %>%
  select(Omrade,Respondenter,Befolkning,Svarsfrekvens)

svarsgrad_tabell <- svarsgrad %>%
  mutate("Andel av befolkningen (%)" = round(Svarsfrekvens*10)/10) %>%
  select(!Svarsfrekvens)

svarsgrad_totalt <- pull(svarsgrad[nrow(svarsgrad),"Svarsfrekvens"])

#Försök att filtrera ut extremvärden för att kunna skriva om dem i texten.
svarsgrad_extremer_höga <- extremer_höga(svarsgrad,"Omrade","Svarsfrekvens")
svarsgrad_extremer_låga <- extremer_låga(svarsgrad,"Omrade","Svarsfrekvens")

##### Stycke som presenterar svarsgraden #####
text_andel_svarande <- paste("Andelen svarande av befolkningen (15 år och äldre) var i genomsnitt ",round(svarsgrad_totalt)," %. ")

max_antal_uppräknade <- 3 #hur många områden som maximalt ska lyftas fram

extremer <- svarsgrad_extremer_höga
if (nrow(extremer)>1){ #om det finns extremer
  #slice(which.max(Svarsfrekvens))
  text_andel_svarande <- paste(text_andel_svarande,"Särskilt hög var andelen svarande i ")
  #Uppräkning av områden
  text_uppräkning <- upprakning(rownames(extremer),max_antal_uppräknade)
  text_andel_svarande <- paste(text_andel_svarande,text_uppräkning,", där andelen svarande var upp emot ",round(extremer$Svarsfrekvens[1])," %. ",sep="")
  } else {
    svarsgrad_max <- slice(svarsgrad,which.max(Svarsfrekvens))
    text_andel_svarande <- paste(text_andel_svarande,"Högst andel svarande återfinns i ",svarsgrad_max$Omrade,", där andelen svarande var ",round(svarsgrad_max$Svarsfrekvens)," %. ",sep="")
}

extremer <- svarsgrad_extremer_låga
if (nrow(extremer)>1){ #om det finns extremer
  #slice(which.max(Svarsfrekvens))
  text_andel_svarande <- paste(text_andel_svarande,"Särskilt hög andel svarande återfinns i ")
  #Uppräkning av områden
  text_uppräkning <- upprakning(rownames(extremer),max_antal_uppräknade)
  text_andel_svarande <- paste(text_andel_svarande,text_uppräkning,", där andelen svarande var upp emot ",round(extremer$Svarsfrekvens[1])," %. ",sep="")
  } else {
    svarsgrad_min <- slice(svarsgrad,which.min(Svarsfrekvens))
    text_andel_svarande <- paste(text_andel_svarande,"Lägst andel svarande återfinns i ",svarsgrad_min$Omrade,", där andelen svarande var nära ",round(svarsgrad_min$Svarsfrekvens)," %. ",sep="")
  }

#textvariabler till kommande textstycke
if (omradesniva == 'deso')
  omradesniva_text <- 'DeSO-nivå'
if (omradesniva == 'tätort')
  omradesniva_text <- 'tätorts'
if (omradesniva == 'kommun')
  omradesniva_text <- 'kommun'

antal_individer <- nrow(pers)

```
## Population och urval

Kollektivtrafiksbarometerns attityd- och resvaneundersökning är en årlig och nationell enkätundersökning som strävar efter att fånga ett representativt urval av befolkningen i respektive region. För varje respondent lagras egenskaper som kön, ålder och koordinater till hemmet. I denna rapport har resultaten sammanfattats uppdelade geografiskt på `r (omradesniva_text)`.

Ur undersökningen har de `r (antal_individer)` respondenter som bor i `r (rapportomrade_text)` valts ut. I Tabell \@ref(tab:svarsfrekvens-table) återfinns befolkning, antal respondenter och andelen svarande av befolkningen. Andelen svarande ska ej förväxlas med svarsfrekvens (hur många av de tillfrågade som valde att svara på enkäten). Respondenternas kön och ålder per område finns redovisade i Tabell \@ref(tab:repondant-table).

```{r svarsfrekvens-table, echo = FALSE, results = "asis"}
kbl(svarsgrad_tabell, caption = "Antal svar jämfört med befolkningen (15 år och äldre) i respektive område", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(svarsgrad_tabell), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

`r (text_andel_svarande)` 

```{r repondant-table, echo = FALSE, results = "asis"}
#kable(respondenter, caption = "Antal svar per kön och åldersgrupp")
kbl(respondenter_tabell, caption = "Antal svar per kön och åldersgrupp", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(respondenter_tabell), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```
Eftersom svarsbenägenheten varierar mellan olika grupper av invånare kan viss skevhet i representationen uppstå, trots att urvalet från början gjorts på ett representativt sätt. Genom att använda en mixad insamlingsmetod, där fysisk post, telefon och sms har använts för att nå respondenterna, har svarsunderlaget kunnat hålla en bättre representativitet än traditionella underskningar. Viktning mot kön, ålder och urvalsområde har därför inte ansetts vara nödvändig.

# Resultat

Nedan presenteras sammanställningen av resultat från resvaneundersökningen.

## Körkort och biltillgång

Valet att färdas med bil, buss eller cykel eller att promenera är beroende av en mängd faktorer, såsom transportsystemets utbud och standard, attityder och kunskap, restriktioner och vanor. 
Avgörande för färdmedelsvalet är körkortsinnehav och biltillgång.

```{r korkort, echo=FALSE, include=FALSE}
korkort_bil <- pers %>%
  # filter(!(is.na(h4) & !(is.na(h5)))) %>% #Körkort och bilinnehav bör göras som två separata... Detta är åtgärdat i den förlorade koden...
  mutate(Omrade = ifelse(is.na(Omrade), "Ej angivet", Omrade)) %>%
  select(Omrade, h4, h5) %>%
  group_by(Omrade) %>%
  summarize(korkort_bil = sum(na.omit(h4) == 1),
            Biltillgång = sum(h5 == 1) + sum(h5 == 2) + sum(h5 == 3) + sum(h5 == 4),
            Antal_individer_korkort_svar = sum(!is.na(h4)),
            Antal_individer_bil_svar = sum(!is.na(h5))) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt"))) %>%
  mutate("Körkort (%)" = korkort_bil/Antal_individer_korkort_svar*100,
         "Biltillgång (%)" = Biltillgång/Antal_individer_bil_svar*100) %>%
  select(Omrade, "Körkort (%)", "Biltillgång (%)")

korkort_bil <- korkort_bil

körkort_totalt <- pull(korkort_bil[nrow(korkort_bil),"Körkort (%)"])

biltillgång_totalt <- pull(korkort_bil[nrow(korkort_bil),"Biltillgång (%)"])

körkort_min <- min(korkort_bil$"Körkort (%)")
```

```{r korkort_text, echo=FALSE, include=FALSE}
#Försök att filtrera ut extremvärden för att kunna skriva om dem i texten.

##### Stycke som presenterar körkortsinnehavet #####
text_korkort <- ""

max_antal_uppräknade <- 3 #hur många områden som maximalt ska lyftas fram

#Indata
tabell <- korkort_bil %>%
  rename(col="Körkort (%)") #Den kolumn som extremer ska tas ifrån
extremer <- extremer_höga(tabell,"Omrade",col) #Extremer som ska behandlas
#Skapar text
if (nrow(extremer)>1){ #om det finns extremer
                                  
  text_korkort <- paste(text_korkort,"Särskilt högt var körkortsinnehavet bland människor i ")
  #Uppräkning av områden
  text_uppräkning <- upprakning(rownames(extremer),max_antal_uppräknade)
                                                                                                           
                                                                                                                       
  text_korkort <- paste(text_korkort,text_uppräkning,", där andelen var upp emot ",round(extremer$col[1])," %. ",sep="")
  } else {
    max <- slice(tabell,which.max(col))
    text_korkort <- paste(text_korkort,"Störst körkortsinnehav återfanns i ",max$Omrade,", med ",round(max$col)," %. ",sep="")
}

extremer <- extremer_låga(tabell,"Omrade",col) #Extremer som ska behandlas
if (nrow(extremer)>1){ #om det finns extremer
                                  
  text_korkort <- paste(text_korkort,"Särskilt låg andel körkortsinnehavare återfanns i ")
  #Uppräkning av områden
  text_uppräkning <- upprakning(rownames(extremer),max_antal_uppräknade)
                                                                                                           
                                                                                                                       
  text_korkort <- paste(text_korkort,text_uppräkning,", där andelen var ner emot ",round(extremer$col[1])," %. ",sep="")
  } else {
    min <- slice(tabell,which.min(col))
    text_korkort <- paste(text_korkort,"Lägst var andelen med körkort i ",min$Omrade,", där andelen var nära ",round(min$col)," %. ",sep="")
  }

```

I `r (rapportomrade_text)` hade `r round(körkort_totalt)` procent av respondenterna körkort och `r round(biltillgång_totalt)` procent tillgång till bil. `r (text_korkort)`De som hade tillgång till bil varierade mellan  `r round(min(korkort_bil$"Biltillgång (%)"))` och `r round(max(korkort_bil$"Biltillgång (%)"))` procent. I Tabell \@ref(tab:korkort-bil-table) framgår körkortsinnehav och biltillgång för respektive område.

```{r korkort-bil-table, echo = FALSE, results = "asis"}
kbl(korkort_bil, caption = "Antal respondenter med körkort och biltillgång", booktabs = T, linesep = "",digits=0,format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(korkort_bil), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```
```{r antal_resor_text, echo=FALSE, include=FALSE}
#####Textproduktion#####

#Hittar åldersgrupp med störst andel personer som rest
num_trips_age_df <- as.data.frame(num_trips_age)
rownames(num_trips_age_df) <- num_trips_age_df$"Grupp" #ställer in indexkolumn
maxgrupp_andel_rest <- num_trips_age_df[which.max(num_trips_age_df$`Andel personer som rest (%)`),1]
maxgrupp_andel_rest_varde <- max(num_trips_age_df$`Andel personer som rest (%)`)

num_trips_gender_df <- num_trips_gender %>%
  as.data.frame() %>%
  `rownames<-`(.[,1])  %>% #skapar indexkolumn
  select(!(Grupp))

konjunktion <- ""
#Andel som rest
avvikelse <- (abs(1 - num_trips_gender_df["Man","Andel personer som rest (%)"] / num_trips_gender_df["Kvinna","Andel personer som rest (%)"]))
if (num_trips_gender_df["Man","Andel personer som rest (%)"] > num_trips_gender_df["Kvinna","Andel personer som rest (%)"]) {
  kön1a <- "män"
  kön2a <- "kvinnor"
} else {
  kön1a <- "kvinnor"
  kön2a <- "män"
}
if (avvikelse > 0.8) {
  text_kon <- paste("Andelen som rest bland ",kön1a," är högre än bland ",kön2a,". ",sep="")
  konjunktion <- "dock"
  konjunktion2 <- "dessutom"
} else {
    text_kon <- paste("Andelen som rest bland ",kön1a," och ",kön2a," var i samma storleksordning. ",sep="")
    konjunktion <- "dessutom"
    konjunktion2 <- "dock"
}


#Resor per dag för personer som rest
avvikelse <- abs((num_trips_gender_df["Man","Resor per dag för personer som rest"]-num_trips_gender_df["Kvinna","Resor per dag för personer som rest"])/(num_trips_gender_df["Kvinna","Resor per dag för personer som rest"]+num_trips_gender_df["Man","Resor per dag för personer som rest"]))
if (num_trips_gender_df["Man","Resor per dag för personer som rest"] > num_trips_gender_df["Kvinna","Resor per dag för personer som rest"]) {
  kön1b <- "män"
  kön2b <- "kvinnor"
} else {
  kön1b <- "kvinnor"
  kön2b <- "män"
}

ifelse(kön1a!=kön1b,konjunktion2 <- "däremot")

if (avvikelse>0.032) {
  text_kon <- paste(text_kon, "Bland de som reser var ",konjunktion2," antalet resor per dag större bland ",kön1b," än bland ",kön2b,". ",sep="")
  } else {
    text_kon <- paste(text_kon, "Bland de som reser var ",konjunktion," antalet resor per dag snarlikt mellan ",kön1b," och ",kön2b,". ",sep="")
    konjunktion <- "heller "
}

```

## Antal resor
En genomsnittlig dag gjorde `r round(num_trips_all$"Andel personer som rest (%)")` % av personer 15-85 år bosatta i `r (rapportomrade_text)` åtminstone en resa och totalt genomfördes `r round(num_trips_all$"Antal resor")` resor. Det motsvarar `r round(num_trips_all$"Resor per dag för alla personer")` resor per person och dag. I Tabell \@ref(tab:num-trips-table) framgår andel personer som rest och deras antal resor per dag redovisat per kön och ålderskategori.

`r text_kon` I åldersgruppen `r (maxgrupp_andel_rest)` var andelen som rest `r round(maxgrupp_andel_rest_varde)` procent, vilket är mer än övriga åldersgrupper.

```{r num-trips-table, echo = FALSE, results = "asis"}
x <- kbl(num_trips_rep, digits = 1, longtable = T, booktabs = T, linesep = "",caption = "Antal resor per dag per resenärsgrupp",format.args = list( big.mark = " ")) %>%
  #Captions appear to create problems with longtable package, gives error "mispaced align"
  #See here for solution, but don't know how to implement:
  #https://tex.stackexchange.com/a/205468
  kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header"),
                repeat_header_text = "\\textit{(fortsättning)}",
                repeat_header_continued = "\\textit{(Fortsätter på nästa sida...)}") %>%
  #row_spec(nrow(reslangd_per_omrade_rep), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) %>% #gör rubrikraden fetstilt
  column_spec(2:4, width = "2.5cm") %>%
  column_spec(1:1, width = "3cm") %>%
  column_spec(5:6, width = "1.6cm")

for (i in c(1:2)){
  x <- x %>%
    pack_rows(c('Kön','Ålder')[i], (i-1)*3+1, (i-1)*3+3,
              hline_after = TRUE)
}


 x <- x %>%
   pack_rows("Totalt", 7, 7,
             hline_after = TRUE,
             hline_before = TRUE)

x

```

## Resornas fördelning på färdsätt

I Figur \@ref(fig:omrade-diagram) framgår att `r (text_fardmedelsfordelning)`

```{r omrade-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per område."}
#Percent stacked barchart
palett <- c("#5144d3","#53a17f","#3599d5","#e6ad00","#d57667","#9e1863")
trip_person_mode_plot<-trip_mode %>%
  mutate(across(where(is.numeric), ~ . * 100))  %>%
  gather(fard,andel,Bil:Annat,factor_key=TRUE) %>% #Flag: Bil_Annat borde inte vara hårdkodat...
  mutate(andel=round(andel))
omrade_plot <- ggplot(data = trip_person_mode_plot, aes(fill =forcats::fct_rev(factor(fard,level = ordning_fardmedel)), x = andel, y = forcats::fct_rev(factor(Omrade)),label =andel)) + 
  theme(panel.background = element_blank(),legend.position="bottom") +
  geom_bar(position = "fill", stat = "identity")+
  geom_text(aes(label=ifelse(andel>3,andel," ")),size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett) + #färger
  labs(x="Andel",y="Omrade",fill="Färdmedel") +
  scale_x_continuous(labels = scales::percent)
omrade_plot
```

## Bakgrundfrågor

Nedan följer sammanställningar kopplade till respondenternas egenskaper.

### Färdsätt efter kön

```{r trips_gender, echo=FALSE, include=FALSE}
trip_mode_gender <- rvu %>%
  left_join(select(pers, c("respondentid","kon")), by = c("respondentid" = "respondentid")) %>% #Hämtar könskolumn från pers-data
  select(Omrade, Omrade_kod, kon, fardmedel.kat) %>%
  filter(!is.na(fardmedel.kat)) %>%
  group_by(kon,fardmedel.kat) %>%
  summarize(antal = n()) %>%
  spread(fardmedel.kat, antal, fill=0) %>%
  mutate(Totalt = rowSums(across(where(is.numeric)))) %>%
  #Räknar ut radsummor
  ungroup() %>%
  rename('Kön' = kon) %>%
    bind_rows(summarize(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~ "Totalt"))) %>% #Skapar totalrad
  select("Kön",ordning_fardmedel,"Totalt") %>%
  filter(Kön != "Okänt")

#Beräkna andel till diagram
trip_mode_gender_andel <- trip_mode_gender %>%
  mutate(across(where(is.numeric), ~ . / Totalt)) %>% #dividerar till procent av respondenter
  select(!Totalt)

#Skapar tabell med procent
trip_mode_gender_percent <- trip_mode_gender_andel %>%
  mutate(across(where(is.numeric), ~percent(.x, accuracy = 1)))

#Skapar tabell uppräknat på befolkningen
trip_mode_gender_abs <- trip_mode_gender_andel %>%
  mutate(Befolkning = (Kön == "Man")*sum(befolkning_per_område$Män) + (Kön == "Kvinna")*sum(befolkning_per_område$Kvinnor) + 
           (Kön == "Totalt")*(sum(befolkning_per_område$Kvinnor)+sum(befolkning_per_område$Män))) %>%
  mutate(across(where(is.numeric) & !Befolkning, ~ round(. * Befolkning)),
         Totalt = Befolkning) %>%
  select(!Befolkning) %>%
  filter(Kön != "Okänt")
```

```{r trips_gender_text, echo=FALSE, include=FALSE}
#####Textproduktion#####

respondenter_tabell_df <- respondenter_tabell %>%
  as.data.frame() %>%
  `rownames<-`(.[,1]) %>% #skapar indexkolumn
  select(!(Omrade))

andel_man <- respondenter_tabell_df["Totalt","Man"]/(respondenter_tabell_df["Totalt","Man"]+respondenter_tabell_df["Totalt","Kvinnor"])
andel_kvinnor <- respondenter_tabell_df["Totalt","Kvinnor"]/(respondenter_tabell_df["Totalt","Man"]+respondenter_tabell_df["Totalt","Kvinnor"])

trip_mode_gender_andel_df <- trip_mode_gender_andel %>%
  as.data.frame() %>%
  `rownames<-`(.[,1]) %>% #skapar indexkolumn
  select(!(Kön))

toleransnivå <- .02 #hur stor avvikelse i procentenheter som krävs för att skillnaden ska vara nämnbar.

man_storst <- c()
kvinna_storst <- c()
lika_stora <- c()

avvikelse <- trip_mode_gender_andel_df["Kvinna","Bil"] - trip_mode_gender_andel_df["Man","Bil"]
if (avvikelse > toleransnivå) {
  kvinna_storst <- append(kvinna_storst,"bil")
} else if (avvikelse < -toleransnivå) {
  man_storst <- append(man_storst,"bil")
} else {
  lika_stora <- append(lika_stora,"bil")
}

avvikelse <- (trip_mode_gender_andel_df["Kvinna","Tåg"]+trip_mode_gender_andel_df["Kvinna","Buss"]) -
  (trip_mode_gender_andel_df["Man","Tåg"]+trip_mode_gender_andel_df["Man","Buss"])
if (avvikelse > toleransnivå) {
  kvinna_storst <- append(kvinna_storst,"kollektivtrafik")
} else if (avvikelse < -toleransnivå) {
  man_storst <- append(man_storst,"kollektivtrafik")
} else {
  lika_stora <- append(lika_stora,"kollektivtrafik")
}

avvikelse <- trip_mode_gender_andel_df["Kvinna","Cykel"] - trip_mode_gender_andel_df["Man","Cykel"]
if (avvikelse > toleransnivå) {
  kvinna_storst <- append(kvinna_storst,"cykel")
} else if (avvikelse < -toleransnivå) {
  man_storst <- append(man_storst,"cykel")
} else {
  lika_stora <- append(lika_stora,"cykel")
}

text_fardmedel_kon <- ""
if (length(man_storst) > 0) {
  text_fardmedel_kon <- paste(text_fardmedel_kon,"Bland män står ",paste(man_storst, collapse = ' och '), " för en större del av resorna än bland kvinnor. ", sep = "")
}
if (length(kvinna_storst) > 0) {
  text_fardmedel_kon <- paste(text_fardmedel_kon,"För kvinnor var ", ifelse((length(man_storst) > 0),"istället "," "),paste(kvinna_storst, collapse = ' och '), " vanligare än bland män. ", sep = "")
}
if (length(lika_stora) == 3) {
  text_fardmedel_kon <- paste(text_fardmedel_kon,"Det fanns ingen märkbar skillnad på färdmedelsfördelningen för kvinnor respektive män. ", sep = "")
} else if (length(lika_stora) == 2) {
  text_fardmedel_kon <- paste(text_fardmedel_kon,"I övrigt fanns ingen märkbar skillnad på färdmedelsfördelningen för kvinnor respektive män. ", sep = "")
}

```
Andelen män och kvinnor i undersökningen är `r round(andel_man*100)` respektive `r round(andel_kvinnor*100)` %. Hur de reser brukar skilja sig åt. `r text_fardmedel_kon`

```{r kön-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per kön."}
#skapa Percent stacked barchart
temp_plot<-trip_mode_gender_andel %>%
  mutate(across(where(is.numeric), ~ . * 100))  %>%
  gather(Färdmedel,Andel,-Kön,factor_key=TRUE) %>%
  mutate(Andel=round(Andel))
gender_plot <- ggplot(data = temp_plot, aes(fill =forcats::fct_rev(factor(Färdmedel,level = ordning_fardmedel)), x = Andel, y = forcats::fct_rev(factor(Kön)),label =Andel)) +
  theme(panel.background = element_blank(),
        legend.position="bottom") +
  geom_bar(position = "fill", stat = "identity") +
  geom_text(aes(label=ifelse(Andel>3,Andel," ")),size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett) + #färger
  labs(x="Andel",y="Kön",fill="Färdmedel") +
  scale_x_continuous(labels = scales::percent)
gender_plot

```

### Färdsätt efter ålder

```{r trips_age, echo=FALSE, include=FALSE}

trip_age <- rvu %>%
  left_join(select(pers, c("respondentid","alder")), by = c("respondentid" = "respondentid")) %>% #Hämtar ålderskolumn från pers-data
  select(Omrade, Omrade_kod, alder, fardmedel.kat) %>%
  filter(!is.na(fardmedel.kat)) %>%
  group_by(alder = cut(alder, breaks = c(12, 17, 24, 39, 64, 74, 85)),fardmedel.kat) %>%
  # left_join(select(scb_befolkning, c(Omrade_kod,Ålder_15_24,Ålder_25_64,Ålder_65)), by = c("Omrade_kod" = "Omrade_kod")) %>%
  # group_by(Omrade,alder,fardmedel.kat) %>%
  # summarize("Befolkning" = sum(Befolkning))
  summarize(antal = n()) %>%
  spread(fardmedel.kat, antal, fill=0) %>%
  mutate(Totalt = rowSums(across(where(is.numeric)))) %>%
  #Räknar ut radsummor
  ungroup() %>%
  mutate(alder = c(
    "15-18 år",
    "18-24 år",
    "25-39 år",
    "40-64 år",
    "65-74 år",
    "75-85 år"
    )) %>%
  rename('Ålder' = alder) %>%
    bind_rows(summarize(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~ "Totalt"))) %>% #Skapar totalrad
  select("Ålder",ordning_fardmedel,"Totalt")

```

Åldersgruppen `r num_trips_age$Grupp[1]` utgör `r round(100*num_trips_age$Befolkning[1]/sum(num_trips_age$Befolkning))` procent, gruppen `r num_trips_age$Grupp[2]` `r round(100*num_trips_age$Befolkning[2]/sum(num_trips_age$Befolkning))` procent och gruppen `r num_trips_age$Grupp[3]` `r round(100*num_trips_age$Befolkning[3]/sum(num_trips_age$Befolkning))` procent av den undersökta befolkningen. I Figur \@ref(fig:alder-diagram) nedan jämförs färdsättsanvändning i olika åldersgrupper.

```{r alder-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per åldersgrupp."}
#Plockar fram befolkning per åldersgrupp i områdena
# befolkning_per_område <- rvu %>%
#   filter(!is.na(fardmedel.kat)) %>%
#   group_by(Omrade_kod) %>%
#   summarise(Omrade_kod = first(Omrade_kod)) %>%
#   left_join(select(scb_befolkning, c(Omrade_kod,Ålder_15_19,Ålder_20_24,Ålder_25_39,Ålder_40_64,Ålder_65_74,Ålder_75)), by = c("Omrade_kod" = "Omrade_kod"))

#Beräkna andel till diagram
trip_age_andel <- trip_age %>%
  mutate(across(where(is.numeric), ~ . / Totalt)) %>% #dividerar till procent av respondenter
  select(!Totalt)

#Skapar tabell med procent
trip_age_percent <- trip_age_andel %>%
  mutate(across(where(is.numeric), ~percent(.x, accuracy = 1)))

#Samlar befolkningssumma per ålder i området
befolkning_per_alder <- befolkning_per_område %>%
  ungroup() %>%
  bind_rows(summarize(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~ "Totalt"))) %>%
  filter(Omrade == "Totalt") %>%
  select(starts_with("Ålder"),"Befolkning")


#Skapar tabell uppräknat på befolkningen
trip_age_abs <- trip_age_andel %>%
  mutate(Befolkning = as.numeric(c(befolkning_per_alder))) %>%
    mutate(across(where(is.numeric) & !Befolkning, ~ round(. * Befolkning)),
         Totalt = Befolkning) %>%
  select(!Befolkning) 

#skapa Percent stacked barchart
temp_plot<-trip_age_andel %>%
  mutate(across(where(is.numeric), ~ . * 100))  %>%
  gather(Färdmedel,Andel,-Ålder,factor_key=TRUE) %>%
  mutate(Andel=round(Andel))
age_plot <- ggplot(data = temp_plot, aes(fill =forcats::fct_rev(factor(Färdmedel,level = ordning_fardmedel)), x = Andel, y = forcats::fct_rev(factor(Ålder)),label =Andel))  + 
  theme(panel.background = element_blank(),
        legend.position="bottom") +
  # scale_y_discrete(limits = rev(unique(temp_plot$Ålder))) +
  geom_bar(position = "fill", stat = "identity") +
  geom_text(aes(label=ifelse(Andel>3,Andel," ")),size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett) + #färger
  labs(x="Andel",y="Ålder",fill="Färdmedel") +
  scale_x_continuous(labels = scales::percent)
age_plot
```

```{r ålder-text, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per åldersgrupp."}
trip_age_andel_df <- trip_age_andel %>%
  filter(Ålder!="Totalt") %>%
  as.data.frame() %>%
  `rownames<-`(.[,1]) %>% #skapar indexkolumn
  select(!(Ålder)) %>%
  mutate(Kollektivtrafik = Buss + Tåg)

mest_bil <- rownames(trip_age_andel_df)[which.max(trip_age_andel_df$Bil)]
mest_koll <- rownames(trip_age_andel_df)[which.max(trip_age_andel_df$Kollektivtrafik)]
mest_cykel <- rownames(trip_age_andel_df)[which.max(trip_age_andel_df$Cykel)]

bil_okande <- (sum(arrange(trip_age_andel_df,Bil)==trip_age_andel_df) == nrow(trip_age_andel_df)*ncol(trip_age_andel_df))
koll_sjunkande <- (sum(arrange(trip_age_andel_df,desc(Kollektivtrafik))==trip_age_andel_df) == nrow(trip_age_andel_df)*ncol(trip_age_andel_df))
cykel_sjunkande <- (sum(arrange(trip_age_andel_df,desc(Cykel))==trip_age_andel_df) == nrow(trip_age_andel_df)*ncol(trip_age_andel_df))
```

`r ifelse(which.max(trip_age_andel_df$Kollektivtrafik)==1,"De yngsta",paste("Åldersgruppen",mest_koll))` åker i högre utsträckning med kollektivtrafiken än övriga grupper. `r ifelse(koll_sjunkande,"Kollektivtrafiksandelen sjunker sedan med stigande ålder","")`. `r ifelse(mest_koll==mest_cykel,"Det också","Däremot är det")` åldersgruppen `r mest_cykel` som gör fler cykelresor än övriga grupper. Andelen bilresor `r ifelse(bil_okande,"ökar med stigande med ålder och ","")` är högst i ålderskategorin `r mest_bil`r, där `r round(max(trip_age_andel_df$Bil)*100)` procent av resorna görs med bil.

### Färdsätt efter sysselsättning

```{r sysselsättning_analys, echo=FALSE, include = FALSE}
svarsnyckel <- labels_data %>%
  filter(question_id=="H2") %>%
  select(answer_id,answer)

```

```{r trip_sys_mode, echo=FALSE, include = FALSE}
svarsnyckel <- labels_data %>%
  filter(question_id=="H2") %>%
  select(answer_id,answer)

trip_sys_mode <- rvu %>%
    left_join(select(pers, c("respondentid","h2")), by = c("respondentid" = "respondentid")) %>% #Hämtar kolumn h2 från pers-data %>%
    select(Omrade, Omrade_kod, h2, fardmedel.kat) %>%
    filter(!is.na(fardmedel.kat)) %>%
    left_join(svarsnyckel, by = c("h2" = "answer_id")) %>%
    group_by(answer,fardmedel.kat) %>%
    summarize(antal = n()) %>%
    spread(fardmedel.kat,antal, fill=0) %>%
    mutate(Totalt = rowSums(across(where(is.numeric)))) %>%
    ungroup() %>%
    rename("Sysselsättning" = answer) %>%
    bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Totalt"))) %>% #Skapar totalrad
    select("Sysselsättning",ordning_fardmedel,"Totalt") %>%
    filter(Sysselsättning != "Vet ej/Vill ej svara")

#Beräkna andel till diagram
trip_sys_mode_andel <- trip_sys_mode %>%
  mutate(across(where(is.numeric), ~ . / Totalt)) %>% #dividerar till procent av respondenter
  select(!Totalt)

#Skapar tabell med procent
trip_sys_mode_percent <- trip_sys_mode_andel %>%
  mutate(across(where(is.numeric), ~percent(.x, accuracy = 1)))
```

```{r sys-omrade, echo=FALSE, include = FALSE}
#Denna information används i texten nedan, samt i Detaljerade tabeller i bilagor
sys_omrade <- rvu %>%
    left_join(select(pers, c("respondentid","h2")), by = c("respondentid" = "respondentid")) %>% #Hämtar kolumn h2 från pers-data %>%
    select(Omrade, Omrade_kod, h2, fardmedel.kat) %>%
    filter(!is.na(fardmedel.kat)) %>%
    left_join(svarsnyckel, by = c("h2" = "answer_id")) %>%
    left_join(select(scb_befolkning, c(Omrade_kod,Befolkning)), by = c("Omrade_kod" = "Omrade_kod")) %>%
    group_by(Omrade,answer) %>%
    summarize(antal = n(),
              "Befolkning" = first(Befolkning)) %>%
    spread(answer,antal, fill=0) %>%
    mutate(Totalt = rowSums(across(where(is.numeric)))-Befolkning) %>%
  #Räknar ut radsummor
    ungroup() %>%
    bind_rows(summarize(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~ "Totalt"))) %>% #Skapar totalrad
    mutate(across(where(is.numeric) & !Befolkning, ~ . / Totalt)) %>% #dividerar till procent av respondenter
    select(!Totalt)

sys_omrade_totalt <- sys_omrade %>%
  filter(Omrade == "Totalt")

sys_omrade_percent <- sys_omrade %>%
  select(!Befolkning) %>%
  mutate(across(where(is.numeric), ~percent(.x, accuracy = 1)))

sys_omrade_abs <- sys_omrade %>%
  mutate(across(where(is.numeric) & !Befolkning, ~ round(. * Befolkning)),
         Totalt = Befolkning) %>%
  select(!Befolkning)
```

```{r sys-omrade-text, echo=FALSE, include = FALSE}
#Transformerar till dataframe
trip_sys_mode_df <- trip_sys_mode_andel %>%
  as.data.frame() %>%
  `rownames<-`(.[,1])  %>% #skapar indexkolumn
  select(!(Sysselsättning)) %>%
  mutate(Kollektivtrafik = Buss + Tåg)

#Räknar ut vanligaste färdmedlet i respektive område
trip_sys_mode_max <- trip_sys_mode_df %>%
  mutate('max' = names(trip_sys_mode_df)[max.col(trip_sys_mode_df, "first")])

#Plockar ut det vanligaste färdmedlet totalt sett
mest_frekvent_färdmedel <- trip_sys_mode_max["Totalt","max"]

#Plockar ut det vanligaste färdmedlets andelar
mest_frekvent_andel <- trip_sys_mode_max["Totalt",mest_frekvent_färdmedel]

#Skapar en lista med områden som har ett avvikande vanligaste färdmedel
avvikande_vanligaste_färdmedel <- trip_sys_mode_max %>%
  filter(max != mest_frekvent_färdmedel)


mest_bil <- rownames(trip_sys_mode_df)[which.max(trip_sys_mode_df$Bil)]
mest_koll <- rownames(trip_sys_mode_df)[which.max(trip_sys_mode_df$Kollektivtrafik)]
mest_cykel <- rownames(trip_sys_mode_df)[which.max(trip_sys_mode_df$Cykel)]
minst_bil <- rownames(trip_sys_mode_df)[which.min(trip_sys_mode_df$Bil)]
minst_koll <- rownames(trip_sys_mode_df)[which.min(trip_sys_mode_df$Kollektivtrafik)]
minst_cykel <- rownames(trip_sys_mode_df)[which.min(trip_sys_mode_df$Cykel)]

```

I åldern 15–85 år är `r round(sys_omrade_totalt$"Förvärvsarbetande/egen företagare"*100)` procent förvärvsarbetande, `r round(sys_omrade_totalt$Studerande*100)` procent studerande, `r round(sys_omrade_totalt$Pensionär*100)` procent är pensionärer. `r mest_frekvent_färdmedel` är det vanligaste färdmedlet för samtliga grupper `r ifelse(nrow(avvikande_vanligaste_färdmedel)>0,paste("Förutom för",upprakning(rownames(avvikande_vanligaste_färdmedel),10)),"")`. Bil användes i störst utsträckning av gruppen `r tolower(mest_bil)` och minst i gruppen `r tolower(minst_bil)`. Kollektivtrafiksandelen var högst i gruppen `r tolower(mest_koll)`. Störst andel cykelresor stod gruppen `r tolower(mest_cykel)` för.


```{r sys-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per sysselsättning"}
#skapa Percent stacked barchart 

temp_plot<-trip_sys_mode_andel %>%
  mutate(across(where(is.numeric), ~ . * 100)) %>%
  gather(Färdmedel,Andel,-Sysselsättning,factor_key=TRUE) %>%
  mutate(Andel=round(Andel))
sys_plot <- ggplot(data = temp_plot, aes(fill =forcats::fct_rev(factor(Färdmedel,level = ordning_fardmedel)), x = Andel, y = forcats::fct_rev(factor(Sysselsättning)),label =Andel)) +
  theme(panel.background = element_blank(),
        legend.position="bottom") +
  scale_y_discrete(limits = rev(unique(temp_plot$Sysselsättning))) + #Placerar ärendekategorierna i en bättre ordning
  geom_bar(position = "fill", stat = "identity") +
  geom_text(aes(label=ifelse(Andel>3,Andel," ")),size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett) + #färger
  labs(x="Andel",y="Sysselsättning",fill="Färdmedel") +
  scale_x_continuous(labels = scales::percent)
sys_plot

```

```{r trip-sys-mode-table, echo = FALSE, result="asis"}
# kable(trip_sys_mode, caption = "Resärende per färdmedel", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
#   kable_styling(latex_options = c("striped", "HOLD_position")) %>%
#   row_spec(nrow(trip_sys_mode), bold = T) %>% #gör Total-raden fetstilt
#   row_spec(0, bold = T) #gör rubrikraden fetstilt)
```

### Färdsätt efter ärende

```{r purpose_analysis, echo=FALSE, include = FALSE}
svarsnyckel_arende <- labels_data %>%
  filter(question_id=="B2_R1") %>%
  select(answer_id,answer)

rvu_purp <- rvu %>%
    select(resa_nr, respondentid, b2) %>%
    left_join(svarsnyckel_arende, by = c("b2" = "answer_id")) %>%
    group_by(answer) %>%
    summarise(antal = n())

top_purpose <- rvu_purp %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==1)
top_purpose_2 <- rvu_purp %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==2)

top_purpose <- top_purpose$answer
top_purpose_2 <- top_purpose_2$answer

rvu_purp_rep <- rvu_purp %>%
    rename(
        'Ärende' = answer,
        'Antal svar' = antal
    )

```

```{r trip_purpose_mode, echo=FALSE, include = FALSE}
#Flag: bör itne vara hårdkodad med färdmedel...
trip_purpose_mode <- rvu %>%
    select(b2, fardmedel.kat) %>%
    filter(!is.na(fardmedel.kat)) %>%
    left_join(svarsnyckel_arende, by = c("b2" = "answer_id")) %>%
    group_by(answer) %>%
    summarise("Bil" = sum(fardmedel.kat == "Bil", na.rm = TRUE),
              "Tåg" = sum(fardmedel.kat == "Tåg", na.rm = TRUE),
              "Buss" = sum(fardmedel.kat == "Buss", na.rm = TRUE),
              "Cykel" = sum(fardmedel.kat == "Cykel", na.rm = TRUE),
              "Gång" = sum(fardmedel.kat == "Gång", na.rm = TRUE),
              "Annat" = sum(fardmedel.kat == "Annat", na.rm = TRUE),
              "Totalt" = n()) %>%
    bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Totalt"))) %>%
    rename("Ärende" = answer)
```

<Exempeltext>
Resor till bostaden utgör en stor del av alla resor. I denna mätning är andelen X procent och andelen som gjordes till arbete var X procent. Av de resor som gjordes av de som har haft arbete som ärende för resan är X procent bilresor, X procent bussresor, X procent cykelresor och X procent är gångförflyttningar och X procent övrigt.

```{r ärende-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per ärende"}
#beräkna andel
temp_plot<-trip_purpose_mode
# colnames(temp_plot)[which(names(temp_plot) == "Annat")] <- "Övrigt"
temp_plot <- temp_plot %>%
  mutate("Bil" = 100*Bil / Totalt,
          "Tåg" = 100*Tåg / Totalt,
          "Buss" =  100*Buss / Totalt,
          "Cykel" = 100*Cykel / Totalt,
          "Gång" = 100*Gång / Totalt,
         "Annat" = 100*Annat / Totalt) %>%
  select(-Totalt)

#skapa Percent stacked barchart 

temp_plot<-temp_plot %>%
  gather(Färdmedel,Andel,-Ärende,factor_key=TRUE) %>%
  mutate(Andel=round(Andel))
purpose_plot <- ggplot(data = temp_plot, aes(fill =forcats::fct_rev(factor(Färdmedel,level = ordning_fardmedel)), x = Andel, y = forcats::fct_rev(factor(Ärende)),label =Andel)) +
  theme(panel.background = element_blank(),
        legend.position="bottom") +
  scale_y_discrete(limits = rev(unique(temp_plot$Ärende))) + #Placerar ärendekategorierna i en bättre ordning
  geom_bar(position = "fill", stat = "identity") +
  geom_text(aes(label=ifelse(Andel>3,Andel," ")),size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett) + #färger
  labs(x="Andel",y="Ärende",fill="Färdmedel") +
  scale_x_continuous(labels = scales::percent)
purpose_plot

```

```{r trip-purpose-mode-table, echo = FALSE, result="asis"}
# kable(trip_purpose_mode, caption = "Resärende per färdmedel", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
#   kable_styling(latex_options = c("striped", "HOLD_position")) %>%
#   row_spec(nrow(trip_purpose_mode), bold = T) %>% #gör Total-raden fetstilt
#   row_spec(0, bold = T) #gör rubrikraden fetstilt)
```


## Reslängd och fordonskilometer

I resdagboken har intervjupersonerna fått fylla i plats för resmål, som sparats i staitisiken i form av koordinater. Dessa koordinater har använts för att uppskatta avstånd för varje resa med respektive färdmedel. Det partiella bortfallet på grund av avsaknade koordinater är `r round(count(filter(rvu,!is.na(avstand)))/count(rvu)*100)` procent. Den sammanlagda ressträckan som utövas av alla individer kallas 'trafikarbete' och mäts i fordonskilometer. I det här fallet betecknar detta det totala antalet kilometer som invånarna inom respektive område har förflyttat sig med respektive färdmedel under en genomsnittsdag.

I Tabell \@ref(tab:reslangd-per-omrade-tabell) framgår median, medelvärde, samt totalt antal fordonskilometer per område, respektive färdmedel. I tabellerna exkluderas resor som saknar angivna start- och slutkoordinater, samt de som saknar specifikation om färdmedel. I de fall underlaget är färre än `r tolower(tillräckligt_underlag)` respondenter, utelämnas resultatet.

För boende i X är en typisk resa särskilt kort, X km. De längsta resorna återfinns i Y, med en typresa på Y km. I X gör den största sammanlagda förflyttningen med X fordonskilometer, medan Y står för det minsta antalet fordonskilometer.

```{r reslangd-per-omrade-tabell, echo = FALSE, results = "asis"}
x <- kbl(reslangd_per_omrade_ny, digits = 1, longtable = T, booktabs = T, linesep = "",caption = "Reslängd per resa och totalt antal fordonskilometer per område.",format.args = list( big.mark = " ")) %>%
  #Captions appear to create problems with longtable package, gives error "mispaced align"
  #See here for solution, but don't know how to implement:
  #https://tex.stackexchange.com/a/205468
  kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header"),
                repeat_header_text = "\\textit{(fortsättning)}",
                repeat_header_continued = "\\textit{(Fortsätter på nästa sida...)}") %>%
  #row_spec(nrow(reslangd_per_omrade_rep), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) %>% #gör rubrikraden fetstilt
  column_spec(2:4, width = "2.5cm") %>%
  column_spec(1:1, width = "3cm") %>%
  column_spec(5:6, width = "1.6cm")
x
```

`r (mest_frekvent_färdmedel_km)` är det vanligaste färdmedlet med `r tolower(mest_frekvent_färdmedel_km)` fordonskilometer, vilket motsvarar (`r round(mest_frekvent_färdmedel_km_andel*100)` % av det totala antalet fordonskilometrar för samtliga trafikslag för boende i `r (rapportomrade_text)`.

En typisk resa (medianen av alla resor) är `r round(reslangd_summa_tot$Median/1000)` kilometer lång. Längst är resorna med `r tolower(langst_resor_fardmedel)`, med en typresa på `r round(langst_resor_fardmedel_varde/1000)` kilometer. Kortast är resorna med `r tolower(kortast_resor_fardmedel)`, med en typresa på `r round(kortast_resor_fardmedel_varde/1000)` km.

```{r reslangd-per-fardmedel-tabell, echo = FALSE, results = "asis"}
x <- kbl(reslangd_summa_ny, digits = 1, longtable = T, booktabs = T, linesep = "",caption = "Reslängd per resa och totalt antal fordonskilometer per färdmedel",format.args = list( big.mark = " ")) %>%
  #Captions appear to create problems with longtable package, gives error "mispaced align"
  #See here for solution, but don't know how to implement:
  #https://tex.stackexchange.com/a/205468
  kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header"),
                repeat_header_text = "\\textit{(fortsättning)}",
                repeat_header_continued = "\\textit{(Fortsätter på nästa sida...)}") %>%
  #row_spec(nrow(reslangd_per_omrade_rep), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) %>% #gör rubrikraden fetstilt
  column_spec(2:4, width = "2.5cm") %>%
  column_spec(1:1, width = "3cm") %>%
  column_spec(5:6, width = "1.6cm")
x
```

```{r travel_dist-table1, echo = FALSE, results = "asis"}
# antal_omraden = unique(reslangd_per_omrade_rep$Omrade)
# 
# reslangd_per_omrade_rep <- reslangd_per_omrade_rep %>%
#   select(-Omrade)
# 
# x <- kbl(reslangd_per_omrade_rep, longtable = T, booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
#   #Captions appear to create problems with longtable package, gives error "mispaced align"
#   #See here for solution, but don't know how to implement:
#   #https://tex.stackexchange.com/a/205468
#   kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header"),
#                 repeat_header_text = "\\textit{(fortsättning)}",
#                 repeat_header_continued = "\\textit{(Fortsätter på nästa sida...)}") %>%
#   row_spec(nrow(reslangd_per_omrade_rep), bold = T) %>% #gör Total-raden fetstilt
#   row_spec(0, bold = T) #gör rubrikraden fetstilt
# 
# for (i in c(1:(length(antal_omraden)-1))){
#   x <- x %>%
#     pack_rows(antal_omraden[i], (i-1)*5+1, (i-1)*5+5,
#               hline_after = TRUE)
# }
# 
# x <- x %>%
#   pack_rows("Alla", (length(antal_omraden)-1)*5+1, (length(antal_omraden)-1)*5 + 6,
#             hline_after = TRUE,
#             hline_before = TRUE)
# 
# x

```

<Exempeltext>
Andelen resor som genomförs med bil ökar ju längre resan är. Kollektivtrafiksresandet... Cykelandelen är som högst för resor på ca X km och sjunker sedan successivt med ökat avstånd. Gång-
andelen är som högst vid riktigt korta avstånd.

Nedan följer ett diagram som visar färdmedelsfördelnjing per reslängd.

```{r avstånds-diagram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per avståndsklass."}
#Lägger till avståndsklass per resa
rvu_avs <- rvu %>%
  filter(!is.na(avstand)&avstand>0) %>%
  rename(Färdmedel = fardmedel.kat) %>%
  select(respondentid,Färdmedel,avstand,Omrade,Omrade_kod)
rvu_avs$km <- round(rvu_avs$avstand/1000)
rvu_avs <- rvu_avs %>%
  group_by(kmklass = cut(km, breaks = c(0, 2, 5, 10, 25, 50, 1000)))

#rvu_avs$kmklass<-ifelse(rvu_avs$km>32/4,32,rvu_avs$km*4)
rvu_avs$antal<-1

#Aggregerar avståndsklasser
agg_rvu_avs <-
  aggregate(rvu_avs[,c('antal'), drop=FALSE], by=list(
    avstand = rvu_avs$kmklass,
    fard = rvu_avs$Färdmedel
  ),
  FUN = sum) 
agg_rvu_avs<-spread(agg_rvu_avs,key=fard,value=antal)
agg_rvu_avs[is.na(agg_rvu_avs)]<-0
agg_rvu_avs$Totalt<-agg_rvu_avs$Bil+agg_rvu_avs$Buss+agg_rvu_avs$Tåg+agg_rvu_avs$Cykel+agg_rvu_avs$Gång
agg_rvu_avs <- agg_rvu_avs[c("avstand","Bil","Tåg","Buss","Cykel","Gång","Totalt")]
agg_rvu_avs <- mutate(agg_rvu_avs,avstand = c(
    "0-2",
    "2-5",
    "5-10",
    "10-25",
    "25-50",
    "50+"
  )) 


#Skapar ett procentuellt stapeldiagram
temp_plot <- agg_rvu_avs %>%
  mutate("Bil" = 100*Bil / Totalt,
         "Tåg" = 100*Tåg / Totalt,
         "Buss" =  100*Buss / Totalt,
         "Cykel" = 100*Cykel / Totalt,
         "Gång" = 100*Gång / Totalt) %>%
  select(-Totalt) %>%
  gather(Färdmedel,Andel,Bil:Gång,factor_key=TRUE) %>%
  mutate(Andel=round(Andel))
avstand_plot <- ggplot(data = temp_plot, aes(fill =forcats::fct_rev(factor(Färdmedel,level = ordning_fardmedel)), y = Andel, x = factor(avstand),label =Andel)) +
  geom_bar(position = "fill", stat = "identity") +
  geom_text(data=temp_plot[temp_plot$Andel>3,],size = 3, position = position_fill(vjust = 0.5)) + #etiketter
  scale_fill_manual(values=palett[-(1:1)]) + #färger
  labs(y="Andel",x="Avstånd (km)",fill="Färdmedel") +
  scale_y_continuous(labels = scales::percent)
avstand_plot
```
```{r avstånds-histogram, echo = FALSE, results = "asis", fig.cap = "Resornas färdmedelsfördelning per avståndsklass."}

# agg_rvu_avs_hist <- agg_rvu_avs %>%
#   select(avstand,Totalt) %>%
#   mutate(avstand=as.factor(avstand))
# 
# agg_rvu_avs_histplot <- ggplot(agg_rvu_avs_hist, aes(avstand, Totalt, fill = avstand)) +
#     geom_bar(stat = "identity") +
#     rvu_theme() +
#     scale_fill_brewer(palette = "Set3") +
#     labs(
#         x = "Avstånd",
#         y = "Antal resor",
#         title = "Avståndsfördelning."
#     )
# 
# 
# agg_rvu_avs_histplot
```

### Reserelationer inom `r (rapportomrade_rubrik)`

```{r od_matrix, echo=FALSE, include = FALSE}

minsta_antal <- 10

#Skapar od-matris för alla resor
od_matrix <- rvu %>%
    filter(start_rapportomrade_namn %in% rapportomrade & stop_rapportomrade_namn %in% rapportomrade) %>%
    select(start_omrade_namn, stop_omrade_namn) %>%
    filter(!is.na(start_omrade_namn)) %>%
    filter(!is.na(stop_omrade_namn)) %>%
    group_by(start_omrade_namn, stop_omrade_namn) %>%
    summarize(antal = n()) %>%
    pivot_wider(names_from = stop_omrade_namn, values_from = antal, values_fill = 0) %>%
    ungroup()

minsta_antal <- min(minsta_antal,nrow(od_matrix))

#Skapar totalkolumn
od_matrix <- od_matrix %>%
  mutate("Totalt" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>%
  arrange(desc(Totalt))

#Filtrerar ut populäraste områden på rader samt skapar total- och övriga områden-rader
od_matrix <- od_matrix %>%
  top_n(minsta_antal) %>%
    bind_rows(
      od_matrix %>%
        filter(!(start_omrade_namn %in% top_n(od_matrix,minsta_antal)$start_omrade_namn)) %>%
        summarise_if(is.numeric, sum) %>%
        mutate(start_omrade_namn = "Övriga områden")
    ) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt")))

#Filtrerar bort kolumner
lista_med_omraden <- pull(od_matrix,start_omrade_namn)
od_matrix <- od_matrix %>%
  select(start_omrade_namn,lista_med_omraden[1:minsta_antal],Totalt) %>%
  rename("Från område" = start_omrade_namn) %>%
  mutate("Övriga områden" = -rowSums(select_if(., is.numeric), na.rm = TRUE)+2*Totalt) %>%
  relocate(Totalt, .after = "Övriga områden")

#Omvandlar till dataframe
od_matrix <- as.data.frame(od_matrix) #Omvandalr till dataframe
rownames(od_matrix) <- od_matrix$"Från område" #Sätter från som indexkolumn
od_matrix <- select(od_matrix,!c("Från område")) #Tar bort dublettkolumn

#Plockar ut maxrelationen
od_matrix_plain <- od_matrix[1:(nrow(od_matrix)-2),1:(ncol(od_matrix)-2)] #utan övriga och total-rader/kolumner
od_matrix_plain_mellan <- (diag(nrow(od_matrix_plain))-1)*-1
max <- which(od_matrix_plain_mellan == max(od_matrix_plain_mellan), arr.ind = TRUE)
max_fran <- rownames(od_matrix_plain_mellan)[max[1]]
max_till <- colnames(od_matrix_plain_mellan)[max[2]]

#Plockar ut störst inom området-resor
od_matrix_plain_diag <- diag(nrow(od_matrix_plain))*od_matrix_plain
max <- which(od_matrix_plain_diag == max(od_matrix_plain_diag), arr.ind = TRUE)
max_inom <- rownames(od_matrix_plain)[max[1]]

#Tar bort övrigt-raden om noll
od_matrix <- od_matrix %>%
  filter(Totalt > 0) %>%
  select(which(colSums(.) > 0))

#Skapar procent-matris
od_matrix_perc <- od_matrix/od_matrix["Totalt","Totalt"]
od_matrix_perc <- mutate(od_matrix_perc,across(where(is.numeric), ~percent(.x, accuracy = 1))) #Skapar tabell med procent
```

<Exempeltext>
X procent av resorna sker inom `r (rapportomrade_text)`. 
Den vanligaste förekommande resan inom ett område sker i  `r (max_inom)`. Den vanligaste resan mellan två områden är från `r (max_fran)` till `r (max_till)`.

```{r od-matrix-table, echo = FALSE, result="asis"}
kable(od_matrix_perc, caption = "Fördelning av resorna inom rapportområdet. Radrubrik visar var resar börjar och kolumnrubriker visar var resan slutar.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(nrow(od_matrix_perc), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T, angle = 45) %>% #gör rubrikraden fetstilt)
  column_spec(1, bold = T, width = "2cm")
```
### Utpendling från `r (rapportomrade_rubrik)`


```{r od_matrix_extern, echo=FALSE, include = FALSE}

minsta_antal <- 10

#Skapar od-matris för alla resor
utpendling <- rvu %>%
    select(start_rapportomrade_namn, stop_rapportomrade_namn) %>%
    filter(!is.na(start_rapportomrade_namn)) %>%
    filter(!is.na(stop_rapportomrade_namn)) %>%
    filter(start_rapportomrade_namn %in% rapportomrade) %>%
    group_by(stop_rapportomrade_namn) %>%
    summarize(antal = n()) %>%
    ungroup()

#minsta antal får aldrig vara större än antalet områden
minsta_antal <- min(minsta_antal,nrow(od_matrix))
# summa <- sum(utpendling$antal)

inom_omrade <- utpendling %>%
  filter(stop_rapportomrade_namn == rapportomrade)
andel_inom <- sum(inom_omrade$antal)/sum(utpendling$antal)

#Filtrerar ut största och sorterar
utpendling <- utpendling %>%
  filter(!(stop_rapportomrade_namn %in% rapportomrade)) %>%
  top_n(minsta_antal) %>%
  arrange(desc(antal)) %>%
  mutate(perc = antal/sum(antal))#%>%
  # mutate(antal = antal/summa) %>%
  # mutate(across(where(is.numeric), ~percent(.x, accuracy = 1))) 


```
Av alla resor utgår från `r (rapportomrade_rubrik)`, görs `r round(100-andel_inom*100)` % till andra områden. Nedan sammanställs utpendlingen för boende i `r (rapportomrade_rubrik)` uttryckt som andelar av resorna som startar i tätorten. Anledningen till att inte inpendling kan redovisas är att urvalet ur resvaneundersökningen enbart omfattar boende i `r (rapportomrade_rubrik)`.

```{r od-matrix-extern-table, echo = FALSE, result="asis"}
utpendling_barplot <- ggplot(utpendling, aes(stop_rapportomrade_namn, perc, fill = stop_rapportomrade_namn)) +
    geom_bar(stat = "identity") +
    rvu_theme() +
   scale_y_continuous(labels = scales::percent) +
    coord_cartesian(xlim = c(1,nrow(utpendling))) +
    geom_text(aes(label=percent(perc, 0.1)),size = 3, position=position_dodge(width=0.9), vjust=-0.25) + #etiketter
    labs(
        x = "Resmål",
        y = "Antal svar",
        title = "Antal utpendlingsresor"
    )

utpendling_barplot
```

# Bilagor

## Karta

Här följer en karta över det undersökta området.
<Denna är ej inlagd i dokumentet ännu, men kod finns>

## Detaljerade tabeller

Nedan följer tabeller som aver ge en mer detaljerad bild av resvaneundersökningen.

```{r sys-omrade-table, echo = FALSE, results = "asis"}
kable(sys_omrade_abs, caption = "Antal resor per resärende och område, redovisat uppräknat på antalet invånare.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(nrow(sys_omrade_abs), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T, angle = 45) %>% #gör rubrikraden fetstilt
  column_spec(1, width = "2cm")

```

```{r sys-omrade-percent-table, echo = FALSE, results = "asis"}
kable(sys_omrade_percent, caption = "Resärende per område, redovisat i andelar uttryckt i procent per område.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(nrow(sys_omrade_percent), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T, angle = 45) %>% #gör rubrikraden fetstilt
  column_spec(1,width = "2cm")
```


Tabell med körkort per område:

```{r drivers_license_area, echo=FALSE, include = FALSE}
drivers_license_area <- pers %>%
select(Omrade, Omrade_kod, h4) %>%
filter(!is.na(h4)) %>%
group_by(Omrade) %>%
summarize("Ja" = sum(h4 == 1, na.rm = TRUE),
"Nej" = sum(h4 == 2, na.rm = TRUE),
"Tillfrågade" = sum(h4 == 1 | h4 == 2, na.rm = TRUE),
"Omrade_kod" = first(Omrade_kod)) %>%
left_join(select(scb_befolkning, c(Omrade_kod,Befolkning)), by = c("Omrade_kod" = "Omrade_kod")) %>%
bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>%
mutate("Ja (radprocent)" = Ja/Tillfrågade,
"Nej (radprocent)" = Nej/Tillfrågade,
"Ja" = round(Ja/Tillfrågade*Befolkning),
"Nej" = round(Nej/Tillfrågade*Befolkning))%>%
rename("Totalt" = Befolkning) %>%
select(Omrade,"Ja","Nej","Totalt","Ja (radprocent)","Nej (radprocent)") %>%
mutate(across(c(5,6), ~percent(.x, accuracy = 1)))
```

```{r drivers-license-area-table, echo = FALSE, results = "asis"}
kable(drivers_license_area, caption = "Körkortsinnehav per område, redovisat uppräknat på antalet invånare samt i andelar uttryckt i procent.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(drivers_license_area), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

Tabeller med bildisposition per område:
```{r bildisposition, echo=FALSE, include = FALSE}
#joina avstånd till resor
svarsnyckel <- labels_data %>%
  filter(question_id=="H5") %>%
  select(answer_id,answer)

trip_sys_mode <- rvu %>%
  left_join(select(pers, c("respondentid","h5")), by = c("respondentid" = "respondentid")) %>% #Hämtar kolumn h5 från pers-data %>%
  select(Omrade, Omrade_kod, h5, fardmedel.kat) %>%
  filter(!is.na(fardmedel.kat)) %>%
  left_join(svarsnyckel, by = c("h5" = "answer_id")) %>%
  left_join(select(scb_befolkning, c(Omrade_kod,Befolkning)), by = c("Omrade_kod" = "Omrade_kod")) %>%
  group_by(Omrade,answer) %>%
  summarize(antal = n(),
"Befolkning" = first(Befolkning)) %>%
  spread(answer, antal, fill=0) %>%
  mutate(total = rowSums(across(where(is.numeric)))-Befolkning) %>%
  #Räknar ut radsummor
ungroup() %>%
  bind_rows(summarize(.,
across(where(is.numeric), sum),
across(where(is.character), ~ "Totalt"))) %>% #Skapar totalrad
  mutate(across(where(is.numeric) & !Befolkning, ~ . / total)) %>% #dividerar till procent av respondenter
  select(!total)

trip_sys_mode_percent <- trip_sys_mode %>%
  select(!Befolkning) %>%
  mutate(across(where(is.numeric), ~percent(.x, accuracy = 1)))

trip_sys_mode_abs <- trip_sys_mode %>%
  mutate(across(where(is.numeric) & !Befolkning, ~ round(. * Befolkning)),
Totalt = Befolkning) %>%
  select(!Befolkning)

```

```{r bildisposition-table, echo = FALSE, results = "asis"}
kable(trip_sys_mode_abs, caption = "Bildisposition per område, redovisat uppräknat på antalet invånare.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(nrow(trip_sys_mode_abs), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) %>% #gör rubrikraden fetstilt)
  column_spec(1, bold = T, width = "2cm") %>%
  column_spec(1, bold = T, width = "1.2cm")

```
```{r trip-sys-mode-percent-table, echo = FALSE, results = "asis"}
kable(trip_sys_mode_percent, caption = "Bilinnehav per område, redovisat i andelar uttryckt i procent.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(nrow(trip_sys_mode_percent), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T, angle = 45) %>% #gör rubrikraden fetstilt)
  column_spec(1, bold = T, width = "2cm")
```

Resenärsgrupp per huvudfärdmedel:
Ska sammanfogas till två tabeller

```{r mode-age-table, echo = FALSE, results = "asis"}
kbl(trip_age_abs, caption = "Färdmedel per åldersgrupp, redovisat uppräknat på antalet invånare.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_age_abs), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

```{r mode-gender-table, echo = FALSE, results = "asis"}
kbl(trip_mode_gender_abs, caption = "Färdmedel per kön, redovisat uppräknat på antalet invånare.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_mode_gender_abs), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

```{r mode-age-percent-table, echo = FALSE, results = "asis"}
kbl(trip_age_percent, caption = "Färdmedel per åldersgrupp, redovisat i andelar uttryckt i procent.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_age_percent), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

```{r mode-gender-percent-table, echo = FALSE, results = "asis"}
kbl(trip_mode_gender_percent, caption = "Färdmedel per kön, redovisat i andelar uttryckt i procent.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_mode_gender_percent), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

Område per huvudfärdmedel:

```{r trips-mode-table, echo = FALSE, results = "asis"}
kbl(trip_mode_abs, digits = 0, caption = "Färdmedelsandelar per tätort, redovisat uppräknat på antalet invånare.", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_mode_abs), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt
```

```{r trips-mode-percent-table, echo = FALSE, results = "asis"}
kbl(trip_mode_percent, caption = "Antal resor per färdmedel och område, redovisat i andelar uttryckt i procent.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
  row_spec(nrow(trip_mode_percent), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T) #gör rubrikraden fetstilt)
```

Ärende per färdmedel finns redovisat nedan.
<Bör även kolumnprocent redovisas?>

```{r trip_purpose_area, echo=FALSE, include = FALSE}
trip_purpose_all <- rvu %>%
  select(respondentid, b2) %>%
  filter(!is.na(b2)) %>%
  left_join(svarsnyckel_arende, by = c("b2" = "answer_id")) %>%
  left_join(pers %>%
              select(respondentid, Omrade, Omrade_kod),
            by = c("respondentid" = "respondentid")) %>%
  mutate(value = 1) %>%
  mutate(index = 1:nrow(rvu%>%filter(!is.na(b2)))) %>%
  spread(answer, value, fill=0) 

trip_purpose_area <- trip_purpose_all %>%
  filter(!is.na(b2)) %>%
  group_by(Omrade) %>%
  select(-index, -b2, -respondentid) %>%
  summarize(.,
            across(where(is.numeric), sum),
            Totalt = n(),
            Omrade_kod = first(Omrade_kod)) %>%
  left_join(select(scb_befolkning, c(Omrade_kod,Befolkning)), by = c("Omrade_kod" = "Omrade_kod")) %>% #Lägger till befolkning per zon
  select(-Omrade_kod) %>%
  ungroup() %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt"))) #Skapar totalrad

#Räknar ut antal resor i andelar av antal tillfrågade per område
trip_purpose_area_andel <- trip_purpose_area %>%
  mutate(across(where(is.numeric) & !Befolkning, ~ . / Totalt)) %>% #Räknar ut radsummor
  select(-Totalt)

trip_purpose_area_percent <- trip_purpose_area_andel %>%
  select(!Befolkning) %>%
  mutate(across(where(is.numeric), ~percent(.x, accuracy = 1)))

trip_purpose_area_abs <- trip_purpose_area_andel %>%
  mutate(across(where(is.numeric) & !Befolkning, ~ round(. * Befolkning)),
Totalt = Befolkning) %>%
  select(!Befolkning)

```

```{r trip-purpose-area-table, echo = FALSE, results = "asis"}
kable(trip_purpose_area_abs, caption = "Antal resor per resärende och område, redovisat uppräknat på antalet invånare.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(nrow(trip_purpose_area_abs), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T, angle = 45) %>% #gör rubrikraden fetstilt
  column_spec(1, width = "2cm")

```

```{r trip-purpose-area-percent-table, echo = FALSE, results = "asis"}
kable(trip_purpose_area_percent, caption = "Resärende per område, redovisat i andelar uttryckt i procent per område.", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"),
                full_width = TRUE) %>%
  row_spec(nrow(trip_purpose_area_percent), bold = T) %>% #gör Total-raden fetstilt
  row_spec(0, bold = T, angle = 45) %>% #gör rubrikraden fetstilt
  column_spec(1,width = "2cm")
```

```{r distance_mode, echo=FALSE, include=FALSE}
# #Kod till tabell med antal resor per reslängdsklass
# rvu_distance_below_1 <- rvu %>% 
#   select(avstand, fardmedel) %>%
#   filter(!is.na(fardmedel)) %>%
#   group_by(avstand = cut(avstand, breaks = c(0, 1000))) %>%
#   summarize("Alla färdsätt" = n(),
#             "Bil" = sum(fardmedel == 2),
#             "Buss" = sum(fardmedel == 1),
#             "Cykel" = sum(fardmedel == 4),
#             "Gång" = sum(fardmedel == 5))
#   
# rvu_distance_below_3 <- rvu %>% 
#   select(avstand, fardmedel) %>%
#   filter(!is.na(fardmedel)) %>%
#   group_by(avstand = cut(avstand, breaks = c(0, 3000))) %>%
#   summarize("Alla färdsätt" = n(),
#             "Bil" = sum(fardmedel == 2),
#             "Buss" = sum(fardmedel == 1),
#             "Cykel" = sum(fardmedel == 4),
#             "Gång" = sum(fardmedel == 5))
# 
# rvu_distance_below_5 <- rvu %>% 
#   select(avstand, fardmedel) %>%
#   filter(!is.na(fardmedel)) %>%
#   group_by(avstand = cut(avstand, breaks = c(0, 5000))) %>%
#   summarize("Alla färdsätt" = n(),
#             "Bil" = sum(fardmedel == 2),
#             "Buss" = sum(fardmedel == 1),
#             "Cykel" = sum(fardmedel == 4),
#             "Gång" = sum(fardmedel == 5))
#   
# rvu_distance_below_10 <- rvu %>% 
#   select(avstand, fardmedel) %>%
#   filter(!is.na(fardmedel)) %>%
#   group_by(avstand = cut(avstand, breaks = c(0, 10000))) %>%
#   summarize("Alla färdsätt" = n(),
#             "Bil" = sum(fardmedel == 2),
#             "Buss" = sum(fardmedel == 1),
#             "Cykel" = sum(fardmedel == 4),
#             "Gång" = sum(fardmedel == 5))
#   
# 
# rvu_distance <- bind_rows(slice(rvu_distance_below_1, 1), 
#                           slice(rvu_distance_below_3, 1),
#                           slice(rvu_distance_below_5, 1),
#                           slice(rvu_distance_below_10, 1))
# rvu_distance$avstand <- c("<=1km", "<=3km", "<=5km", "<=10km") 
# rvu_distance <- rvu_distance %>% rename("Reslängd" = avstand)

              
```

```{r distance-mode-table, echo = FALSE, results = "asis"}
# #Tabell med antal resor per reslängdsklass
# kable(rvu_distance, caption = "Reslängd per färdsätt", booktabs = T, linesep = "",format.args = list( big.mark = " ")) %>%
#   kable_styling(latex_options = c("striped", "HOLD_position")) %>%
#   row_spec(0, bold = T) #gör rubrikraden fetstilt
```