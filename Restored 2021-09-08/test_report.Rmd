---
title: "test_rvu_v1.1"
author: "WSP"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output:
  bookdown::pdf_document2: default
header-includes:
  - \renewcommand{\figurename}{Figur }
  - \makeatletter
  - \def\fnum@figure{\figurename\thefigure}
  - \makeatother
  - \renewcommand{\tablename}{Tabell }
  - \makeatletter
  - \def\tnum@table{\tablename\thetable}
  - \makeatother
---

# Resvaneundersökning Bålsta

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(ggplot2)
library(tidyverse)
library(readxl)
library(bookdown)
```

```{r plot-theme-creation, include = FALSE}
rvu_theme <- function() {
    theme(
        plot.title = element_text(colour = "steelblue", face = "bold"),
        plot.background = element_rect(fill = "white"),
        # add border 1)
        panel.border = element_rect(colour = "blue", fill = NA, linetype = 1),
        # color background 2)
        panel.background = element_rect(fill = "aliceblue"),
        # modify grid 3)
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y =  element_line(colour = "steelblue", linetype = 3, size = 0.5),
        panel.grid.minor.y = element_blank(),
        # modify text, axis and colour 4) and 5)
        axis.title.y = element_text(colour = "steelblue"),
        axis.title.x = element_text(colour = "steelblue"),
        axis.line.x = element_blank(),
        axis.text.y = element_text(colour = "steelblue", face = "italic"),
        axis.text.x = element_blank(),
        axis.ticks.y = element_line(colour = "steelblue"),
        axis.ticks.x = element_blank(),
        # legend at the bottom 6)
        legend.position = "right",
        legend.title = element_blank(),
        legend.background = element_rect(colour = "steelblue", fill = "aliceblue")
    )
}

```

```{r read_data, echo=FALSE, include = FALSE}

rvu <- read_delim("habo_rvu.csv", ";", escape_double = FALSE, 
                    locale = locale(encoding = "ISO-8859-1"), 
                    trim_ws = TRUE) %>%
    mutate(
        avstand = as.numeric(str_replace(avstand, ",", "."))
    )

pers <- read_delim("habo_person.csv", ";", escape_double = FALSE, 
                     locale = locale(encoding = "ISO-8859-1"), 
                     trim_ws = TRUE)

#Definierar om respondenter ska delas upp på kommun, tätort eller deso-nivå:
#pers <- mutate(pers,Område = bostad_kommun_namn)
#pers <- mutate(pers,Område = bostad_tatort_namn)
pers <- mutate(pers,Område = bostad_deso)

respondent2område <- pers %>%
  select(respondentid, Område)

#lägger till områdeskolumn i rvu-data
rvu <- rvu %>%
  left_join(respondent2område, by = c("respondentid" = "respondentid"))

#Lookup-table för att hämta klartext
variable_data <- read_excel("Variable information + Variable Values 2021-05-28.xlsx",
                            sheet = "Variable Labels", skip = 1, col_names = TRUE)
labels_data <- read_excel("Variable information + Variable Values 2021-05-28.xlsx",
                          sheet = "Value Labels", skip = 1, col_names = TRUE)


labels_data <- labels_data %>%
  rename(answer_id=...2,answer=Label,question_id=Value) %>%
  mutate(answer_id = as.numeric(str_remove(str_replace(answer_id, ",", "."),"a"))) %>% #Obs finns NA-observationer
  mutate(question_num=cumsum(!is.na(question_id)))

#Skapar nyckel mellan fråge-id och frågenummer
nyckel <- labels_data %>%
  select(question_id, question_num) %>%
  filter(!is.na(question_id))

#Skapar koppling mellan fråge-ID, svars-ID och svaret
labels_data <- labels_data %>%
  select(answer_id,answer, question_num) %>%
  left_join(nyckel, by = "question_num") %>%
  select(question_id,answer_id,answer)


```

## Sammanfattning

### Antal resor

```{r respondant_details, echo=FALSE, include = FALSE}
pers_group <- pers %>%
  select(Område, kon, alder) %>%
  group_by(Område) %>%
  summarize(Respondenter = n(),
            Man = sum(kon == "Man"), 
            Kvinnor = sum(kon == "Kvinna"),
            "12-24 år" = sum(alder >= 12 & alder < 25),
            "25-64 år" = sum(alder >= 25 & alder < 65),
            "65-84 år" = sum(alder >= 65 & alder <= 84)) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt")))

```


```{r repondant-table, echo = FALSE, results = "asis"}
kable(pers_group, caption = "Antal svar per kön och åldersgrupp")

```



### Färdmedelsföredlning

### Trafikarbete

### Fördelning mellan män och kvinnor

### Fördelning mellan ålderskategorier

### Vanligaste målpunkterna

## Inledning

### Metod

Hur dokumentet är skapat och generellt om kollbar

### Population och urval

Sammanfattning av SCB:s populationsdata, antal respondenter osv Tabell med antal boende och antal respondenter

## Resultat

### Körkort och biltillgång


```{r korkort, echo=FALSE, include=FALSE}
drivers_license <- pers %>%
  select(Område, h4, h5) %>%
  group_by(Område) %>%
  summarize(Körkort = sum(na.omit(h4) == 1),
            Biltillgång = sum(h5 == 1) + sum(h5 == 2) + sum(h5 == 3) + sum(h5 == 4)) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Totalt")))

```

Tabell med körkort och bilinnehav

```{r korkort-table, echo = FALSE, results = "asis"}
kable(drivers_license, caption = "Antal respondenter med körkort och biltillgång")

```

### Antal resor

```{r antal_resor, echo=FALSE, include=FALSE}

num_trips_per_pers <- rvu %>%
  select(respondentid) %>%
  group_by(respondentid) %>%
  summarize(num_trips = n())


num_trips_gender <- pers %>%
  select(respondentid, kon) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  group_by(kon) %>%
  summarize("Andel personer som rest" = sum(!is.na(num_trips)) / n(),
            "Resor per dag för alla personer" = sum(num_trips, na.rm = TRUE) / n(),
            "Resor per dag för personer som rest" = mean(num_trips, na.rm = TRUE)) %>%
  rename('Kön' = kon)

num_trips_age <- pers %>%
  select(respondentid, alder) %>%
  left_join(num_trips_per_pers, by = c("respondentid" = "respondentid")) %>%
  group_by(alder = cut(alder, breaks = c(12, 24, 64, 84)))%>%
  summarize("Andel personer som rest" = sum(!is.na(num_trips)) / n(),
            "Resor per dag för alla personer" = sum(num_trips, na.rm = TRUE) / n(),
            "Resor per dag för personer som rest" = mean(num_trips, na.rm = TRUE)) %>%
  rename('Ålder' = alder)

```

Tabell med andel personer som rest och deras antal resor per dag redovisat per kön och ålderskategori

```{r num-trips-gender-table, echo = FALSE, results = "asis"}
kable(num_trips_gender, digits = 2, caption = "Antal resor per dag per kön")

```

```{r num-trips-age-table, echo = FALSE, results = "asis"}
kable(num_trips_age, digits = 2, caption = "Antal resor per dag per åldersgrupp")

```


### Resornas fördelning på färdsätt

```{r trips_person_mode, echo=FALSE, include=FALSE}

mode_per_pers <- rvu %>%
  select(respondentid, fardmedel.kat) %>%
  group_by(respondentid) %>%
  summarize(Bil = any(fardmedel.kat == "Bil", na.rm = TRUE),
            Tåg = any(fardmedel.kat == "Kollektiv_tåg", na.rm = TRUE),
            Buss = any(fardmedel.kat == "Kollektiv_buss", na.rm = TRUE),
            Cykel = any(fardmedel.kat == "Cykel", na.rm = TRUE),
            Gång = any(fardmedel.kat == "Gång", na.rm = TRUE),
            Övrigt = any(fardmedel.kat == "Annat" | fardmedel.kat == 7, na.rm = TRUE),
            made_trip = !is.na(fardmedel.kat))


trip_person_mode <- pers %>%
  select(respondentid, Område)%>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(Område), made_trip) %>%
  group_by(Område) %>%
   summarize("Bil" = mean(Bil),
             "Tåg" = mean(Tåg),
             "Buss" = mean(Buss),
             "Cykel" = mean(Cykel),
             "Gång" = mean(Gång))
```

Tabell/diagram med färdmedelsandelar per område


```{r trips-person-mode-table, echo = FALSE, results = "asis"}
kable(trip_person_mode, digits = 2, caption = "Resor per dag")
```

```{r trips_mode, echo=FALSE, include=FALSE}

trip_mode <- pers %>%
  select(respondentid, Område)%>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(Område)) %>%
  group_by(Område) %>%
  summarize("Bil" = sum(Bil),
             "Tåg" = sum(Tåg),
             "Buss" = sum(Buss),
             "Cykel" = sum(Cykel),
             "Gång" = sum(Gång),
             "Övrigt" = sum(Övrigt)) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~ "Total")))


```

```{r trips-mode-table, echo = FALSE, results = "asis"}
kable(trip_mode, caption = "Färdmedel per tätort")
```

### Bakgrundfrågor

#### Färdsätt efter kön

```{r trips_gender, echo=FALSE, include=FALSE}

trip_mode_gender <- pers %>%
  select(respondentid, kon)%>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
   group_by(kon) %>%
   summarize("Bil" = sum(Bil, na.rm = TRUE),
             "Tåg" = sum(Tåg, na.rm = TRUE),
             "Buss" = sum(Buss, na.rm = TRUE),
             "Cykel" = sum(Cykel, na.rm = TRUE),
             "Gång" = sum(Gång, na.rm = TRUE),
             "Övrigt" = sum(Övrigt, na.rm = TRUE)) %>%
  bind_rows(summarize(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total"))) %>%
  rename('Kön' = kon)

```

Tabell/diagram med färdsätt efter kön.

```{r mode-gender-table, echo = FALSE, results = "asis"}
kable(trip_mode_gender, caption = "Färdmedel per kön")
```

#### Färdsätt efter ålder

```{r trips_age, echo=FALSE, include=FALSE}

trip_age <- pers %>%
  select(respondentid, alder)%>%
  left_join(mode_per_pers, by = c("respondentid" = "respondentid")) %>%
  filter(!is.na(alder)) %>%
  group_by(alder = cut(alder, breaks = c(12, 17, 24, 39, 64, 74, 84))) %>%
  summarize("Bil" = sum(Bil, na.rm = TRUE),
             "Tåg" = sum(Tåg, na.rm = TRUE),
             "Buss" = sum(Buss, na.rm = TRUE),
             "Cykel" = sum(Cykel, na.rm = TRUE),
             "Gång" = sum(Gång, na.rm = TRUE),
             "Övrigt" = sum(Övrigt, na.rm = TRUE))%>%
  rename('Ålder' = alder)

```

Tabell/diagram med färdsätt efter ålder, 12-17 år, 18-24 år, 25-39 år, 40-64 år, 65-74 år, 75-84 år

```{r mode-age-table, echo = FALSE, results = "asis"}
kable(trip_age, caption = "Färdmedel per åldersgrupp")
```


#### Färdsätt efter sysselsättning

Tabell/diagram med färdsätt efter sysselsättning

#### Färdsätt efter ärende

Tabell/diagram med färdsätt efter ärende

### Reslängd och trafikarbete
```{r travel_dist, echo=FALSE, include = FALSE}

#Filtrerar data och lägger till områdeskolumn
reslangd <- rvu %>%
  filter(!is.na(avstand)) %>%
  rename(Färdmedel = fardmedel.kat) %>%
  select(respondentid,Färdmedel,avstand) %>%
  left_join(respondent2område, by = c("respondentid" = "respondentid"))

#Räknar ut totalt
reslangd_summa_tot <- reslangd %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal observationer" = n()) %>%
  cbind(Färdmedel = "Totalt")

#Räknar ut totalt per färdmedel
reslangd_summa <- reslangd %>%
  group_by(Färdmedel) %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal observationer" = n()) %>%
  rbind(reslangd_summa_tot)

#Räknar ut totalt per färdmedel och område
reslangd_per_område <- reslangd %>%
  group_by(Område,Färdmedel) %>%
  summarise("Median" = round(median(avstand),0), "Medel" = round(mean(avstand),1), "Antal observationer" = n()) %>%
  rbind(reslangd_summa)

#Exempel som ska kunna slå ihop celler... Vi bör nog använda kableExtra för att göra snyggare grafer...
#dt <- mtcars[1:10, 1:6]
#kable(dt, format = "latex", caption = "Group Rows", booktabs = T) %>%
#    kable_styling() %>%
#    group_rows("Group 1", 4, 7) %>%
#    group_rows("Group 2", 8, 10)

#kbl(reslangd_per_område, align = "c") %>%
#  kable_paper(full_width = F) %>%
#  column_spec(1, bold = T) %>%
#  collapse_rows(columns = 1:1)

collapse_rows_dt <- data.frame(C1 = c(rep("a", 10), rep("b", 5)),
                 C2 = c(rep("c", 7), rep("d", 3), rep("c", 2), rep("d", 3)),
                 C3 = 1:15,
                 C4 = sample(c(0,1), 15, replace = TRUE))
kbl(collapse_rows_dt, align = "c") %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:2, valign = "top")

x <- knitr::kable(head(mtcars), "html")
# Put Row 2 to Row 5 into a Group and label it as "Group A"
pack_rows(x, "Group A", 2, 5)
```

Tabell med reslängd per område

```{r travel_dist-table1, echo = FALSE, results = "asis"}
kable(reslangd_per_område, caption = "Reslängd per område")
```

#### Resor med start och mål innanför kommungränsen

Tabell med genomsnittlig reslängd och uppräknat antalresor och trafikarbete för varje delområde totalt per område och färdmedel

Tabell/diagram med antal resor per färdmedel efter färmedelslängd Graf med färdmedelsandelar över x = antal kilometer.

#### Resor med start eller mål utanför kommungränsen

Liten OD-matris med vilka andra områden (tätorter, kommuner eller län, beroende på vilken nivå RVU:n tas fram för.) som respondenterna reser till. I antal procent av totala antalet resor.

# Kartor och bilagor

Här följer en karta och mer detaljerade tabeller.

## Ärendeanalys

```{r purpose_analysis, echo=FALSE, include = FALSE}
purposes <- labels_data %>%
  filter(question_id=="B2_R1") %>%
  select(answer_id,answer)

rvu_purp <- rvu %>%
    select(resa_nr, respondentid, b2) %>%
    left_join(purposes, by = c("b2" = "answer_id")) %>%
    group_by(answer) %>%
    summarise(antal = n())

top_purpose <- rvu_purp %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==1)
top_purpose_2 <- rvu_purp %>% filter(!is.na(answer)) %>% arrange(desc(antal)) %>% filter(row_number()==2)

top_purpose <- top_purpose$answer
top_purpose_2 <- top_purpose_2$answer

rvu_purp_rep <- rvu_purp %>%
    rename(
        'Ärende' = answer,
        'Antal svar' = antal
    )

```

I Tabell \@ref(tab:purpose-table) och Figur \@ref(fig:purpose-diagram) beskrivs vilka ärenden som respondenterna har svarat att de uppfylde med sina resor. Huvudärendet är `r tolower(top_purpose)` och andra mest populärt ärende är `r tolower(top_purpose_2)`.

```{r purpose-table, echo = FALSE, results = "asis"}
kable(rvu_purp_rep, caption = "Antal resor per ärende")

```

```{r purpose-diagram, echo = FALSE, results = "asis", fig.cap = "Antal resor per ärende."}
purp_barplot <- ggplot(rvu_purp, aes(answer, antal, fill = answer)) + 
    geom_bar(stat = "identity") +
    rvu_theme() +
    coord_cartesian(xlim = c(0,15)) +
    scale_fill_brewer(palette = "Set3") + 
    labs(
        x = "Ärende",
        y = "Antal svar",
        title = "Antal resor per ärende"
    )
    

purp_barplot

```

```{r delete_purpose_workspace, echo = FALSE, include = FALSE}
rm(purposes, rvu_purp,rvu_purp_rep)
```
